<!DOCTYPE html>
<html lang="de">

<head>
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.15.4/css/all.css" integrity="sha384-..."
        crossorigin="anonymous">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/inputs.css">
    <link rel="stylesheet" href="css/buttons.css">
    <link rel="stylesheet" href="css/module-components.css">
    <link rel="stylesheet" href="css/code-output.css">
    <link rel="stylesheet" href="css/modal-tabs.css">
    <link rel="stylesheet" href="css/notifications.css">
    <link rel="stylesheet" href="css/module-specific-styles.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/hero-modul.css">
    <link rel="stylesheet" href="css/responsive-mobile.css">
    <link rel="stylesheet" href="css/utility-class.css">
    <link rel="stylesheet" href="css/print-styles.css">
    <script src="import/squarespace-analyzer.js"></script>
    <script src="import/kerberos-reimport.js"></script>
    <script src="ui/settings-manager.js"></script>
    <script src="ui/library-manager.js"></script>
    <script src="ui/module-edit-manager.js"></script>
    <script src="ui/export-preview-manager.js"></script>
    <script src="core/event-bus.js"></script>
    <script src="utils/notification.js"></script>
    <script src="utils/type-mappings.js"></script>
    <script src="js/module-processor-universal.js"></script>
    <script src="js/module-processor-type-resolver.js"></script>
    <script src="core/template-manager.js"></script>
    <script src="js/module-processors - vereinfacht.js"></script>
    <script src="js/renderers.js"></script>
    <script src="js/helpers.js"></script>
    <script src="js/canvas.js"></script>
    <script src="js/guide-flow-interactivity.js"></script>
    <script src="js/templates.js"></script>
    <script src="js/icons.js"></script>
    <script src="js/bulk-batch.js"></script>
    <script src="js/modal-system.js"></script>
    <script src="js/page-management.js"></script>
    <script src="js/import-export.js"></script>
    <script src="js/file-sync.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerberos Module Editor - Erweiterte Version</title>
    <style>



    </style>
</head>

<body>
    <header class="editor-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1 style="font-size: 1.5rem;">🛡️ Kerberos Module Editor</h1>
                <p style="font-size: 0.9rem; opacity: 0.9; margin: 0;">Erweiterte Version • www.kerberos-compliance.com
                </p>
            </div>
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                <button class="btn btn-success" id="exportPageBtn">📄 Seite exportieren</button>
                <button class="btn btn-primary" id="savePageBtn">💾 Seite speichern</button>
                <button class="btn btn-secondary" id="loadPageBtn">📂 Seite laden</button>
                <button class="btn btn-warning" id="importBtn">📥 Import</button>
                <button class="btn btn-success" id="exportAllModulesBtn">📦 Alle Module exportieren</button>
                <button class="btn btn-secondary" id="settingsBtn">⚙️ Einstellungen</button>
                <button class="btn btn-warning" id="clearBtn">🗑️ Leeren</button>
                <button class="btn btn-primary" onclick="showSquarespaceImporter()" style="background: #28a745;">🔄 Squarespace Import</button>
                <button class="btn btn-secondary" id="previewBtn">👁️ Vorschau</button>
            </div>
        </div>
    </header>

    <!-- Lokale Datei-Synchronisation UI -->
    <!-- Fügen Sie diesen Code in die Toolbar/Header-Sektion ein -->

    <!-- DEBUG TOOLBAR - Module-Reset -->
    <div class="debug-toolbar"
        style="display: flex; gap: 0.5rem; margin: 0.5rem 0; padding: 0.5rem; background: #ffe6e6; border: 1px solid #ffcccc; border-radius: 4px;">
        <button onclick="forceResetModuleSelection()" class="btn btn-warning btn-sm">🔧 Module-Reset</button>
        <button onclick="console.log('Selected:', selectedModule); console.log('Modules:', modules.length);"
            class="btn btn-info btn-sm">🔍 Debug Info</button>
    </div>

    <div class="sync-toolbar"
        style="display: flex; gap: 0.5rem; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6; align-items: center;">
        <button class="btn btn-primary" onclick="saveToLocal()" title="Projekt-Datei herunterladen">
            💾 Speichern
        </button>
        <button class="btn btn-secondary" onclick="loadFromLocal()" title="Projekt-Datei laden">
            📁 Laden
        </button>
        <button class="btn btn-info" onclick="restoreBackup()" title="Automatisches Backup wiederherstellen">
            🔄 Backup
        </button>
        <button class="btn btn-success" onclick="showSharingHelp()" title="Anleitung für geteilte Ordner">
            🗂️ Teilen
        </button>

        <div class="sync-status" style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem;">
            <div style="font-size: 0.85rem; color: #666;">
                <span id="syncStatusText">Lokale Synchronisation</span>
            </div>
            <div class="sync-indicator" id="syncIndicator"
                style="width: 8px; height: 8px; border-radius: 50%; background: #28a745;"></div>
        </div>
    </div>

    <!-- Drag & Drop Overlay -->
    <div id="dragDropOverlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,123,255,0.1); z-index: 999; border: 3px dashed #007bff;">
        <div
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #007bff; font-size: 1.5rem; font-weight: bold;">
            📁 Projekt-Datei hier ablegen<br>
            <small style="font-size: 1rem; font-weight: normal;">website-manager-project.json</small>
        </div>
    </div>

    <!-- Quick Help Panel -->
    <div class="quick-help"
        style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 6px; padding: 0.75rem; margin: 0.5rem 0; font-size: 0.85rem;">
        <strong>💡 Schnell-Hilfe:</strong>
        <span style="color: #0c5460;">
            • <strong>Speichern:</strong> Lädt projekt.json herunter → in geteilten Ordner legen
            • <strong>Laden:</strong> Projekt-Datei auswählen
            • <strong>Drag & Drop:</strong> Datei ins Fenster ziehen für automatisches Update
        </span>
    </div>

    <script>
        // Erweiterte UI-Funktionalität
        let dragDropTimer = null;
        let isDragging = false;

        // Verbesserte Drag & Drop Visualisierung
        document.addEventListener('dragenter', (e) => {
            e.preventDefault();
            if (!isDragging) {
                isDragging = true;
                showDragOverlay();
            }
        });

        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            clearTimeout(dragDropTimer);
        });

        document.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dragDropTimer = setTimeout(() => {
                if (e.clientX === 0 && e.clientY === 0) {
                    hideDragOverlay();
                    isDragging = false;
                }
            }, 50);
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            hideDragOverlay();
            isDragging = false;

            const files = Array.from(e.dataTransfer.files);
            const jsonFile = files.find(file =>
                file.name.endsWith('.json') &&
                (file.name.includes('website-manager') || file.name.includes('project'))
            );

            if (jsonFile) {
                animateSyncIndicator('loading');
                // Datei wird vom LocalFileSync verarbeitet
            }
        });

        function showDragOverlay() {
            const overlay = document.getElementById('dragDropOverlay');
            if (overlay) {
                overlay.style.display = 'block';
                overlay.style.animation = 'fadeIn 0.2s ease';
            }
        }

        function hideDragOverlay() {
            const overlay = document.getElementById('dragDropOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function animateSyncIndicator(type) {
            const indicator = document.getElementById('syncIndicator');
            if (!indicator) return;

            switch (type) {
                case 'success':
                    indicator.style.background = '#28a745';
                    indicator.style.animation = 'pulse 0.5s ease';
                    break;
                case 'error':
                    indicator.style.background = '#dc3545';
                    indicator.style.animation = 'shake 0.5s ease';
                    break;
                case 'loading':
                    indicator.style.background = '#ffc107';
                    indicator.style.animation = 'spin 1s linear infinite';
                    break;
                default:
                    indicator.style.background = '#28a745';
                    indicator.style.animation = 'none';
            }

            setTimeout(() => {
                indicator.style.animation = 'none';
                indicator.style.background = '#28a745';
            }, 2000);
        }

        // Status-Updates überwachen
        const originalUpdateSyncStatus = window.localFileSync?.updateSyncStatus;
        if (originalUpdateSyncStatus) {
            window.localFileSync.updateSyncStatus = function (message) {
                originalUpdateSyncStatus.call(this, message);

                if (message.includes('gespeichert') || message.includes('geladen')) {
                    animateSyncIndicator('success');
                } else if (message.includes('Fehler')) {
                    animateSyncIndicator('error');
                }
            };
        }

        // Auto-Save Indikator
        setInterval(() => {
            const statusText = document.getElementById('syncStatusText');
            if (statusText && statusText.textContent === 'Automatisch gespeichert') {
                animateSyncIndicator('success');
            }
        }, 30000);

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 's':
                        e.preventDefault();
                        saveToLocal();
                        break;
                    case 'o':
                        e.preventDefault();
                        loadFromLocal();
                        break;
                }
            }
        });
    </script>

    <style>
        .sync-toolbar {
            animation: slideInDown 0.3s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sync-toolbar .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .sync-indicator {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.2);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-2px);
            }

            75% {
                transform: translateX(2px);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .quick-help {
            transition: all 0.3s ease;
        }

        .quick-help:hover {
            background: #d1ecf1;
            border-color: #9fcddb;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sync-toolbar {
                flex-direction: column;
                gap: 0.5rem;
            }

            .sync-toolbar .btn {
                width: 100%;
            }

            .sync-status {
                margin-left: 0 !important;
                justify-content: center;
            }
        }
    </style>

    <main class="editor-main">
        <!-- Module Bibliothek -->
        <div class="panel">
            <div class="panel-header">
                📚 Kerberos Module
            </div>
            <div class="panel-content">
                <input type="text" class="form-control" placeholder="🔍 Module suchen..." id="searchInput"
                    style="margin-bottom: 1rem;">
                <div id="moduleLibrary">
                    <!-- Module werden hier geladen -->
                </div>
            </div>
        </div>

        <!-- Landing Page Canvas -->
        <div class="panel">
            <div class="panel-header">
                🏗️ Seiten-Builder
                <input type="text" placeholder="Seitenname..." id="pageNameInput"
                    style="margin-left: 1rem; padding: 0.25rem 0.5rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.1); color: white; width: 180px; font-size: 0.85rem;">
            </div>
            <div class="panel-content" style="padding: 0;">
                <div class="canvas" id="canvas">
                    <div class="canvas-placeholder">
                        <div style="font-size: 2.5rem; margin-bottom: 1rem;">📱</div>
                        <h3 style="margin-bottom: 0.5rem;">Kerberos Seite erstellen</h3>
                        <p style="margin-bottom: 1rem;">Module hierher ziehen oder klicken</p>
                        <small style="color: #999;">Bereit für Squarespace Integration</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Code & Eigenschaften -->
        <div class="panel">
            <div class="panel-header">
                ⚙️ Eigenschaften & Code
            </div>
            <div class="panel-content">
                <div id="propertyPanel">
                    <p style="color: #6c757d; text-align: center; padding: 1.5rem;">
                        Modul auswählen zum Bearbeiten
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="iconModal" class="modal">
        <div class="modal-content">
            <h3>Icon auswählen</h3>
            <input type="text" class="form-control" placeholder="Icon suchen..." id="iconSearch"
                style="margin: 1rem 0;">
            <div class="icon-picker" id="iconPicker"></div>
            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-secondary" onclick="closeIconModal()">Abbrechen</button>
            </div>
        </div>
    </div>

    <div id="imageModal" class="modal">
        <div class="modal-content">
            <h3>Bild verwalten</h3>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('upload')">Upload</div>
                <div class="tab" onclick="switchTab('stock')">Stock Bilder</div>
                <div class="tab" onclick="switchTab('manage')">Verwalten</div>
            </div>

            <div id="uploadTab" class="tab-content active">
                <div class="image-upload" onclick="document.getElementById('imageInput').click()">
                    <div>📸 Bild hochladen</div>
                    <small>JPG, PNG, WebP bis 5MB</small>
                </div>
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
                <div id="uploadPreview"></div>
            </div>

            <div id="stockTab" class="tab-content">
                <div id="stockImages"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem;">
                    <!-- Stock Images -->
                </div>
            </div>

            <div id="manageTab" class="tab-content">
                <div id="uploadedImages">
                    <p>Ihre hochgeladenen Bilder erscheinen hier.</p>
                </div>
            </div>

            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-secondary" onclick="closeImageModal()">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Neue Modals -->
    <div id="savePageModal" class="modal">
        <div class="modal-content">
            <h3>Seite speichern</h3>
            <div class="form-group">
                <label class="form-label">Seitenname</label>
                <input type="text" class="form-control" id="savePageName" placeholder="Meine Kerberos Seite">
            </div>
            <div class="form-group">
                <label class="form-label">Beschreibung (optional)</label>
                <textarea class="form-control" id="savePageDescription"
                    placeholder="Beschreibung der Seite..."></textarea>
            </div>
            <div style="margin-top: 1rem; text-align: right; gap: 0.5rem; display: flex; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeSavePageModal()">Abbrechen</button>
                <button class="btn btn-success" onclick="saveCurrentPage()">💾 Speichern</button>
            </div>
        </div>
    </div>

    <div id="loadPageModal" class="modal">
        <div class="modal-content">
            <h3>Gespeicherte Seiten</h3>
            <div id="savedPagesList" style="max-height: 400px; overflow-y: auto;">
                <!-- Gespeicherte Seiten -->
            </div>
            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-secondary" onclick="closeLoadPageModal()">Schließen</button>
            </div>
        </div>
    </div>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <h3>Import / Export</h3>
            <div class="tabs">
                <div class="tab active" onclick="switchImportTab('import')">Import</div>
                <div class="tab" onclick="switchImportTab('export')">Export</div>
            </div>

            <div id="importImportTab" class="tab-content active">
                <div style="margin: 1rem 0;">
                    <div class="image-upload" onclick="document.getElementById('importInput').click()">
                        <div>📥 JSON-Datei importieren</div>
                        <small>Module oder komplette Seiten</small>
                    </div>
                    <input type="file" id="importInput" accept=".json" style="display: none;">
                </div>
                <div style="margin: 1rem 0;">
                    <label class="form-label">Oder JSON-Code einfügen:</label>
                    <textarea class="form-control" id="importTextarea" placeholder='{"modules": [...]}'
                        style="min-height: 200px; font-family: monospace;"></textarea>
                </div>
                <button class="btn btn-primary" onclick="importData()" style="width: 100%;">Importieren</button>
            </div>

            <div id="importExportTab" class="tab-content">
                <div style="margin: 1rem 0;">
                    <button class="btn btn-success" onclick="exportCurrentPage()"
                        style="width: 100%; margin-bottom: 0.5rem;">📄 Aktuelle Seite exportieren</button>
                    <button class="btn btn-secondary" onclick="exportModuleTemplates()"
                        style="width: 100%; margin-bottom: 0.5rem;">📦 Alle Module exportieren</button>
                    <button class="btn btn-warning" onclick="exportSelectedModule()" style="width: 100%;"
                        id="exportSelectedBtn" disabled>🔧 Ausgewähltes Modul exportieren</button>
                </div>
            </div>

            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-secondary" onclick="closeImportModal()">Schließen</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3>Einstellungen</h3>
            <div class="tabs">
                <div class="tab active" onclick="switchSettingsTab('spacing')">Abstände</div>
                <div class="tab" onclick="switchSettingsTab('modules')">Module verwalten</div>
            </div>

            <div id="settingsSpacingTab" class="tab-content active">
                <h4>Globale Abstände</h4>
                <div class="form-group">
                    <label class="form-label">Section Padding</label>
                    <select class="form-control" id="sectionPaddingSelect"
                        oninput="updateSpacing('sectionPadding', this.value)">
                        <option value="4rem 0">Klein (4rem 0)</option>
                        <option value="6rem 0" selected>Standard (6rem 0)</option>
                        <option value="8rem 0">Groß (8rem 0)</option>
                        <option value="10rem 0">Extra Groß (10rem 0)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Element-Abstände</label>
                    <select class="form-control" id="elementSpacingSelect"
                        oninput="updateSpacing('elementSpacing', this.value)">
                        <option value="1rem">Klein (1rem)</option>
                        <option value="2rem" selected>Standard (2rem)</option>
                        <option value="3rem">Groß (3rem)</option>
                        <option value="4rem">Extra Groß (4rem)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Text-Abstände</label>
                    <select class="form-control" id="textSpacingSelect"
                        oninput="updateSpacing('textSpacing', this.value)">
                        <option value="0.5rem">Klein (0.5rem)</option>
                        <option value="1rem" selected>Standard (1rem)</option>
                        <option value="1.5rem">Groß (1.5rem)</option>
                        <option value="2rem">Extra Groß (2rem)</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="applySpacingToAll()" style="width: 100%;">Auf alle Module
                    anwenden</button>
            </div>

            <div id="settingsModulesTab" class="tab-content">
                <h4>Module verwalten</h4>
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="showCreateModuleDialog()"
                            style="flex: 1; min-width: 200px;">+ Neues Modul erstellen</button>
                        <button class="btn btn-warning" onclick="showModuleLibraryManager()"
                            style="flex: 1; min-width: 200px;">📚 Bibliothek verwalten</button>
                        <button class="btn btn-danger" onclick="resetLocalStorage()"
                            style="flex: 1; min-width: 200px;">🗑️ LocalStorage zurücksetzen</button>
                    </div>
                </div>
                <div id="customModulesList">
                    <!-- Custom modules -->
                </div>
            </div>

            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-secondary" onclick="closeSettingsModal()">Schließen</button>
            </div>
        </div>
    </div>

    <div id="moduleEditModal" class="modal">
        <div class="modal-content">
            <h3>Modul-Informationen bearbeiten</h3>
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" id="editModuleName">
            </div>
            <div class="form-group">
                <label class="form-label">Kategorie</label>
                <select class="form-control" id="editModuleCategory">
                    <option value="Hero & Header">Hero & Header</option>
                    <option value="Content & Services">Content & Services</option>
                    <option value="Team & About">Team & About</option>
                    <option value="Contact & CTA">Contact & CTA</option>
                    <option value="Statistics & Numbers">Statistics & Numbers</option>
                    <option value="Content & Images">Content & Images</option>
                    <option value="Process & Steps">Process & Steps</option>
                    <option value="Custom">Custom</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Beschreibung</label>
                <textarea class="form-control" id="editModuleDescription" style="min-height: 80px;"></textarea>
            </div>
            <div style="margin-top: 1rem; text-align: right; gap: 0.5rem; display: flex; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModuleEditModal()">Abbrechen</button>
                <button class="btn btn-success" onclick="saveModuleInfo()">💾 Speichern</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000;">
        <div
            style="background: white; margin: 1rem; border-radius: 8px; height: calc(100vh - 2rem); display: flex; flex-direction: column;">
            <div
                style="padding: 1rem; border-bottom: 1px solid var(--kerberos-border); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">👁️ Kerberos Seiten-Vorschau</h3>
                <button class="btn btn-secondary" onclick="closePreview()">❌ Schließen</button>
            </div>
            <div style="flex: 1; overflow: auto;">
                <div id="previewContent"></div>
            </div>
        </div>
    </div>

    <div id="moduleLibraryModal" class="modal">
        <div class="modal-content">
            <h3>📚 Module-Bibliothek verwalten</h3>
            <div style="margin-bottom: 1rem;">
                <input type="text" class="form-control" placeholder="🔍 Module suchen..." id="librarySearchInput"
                    style="margin-bottom: 1rem;">
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <button class="library-filter-btn" data-category="all"
                        style="padding: 0.5rem 1rem; border: 2px solid var(--kerberos-primary); background: var(--kerberos-primary); color: white; border-radius: 20px; cursor: pointer; font-size: 0.85rem;">Alle</button>
                    <button class="library-filter-btn" data-category="Hero & Header"
                        style="padding: 0.5rem 1rem; border: 2px solid var(--kerberos-primary); background: transparent; color: var(--kerberos-primary); border-radius: 20px; cursor: pointer; font-size: 0.85rem;">Hero
                        & Header</button>
                    <button class="library-filter-btn" data-category="Content & Services"
                        style="padding: 0.5rem 1rem; border: 2px solid var(--kerberos-primary); background: transparent; color: var(--kerberos-primary); border-radius: 20px; cursor: pointer; font-size: 0.85rem;">Content
                        & Services</button>
                    <button class="library-filter-btn" data-category="Custom"
                        style="padding: 0.5rem 1rem; border: 2px solid var(--kerberos-primary); background: transparent; color: var(--kerberos-primary); border-radius: 20px; cursor: pointer; font-size: 0.85rem;">Custom</button>
                </div>
            </div>
            <div id="moduleLibraryList"
                style="max-height: 400px; overflow-y: auto; border: 1px solid var(--kerberos-border); border-radius: 6px; padding: 1rem;">
                <!-- Module-Liste wird hier geladen -->
            </div>
            <div style="margin-top: 1rem; text-align: right; display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button class="btn btn-info" onclick="showDeletedTemplatesManager()" style="margin-right: 0.5rem;">🗑️
                    Gelöschte Templates</button>
                <button class="btn btn-warning" onclick="exportModuleLibrary()">📤 Bibliothek exportieren</button>
                <button class="btn btn-secondary" onclick="closeModuleLibraryModal()">Schließen</button>
            </div>
        </div>
    </div>

    <script>

        // Globale Variablen - FEHLENDE INITIALISIERUNG
        let websites = [];
        let customTemplates = {};
        // Globale Variablen
        if (!window.modules) window.modules = [];
        let modules = window.modules; // Zeiger auf dasselbe Array-Objekt
        let selectedModule = null;
        let moduleCounter = 0;
        let currentProperty = '';
        let uploadedImages = {};

        let globalSpacing = {
            sectionPadding: '6rem 0',
            elementSpacing: '2rem',
            textSpacing: '1rem'
        };

        // Modulcounter-Schutz vor Kollisionen
        if (typeof moduleCounter === 'undefined') {
            window.moduleCounter = Math.max(...modules.map(m => {
                const match = m.id.match(/module_(\d+)/);
                return match ? parseInt(match[1]) : 0;
            }), 0);
        }

        // Kerberos Farben
        const KERBEROS_COLORS = {
            primary: '#063AA8',
            secondary: '#009CE6',
            accent: '#B265E9',
            orange: '#EF8646',
            dark: '#212529',
            gray: '#ADB5BD',
            white: '#FFFFFF'
        };

        // Stock Images (Placeholder URLs - in Produktion echte URLs verwenden)
        const STOCK_IMAGES = [
            'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=500&h=350&fit=crop',
            'https://images.unsplash.com/photo-1551434678-e076c223a692?w=500&h=350&fit=crop',
            'https://images.unsplash.com/photo-1552664730-d307ca884978?w=500&h=350&fit=crop',
            'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=500&h=350&fit=crop',
            'https://images.unsplash.com/photo-1573164713714-d95e436ab8d6?w=500&h=350&fit=crop',
            'https://images.unsplash.com/photo-1556157382-97eda2d62296?w=500&h=350&fit=crop',
            'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?w=500&h=350&fit=crop',
            'https://images.unsplash.com/photo-1486312338219-ce68e2c6b525?w=500&h=350&fit=crop'
        ];

        // Erweiterte Module Templates - Vollständig vereinheitlicht für Editor-Kompatibilität

        // === NEUE PROZESSORFUNKTIONEN ===

        // Notfall-Reset für Module-Auswahl
        function forceResetModuleSelection() {
            document.querySelectorAll('.canvas-module').forEach(el => {
                el.classList.remove('selected');
                el.style.zIndex = '';
                el.style.position = '';
                el.style.pointerEvents = 'auto';
            });
            selectedModule = null;
            renderPropertyPanel();
            showNotification('🔧 Module-Auswahl zurückgesetzt');
        }

        // Tastenkombination für Reset (Strg+R)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'r' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                forceResetModuleSelection();
            }
        });


        // Ultra-kompakte Desktop-Abstände
        function getDesktopSpacing(timelineValue) {
            const spacingMap = {
                '0.125rem': '0.05rem',  // Minimal: Ultra-kompakt (0.8px) - fast 0
                '0.25rem': '0.1rem',    // Sehr eng: Minimal (1.6px)
                '0.5rem': '0.2rem',     // Eng: Sehr kompakt (3.2px)
                '0.75rem': '0.4rem',    // Normal: Kompakt (6.4px)
                '1rem': '0.7rem',       // Weit: Normal (11.2px)
                '1.5rem': '1.2rem'      // Sehr weit: Großzügig (19.2px)
            };
            return spacingMap[timelineValue] || '0.2rem';
        }

        function getMobileSpacing(timelineValue) {
            const mobileMappingMap = {
                '0.125rem': '1.5rem',   // Minimal: Kompakt (24px)
                '0.25rem': '2rem',      // Sehr eng: Eng (32px)  
                '0.5rem': '2.5rem',     // Eng: Normal (40px)
                '0.75rem': '3rem',      // Normal: Weit (48px)
                '1rem': '3.5rem',       // Weit: Sehr weit (56px)
                '1.5rem': '4rem'        // Sehr weit: Perfect! (64px)
            };
            return mobileMappingMap[timelineValue] || '2.5rem';
        }


        // Globale Verfügbarkeit sicherstellen
        window.processKerberosStatsWithHover = processKerberosStatsWithHover;

        function applyStatsPresets(module) {
            const props = module.properties;

            // Layout-Presets
            switch (props.layoutStyle) {
                case 'compact':
                    props.statsGap = '1rem';
                    props.cardPadding = '1.5rem';
                    props.iconSpacing = '0.75rem';
                    break;
                case 'spacious':
                    props.statsGap = '3rem';
                    props.cardPadding = '3rem';
                    props.iconSpacing = '2rem';
                    break;
                default: // modern
                    props.statsGap = '2rem';
                    props.cardPadding = '2rem';
                    props.iconSpacing = '1rem';
            }

            // Card-Presets
            switch (props.cardStyle) {
                case 'flat':
                    props.cardShadow = 'none';
                    props.cardBorder = '1px solid #DEE2E6';
                    break;
                case 'bordered':
                    props.cardShadow = '0 2px 4px rgba(6,58,168,0.05)';
                    props.cardBorder = '2px solid #063AA8';
                    break;
                default: // elevated
                    props.cardShadow = '0 4px 12px rgba(6,58,168,0.08)';
                    props.cardBorder = '#E9ECEF';
            }

            // Icon-Presets
            switch (props.iconStyle) {
                case 'small':
                    props.iconSizeCustom = '2rem';
                    props.iconBackgroundSize = '60px';
                    break;
                case 'medium':
                    props.iconSizeCustom = '2.5rem';
                    props.iconBackgroundSize = '70px';
                    break;
                case 'huge':
                    props.iconSizeCustom = '4rem';
                    props.iconBackgroundSize = '100px';
                    break;
                default: // large
                    props.iconSizeCustom = '3rem';
                    props.iconBackgroundSize = '80px';
            }
        }

        function getGridColumnsValue(gridType) {
            const gridMap = {
                'auto-fit-250': 'repeat(auto-fit, minmax(250px, 1fr))',
                'auto-fit-300': 'repeat(auto-fit, minmax(300px, 1fr))',
                'auto-fit-350': 'repeat(auto-fit, minmax(350px, 1fr))', 
                'auto-fit-400': 'repeat(auto-fit, minmax(400px, 1fr))',
                'repeat(1, 1fr)': 'repeat(1, 1fr)',
                'repeat(2, 1fr)': 'repeat(2, 1fr)',
                'repeat(3, 1fr)': 'repeat(3, 1fr)', 
                'repeat(4, 1fr)': 'repeat(4, 1fr)',
                'repeat(5, 1fr)': 'repeat(5, 1fr)',
                '1fr': '1fr'
            };
            return gridMap[gridType] || 'repeat(auto-fit, minmax(300px, 1fr))';
        }


        // Module Bibliothek laden
        function loadModuleLibrary() {
            const library = document.getElementById('moduleLibrary');
            library.innerHTML = '';

            // Custom Templates laden (HIER EINFÜGEN)
            loadCustomTemplates();

            const categories = [...new Set(MODULE_TEMPLATES.map(t => t.category))];

            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.innerHTML = `<h4 class="category-title">${category}</h4>`;
                library.appendChild(categoryDiv);

                MODULE_TEMPLATES.filter(t => t.category === category).forEach(template => {
                    const moduleDiv = document.createElement('div');
                    moduleDiv.className = 'module-template';
                    moduleDiv.dataset.templateId = template.id;

                    moduleDiv.innerHTML = `
                        <div class="module-name">${template.name}</div>
                        <div class="module-description">${template.description}</div>
                    `;

                    moduleDiv.addEventListener('click', () => {
                        addModuleToCanvas(template.id);
                    });

                    library.appendChild(moduleDiv);
                });
            });
        }


        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // Image Upload
        document.getElementById('imageInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imageUrl = e.target.result;
                    const fileName = `uploaded_${Date.now()}_${file.name}`;
                    uploadedImages[fileName] = imageUrl;

                    if (selectedModule && currentProperty) {
                        selectedModule.properties[currentProperty] = imageUrl;
                        renderPropertyPanel();
                        closeImageModal();
                        showNotification('✅ Bild hochgeladen und zugewiesen');
                    }
                };
                reader.readAsDataURL(file);
            }
        });



        // Event Listener Management
        let moduleEventListeners = new Map();

        function removeModuleEventListeners() {
            moduleEventListeners.forEach((listeners, moduleId) => {
                listeners.forEach(({ element, event, handler }) => {
                    if (element && element.removeEventListener) {
                        element.removeEventListener(event, handler);
                    }
                });
            });
            moduleEventListeners.clear();
        }

        function addModuleEventListener(moduleId, element, event, handler) {
            if (!moduleEventListeners.has(moduleId)) {
                moduleEventListeners.set(moduleId, []);
            }
            moduleEventListeners.get(moduleId).push({ element, event, handler });
            element.addEventListener(event, handler);
        }

        // 6️⃣ NEUE FUNKTION: Live-Interaktivität aktivieren
        function activateModuleInteractivity() {
            console.log('🎮 Aktiviere Module-Interaktivität...');

            // FAQ Accordion Interaktivität (EDITOR-OPTIMIERT)
            const faqItems = document.querySelectorAll('.kerberos-faq-item');
            console.log(`🎯 FAQ Items gefunden: ${faqItems.length}`);

            faqItems.forEach((item, index) => {
                const header = item.querySelector('.faq-header');
                const content = item.querySelector('.faq-content');
                const icon = item.querySelector('.faq-icon');

                if (header && content && icon) {
                    // Entferne alle bestehenden FAQ-Event-Listener
                    header.removeEventListener('click', header._faqClickHandler);
                    
                    // Erstelle neuen Event-Handler
                    const faqClickHandler = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        
                        console.log(`🖱️ FAQ ${index + 1} geklickt`);
                        
                        // Aktuelle FAQ-Referenzen neu holen (wichtig!)
                        const currentContent = item.querySelector('.faq-content');
                        const currentIcon = item.querySelector('.faq-icon');
                        
                        if (!currentContent || !currentIcon) {
                            console.warn('FAQ Elemente nicht gefunden');
                            return;
                        }
                        
                        const isOpen = currentContent.style.maxHeight && 
                                    currentContent.style.maxHeight !== '0px' && 
                                    currentContent.style.maxHeight !== '';

                        console.log(`📊 FAQ Status: ${isOpen ? 'offen' : 'geschlossen'}`);

                        // Schließe alle anderen FAQs in diesem Modul
                        const moduleContainer = item.closest('.canvas-module, .kerberos-module, section');
                        if (moduleContainer) {
                            moduleContainer.querySelectorAll('.kerberos-faq-item').forEach(otherItem => {
                                if (otherItem !== item) {
                                    const otherContent = otherItem.querySelector('.faq-content');
                                    const otherIcon = otherItem.querySelector('.faq-icon');
                                    if (otherContent && otherIcon) {
                                        otherContent.style.maxHeight = '0px';
                                        otherIcon.style.transform = 'rotate(0deg)';
                                        otherIcon.innerHTML = '&#xf067;';
                                        otherItem.style.background = 'transparent';
                                    }
                                }
                            });
                        }

                        // Toggle aktuelle FAQ
                        if (!isOpen) {
                            // FAQ öffnen
                            currentContent.style.maxHeight = currentContent.scrollHeight + 'px';
                            currentIcon.style.transform = 'rotate(45deg)';
                            currentIcon.innerHTML = '&#xf068;'; // Minus icon
                            item.style.background = 'rgba(6,58,168,0.02)';
                            console.log('✅ FAQ geöffnet');
                        } else {
                            // FAQ schließen
                            currentContent.style.maxHeight = '0px';
                            currentIcon.style.transform = 'rotate(0deg)';
                            currentIcon.innerHTML = '&#xf067;'; // Plus icon
                            item.style.background = 'transparent';
                            console.log('📤 FAQ geschlossen');
                        }
                    };
                    
                    // Event-Handler speichern für späteres Entfernen
                    header._faqClickHandler = faqClickHandler;
                    
                    // Event-Listener mit höchster Priorität hinzufügen
                    header.addEventListener('click', faqClickHandler, true);
                    
                    // Zusätzlicher Fallback-Listener
                    item.addEventListener('click', function(e) {
                        if (e.target.closest('.faq-header')) {
                            faqClickHandler(e);
                        }
                    }, true);
                    
                    // Sichtbare Kennzeichnung für Debugging
                    header.style.cursor = 'pointer';
                    header.title = `FAQ ${index + 1} - Klicken zum Öffnen/Schließen`;
                    
                    console.log(`✅ FAQ ${index + 1} Event-Listener gesetzt`);
                } else {
                    console.warn(`❌ FAQ ${index + 1} unvollständig:`, {
                        header: !!header,
                        content: !!content, 
                        icon: !!icon
                    });
                }
            });

            // Dashboard Card Hover Effects
            const dashboardCards = document.querySelectorAll('.kerberos-dashboard-card');
            dashboardCards.forEach(card => {
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-4px)';
                    card.style.boxShadow = '0 8px 24px rgba(6,58,168,0.15)';
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0)';
                    card.style.boxShadow = '0 2px 8px rgba(6,58,168,0.08)';
                });
            });

            // Chart Area Click Effect
            const chartAreas = document.querySelectorAll('.kerberos-chart-area');
            chartAreas.forEach(chartArea => {
                chartArea.addEventListener('click', (e) => {
                    e.stopPropagation();
                    chartArea.style.background = 'rgba(6,58,168,0.02)';
                    setTimeout(() => {
                        chartArea.style.background = 'white';
                    }, 200);
                });
            });

            // Testimonials Carousel
            const testimonialTracks = document.querySelectorAll('.kerberos-testimonials-track');
            testimonialTracks.forEach(track => {
                const trackContainer = track.closest('.canvas-module');
                if (!trackContainer) return;

                const slides = track.querySelectorAll('.testimonial-slide');
                const dots = trackContainer.querySelectorAll('.testimonial-dot');
                const prevBtn = trackContainer.querySelector('.kerberos-prev');
                const nextBtn = trackContainer.querySelector('.kerberos-next');

                if (slides.length === 0 || dots.length === 0) return;

                let currentSlide = 0;
                let autoPlay = true;
                let autoPlayInterval;

                function goToSlide(index) {
                    currentSlide = index;
                    track.style.transform = 'translateX(-' + (currentSlide * 100) + '%)';

                    dots.forEach((dot, i) => {
                        dot.style.background = i === currentSlide ? '#063AA8' : '#DEE2E6';
                    });
                }

                function nextSlide() {
                    currentSlide = (currentSlide + 1) % slides.length;
                    goToSlide(currentSlide);
                }

                function prevSlide() {
                    currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                    goToSlide(currentSlide);
                }

                // Event listeners
                if (nextBtn) {
                    nextBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        nextSlide();
                        autoPlay = false;
                        clearInterval(autoPlayInterval);
                    });
                }

                if (prevBtn) {
                    prevBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        prevSlide();
                        autoPlay = false;
                        clearInterval(autoPlayInterval);
                    });
                }

                dots.forEach((dot, index) => {
                    dot.addEventListener('click', (e) => {
                        e.stopPropagation();
                        goToSlide(index);
                        autoPlay = false;
                        clearInterval(autoPlayInterval);
                    });
                });

                // Auto-play
                autoPlayInterval = setInterval(() => {
                    if (autoPlay) nextSlide();
                }, 5000);

                // Pause on hover
                track.addEventListener('mouseenter', () => {
                    autoPlay = false;
                    clearInterval(autoPlayInterval);
                });
                track.addEventListener('mouseleave', () => {
                    autoPlay = true;
                    autoPlayInterval = setInterval(() => {
                        if (autoPlay) nextSlide();
                    }, 5000);
                });

                // Initialize
                goToSlide(0);
            });

            // Feature Cards Hover Effects
            const featureCards = document.querySelectorAll('.kerberos-feature-card');
            featureCards.forEach(card => {
                const icon = card.querySelector('.feature-icon');
                const overlay = card.querySelector('.feature-overlay');

                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-8px)';
                    card.style.boxShadow = '0 16px 40px rgba(6,58,168,0.15)';
                    if (icon) icon.style.transform = 'scale(1.1) rotate(5deg)';
                    if (overlay) overlay.style.opacity = '1';
                });

                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0)';
                    card.style.boxShadow = '0 4px 12px rgba(6,58,168,0.08)';
                    if (icon) icon.style.transform = 'scale(1) rotate(0deg)';
                    if (overlay) overlay.style.opacity = '0';
                });
            });

            // Timeline Steps Intersection Observer (KORRIGIERT)
            const timelineSteps = document.querySelectorAll('.timeline-step');
            if (timelineSteps.length > 0) {
                const timelineObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.style.opacity = '1';
                            entry.target.style.transform = 'translateY(0)';
                        }
                    });
                }, { threshold: 0.3 });

                timelineSteps.forEach((step, index) => {
                    step.style.opacity = '0';
                    step.style.transform = 'translateY(20px)';
                    step.style.transition = `all 0.6s ease ${index * 0.2}s`;
                    timelineObserver.observe(step);

                    // KORRIGIERTE Hover effects - behalten translateX(-50%) bei
                    step.addEventListener('mouseenter', () => {
                        const card = step.querySelector('.timeline-card');
                        const dot = step.querySelector('.timeline-dot');
                        if (card) card.style.transform = 'scale(1.02)';
                        if (dot) dot.style.transform = 'translateX(-50%) scale(1.2)'; // FIX: translateX beibehalten
                    });

                    step.addEventListener('mouseleave', () => {
                        const card = step.querySelector('.timeline-card');
                        const dot = step.querySelector('.timeline-dot');
                        if (card) card.style.transform = 'scale(1)';
                        if (dot) dot.style.transform = 'translateX(-50%) scale(1)'; // FIX: translateX beibehalten
                    });
                });
            }

            // === NEUE MODULE INTERAKTIVITÄT ===

            // API Documentation Tab-Switching
            const apiTabs = document.querySelectorAll('.api-lang-tab');
            const codeBlocks = document.querySelectorAll('.api-code-block');
            apiTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const lang = tab.dataset.lang;

                    // Update tabs
                    apiTabs.forEach(t => {
                        t.style.background = t.dataset.lang === lang ? '{{primaryColor}}' : '{{inactiveTabBg}}';
                        t.style.color = t.dataset.lang === lang ? 'white' : '{{inactiveTabColor}}';
                    });

                    // Update code blocks
                    codeBlocks.forEach(block => {
                        block.style.display = block.dataset.lang === lang ? 'block' : 'none';
                    });
                });
            });

            // Integration Filter
            const integrationFilters = document.querySelectorAll('.integration-filter');
            const integrationCards = document.querySelectorAll('.integration-card');
            integrationFilters.forEach(filter => {
                filter.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const category = filter.dataset.category;

                    // Update filter buttons
                    integrationFilters.forEach(f => {
                        const isActive = f.dataset.category === category;
                        f.style.background = isActive ? '{{primaryColor}}' : 'transparent';
                        f.style.color = isActive ? 'white' : '{{primaryColor}}';
                    });

                    // Filter cards
                    integrationCards.forEach(card => {
                        const cardCategory = card.dataset.category;
                        const shouldShow = category === 'all' || cardCategory === category;
                        card.style.display = shouldShow ? 'block' : 'none';
                    });
                });
            });

            // Enhanced Hover Effects für neue Module
            const apiEndpointCards = document.querySelectorAll('.api-endpoint-card');
            apiEndpointCards.forEach(card => {
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-4px)';
                    card.style.boxShadow = '0 8px 24px rgba(6,58,168,0.15)';
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0)';
                    card.style.boxShadow = 'none';
                });
            });

            const pricingPlans = document.querySelectorAll('.pricing-plan');
            pricingPlans.forEach(plan => {
                plan.addEventListener('mouseenter', () => {
                    plan.style.transform = plan.style.transform.includes('scale(1.05)') ?
                        plan.style.transform.replace('scale(1.05)', 'scale(1.08)') : 'scale(1.03)';
                });
                plan.addEventListener('mouseleave', () => {
                    plan.style.transform = plan.style.transform.includes('scale(1.08)') ?
                        plan.style.transform.replace('scale(1.08)', 'scale(1.05)') : 'scale(1)';
                });
            });

            const screenshotCards = document.querySelectorAll('.screenshot-card');
            screenshotCards.forEach(card => {
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-8px)';
                    card.style.boxShadow = '0 12px 32px rgba(6,58,168,0.15)';
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0)';
                    card.style.boxShadow = 'none';
                });
            });

            // ✨ UNIVERSELLE BUTTON HOVER-EFFEKTE
            applyUniversalButtonHoverEffects();

            console.log('✅ Module-Interaktivität aktiviert!');
        }

        // ✨ Universelle Button Hover-Effekte für alle Module
        function applyUniversalButtonHoverEffects() {
            // Entferne alte Hover-Styles
            const existingStyle = document.getElementById('kerberos-button-hover-styles');
            if (existingStyle) existingStyle.remove();

            // Erstelle CSS für alle Module
            let css = `/* Kerberos Universal Button Hover Effects */\n`;

            // Basis-Styles für alle Kerberos-Buttons
            css += `.kerberos-btn {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                cursor: pointer !important;
                position: relative !important;
                overflow: hidden !important;
            }\n\n`;

            // NACH dem bestehenden CSS hinzufügen:
            css += `
            /* Responsive Styles für Warnungs-Modul */
            @media (max-width: 768px) {
                .kerberos-warning-module h2 {
                    font-size: 1.5rem !important;
                    line-height: 1.3 !important;
                }
                
                .kerberos-warning-module h3 {
                    font-size: 1.2rem !important;
                }
                
                .kerberos-warning-module .background-overlay {
                    opacity: 0.05 !important;
                }
                
                /* ✨ NEUE GLOBALE BUTTON-RESPONSIVITÄT */
                .kerberos-btn, .kerberos-btn-secondary {
                    width: 100% !important;
                    max-width: 300px !important;
                    justify-content: center !important;
                    margin: 0.5rem auto !important;
                    display: inline-flex !important;
                }
                
                /* Breaker Module Button Container */
                .breaker-btn-primary, .breaker-btn-secondary {
                    width: 100% !important;
                    max-width: 300px !important;
                    justify-content: center !important;
                }
                
                /* Testimonials Navigation */
                .testimonials-navigation {
                    flex-direction: column !important;
                    gap: 1rem !important;
                }
                
                /* Timeline Cards */
                .timeline-card {
                    width: 100% !important;
                    margin-left: 0 !important;
                    margin-right: 0 !important;
                    margin-bottom: 2rem !important;
                }
                
                .timeline-dot {
                    position: relative !important;
                    left: auto !important;
                    transform: none !important;
                    margin: 0 auto 1rem auto !important;
                }
                
                /* Integration Filter Buttons */
                .integration-filter {
                    margin: 0.25rem !important;
                    font-size: 0.9rem !important;
                    padding: 0.5rem 1rem !important;
                }
                
                /* Stats Items */
                .stat-item, .kerberos-stat-card {
                    padding: 1rem !important;
                }
                
                /* Product Cards */
                .kerberos-product-card {
                    margin-bottom: 1.5rem !important;
                }
                
                /* Dashboard Grid */
                .dashboard-grid {
                    grid-template-columns: 1fr !important;
                    gap: 1.5rem !important;
                }
                
                .dashboard-bottom-row {
                    grid-template-columns: 1fr !important;
                    gap: 1.5rem !important;
                }
            }

            @media (max-width: 480px) {
                .kerberos-warning-module div[style*="grid-template-columns"] {
                    grid-template-columns: 1fr !important;
                    gap: 1.5rem !important;
                }
                
                .kerberos-warning-module div[style*="height: 80px"] {
                    height: 60px !important;
                }
                
                /* ✨ EXTRA KLEINE BILDSCHIRME */
                .kerberos-btn, .kerberos-btn-secondary {
                    max-width: 280px !important;
                    padding: 0.75rem 1rem !important;
                    font-size: 1rem !important;
                }
                
                /* Mobile Typography */
                .kerberos-module h1 {
                    font-size: 1.8rem !important;
                    line-height: 1.2 !important;
                }
                
                .kerberos-module h2 {
                    font-size: 1.5rem !important;
                    line-height: 1.3 !important;
                }
                
                .kerberos-module h3 {
                    font-size: 1.2rem !important;
                }
                
                /* Padding Anpassungen */
                .kerberos-module section {
                    padding: 3rem 0 !important;
                }
                
                .testimonial-content {
                    padding: 1.5rem !important;
                    min-height: 300px !important;
                }
                
                .timeline-card {
                    padding: 1.5rem !important;
                }
                
                .dashboard-card {
                    padding: 1rem !important;
                }
                
                .integration-card {
                    padding: 1rem !important;
                }
                
                /* Icon Container Anpassungen */
                div[style*="width: 120px"][style*="height: 120px"] {
                    width: 80px !important;
                    height: 80px !important;
                    font-size: 2.5rem !important;
                }
                
                /* Stats Hover-Effekte Mobile */
                .stat-item:hover, .kerberos-stat-card:hover {
                    transform: translateY(-4px) scale(1.02) !important;
                }
            }
            
            /* ✨ TABLET RESPONSIVE (768px - 1024px) */
            @media (min-width: 768px) and (max-width: 1024px) {
                .kerberos-btn, .kerberos-btn-secondary {
                    max-width: 250px !important;
                }
                
                .timeline-card {
                    padding: 1.8rem !important;
                }
                
                .testimonial-content {
                    padding: 1.8rem !important;
                }
            }
            
            /* ✨ HOVER-EFFEKTE FÜR STATISTIKEN (CURSOR KORRIGIERT) */
            .stat-item, .kerberos-stat-card {
                transition: all 0.3s ease !important;
                cursor: default !important;
                padding: 1.5rem !important;
                border-radius: 12px !important;
            }

            /* Nur echte Links in Stats bekommen Pointer */
            .stat-item a, .stat-item button, .stat-item [onclick],
            .kerberos-stat-card a, .kerberos-stat-card button, .kerberos-stat-card [onclick] {
                cursor: pointer !important;
            }
            
            .stat-item:hover, .kerberos-stat-card:hover {
                transform: translateY(-8px) scale(1.05) !important;
                background: rgba(6,58,168,0.05) !important;
                box-shadow: 0 12px 32px rgba(6,58,168,0.15) !important;
            }
            
            .stat-item:hover [style*="font-family: 'Font Awesome 5 Pro'"],
            .kerberos-stat-card:hover [style*="font-family: 'Font Awesome 5 Pro'"] {
                transform: scale(1.2) !important;
                color: #009CE6 !important;
                transition: all 0.3s ease !important;
            }
            
            /* ✨ TIMELINE HOVER-EFFEKTE */
            .timeline-step:hover .timeline-card {
                transform: scale(1.02) !important;
                box-shadow: 0 8px 24px rgba(6,58,168,0.15) !important;
            }
            
            .timeline-step:hover .timeline-dot {
                transform: translateX(-50%) scale(1.1) !important;
            }
            
            @media (max-width: 768px) {
                .timeline-step:hover .timeline-dot {
                    transform: scale(1.1) !important;
                }
            }
            
            /* ✨ TESTIMONIALS RESPONSIVE */
            .kerberos-testimonials-track {
                will-change: transform !important;
            }
            
            .testimonial-slide {
                flex-shrink: 0 !important;
            }
            
            .testimonials-dots .testimonial-dot {
                background: #DEE2E6 !important;
                transition: all 0.3s ease !important;
            }
            
            .testimonials-dots .testimonial-dot.active {
                background: #063AA8 !important;
                transform: scale(1.2) !important;
            }
            
            .testimonials-dots .testimonial-dot:hover {
                background: #009CE6 !important;
                transform: scale(1.1) !important;
            }
            
            /* ✨ INTEGRATION CARDS HOVER */
            .integration-card {
                transition: all 0.3s ease !important;
                cursor: default !important;
            }

            /* Nur echte Links in Integration Cards bekommen Pointer */
            .integration-card a, .integration-card button, .integration-card [onclick] {
                cursor: pointer !important;
            }
            
            .integration-card:hover {
                transform: translateY(-4px) !important;
                box-shadow: 0 8px 24px rgba(6,58,168,0.15) !important;
                border-color: rgba(6,58,168,0.3) !important;
            }
            
            /* ✨ FILTER BUTTON FIXES für Squarespace */
            .integration-filter {
                transition: all 0.3s ease !important;
                cursor: pointer !important;
            }
            
            .integration-filter:hover {
                background: #009CE6 !important;
                color: white !important;
                border-color: #009CE6 !important;
                transform: translateY(-1px) !important;
            }
            
            .integration-filter.active {
                background: #063AA8 !important;
                color: white !important;
                border-color: #063AA8 !important;
            }
            
            /* ✨ DASHBOARD RESPONSIVE */
            .dashboard-card {
                transition: all 0.3s ease !important;
            }
            
            .dashboard-card:hover {
                transform: translateY(-4px) !important;
                box-shadow: 0 8px 24px rgba(6,58,168,0.15) !important;
            }
            
            .chart-container, .activity-container {
                min-height: 300px !important;
            }
            
            @media (max-width: 768px) {
                .chart-container, .activity-container {
                    min-height: 250px !important;
                }
            }
            `;

            // Individuelle Hover-Styles für jedes Modul
            modules.forEach(module => {
                const props = module.properties;
                const hoverColor = props.buttonHoverColor || '#FFFFFF';
                const hoverBg = props.buttonHoverBg || 'rgba(6,58,168,0.8)';
                const hoverTransform = props.buttonHoverTransform || 'translateY(-2px)';
                const hoverShadow = props.buttonHoverShadow || '0 8px 24px rgba(6,58,168,0.25)';

                css += `.kerberos-btn-${module.id}:hover {
                    background: ${hoverBg} !important;
                    color: ${hoverColor} !important;
                    transform: ${hoverTransform} !important;
                    box-shadow: ${hoverShadow} !important;
                }\n\n`;

                // Ripple-Effekt für moderne Interaktion
                css += `.kerberos-btn-${module.id}:active {
                    transform: translateY(0px) !important;
                    transition: all 0.1s ease !important;
                }\n\n`;

                // ✨ SECONDARY BUTTON HOVER für Feature Breaker
                css += `.kerberos-btn-secondary.kerberos-btn-${module.id}:hover {
                    background: ${props.secondaryButtonHoverBg || props.secondaryButtonColor || '#FFFFFF'} !important;
                    color: ${props.secondaryButtonHoverColor || '#063AA8'} !important;
                    border-color: ${props.secondaryButtonHoverBg || props.secondaryButtonColor || '#FFFFFF'} !important;
                    transform: translateY(-2px) !important;
                }\n\n`;
            });

            // Fallback für Buttons ohne spezifische Klasse
            css += `.canvas-module a[style*="background"]:not(.kerberos-btn):hover {
                filter: brightness(1.1) saturate(1.1) !important;
                transform: translateY(-1px) !important;
                box-shadow: 0 6px 20px rgba(6,58,168,0.2) !important;
                transition: all 0.3s ease !important;
            }\n\n`;

            // CSS einfügen
            const style = document.createElement('style');
            style.id = 'kerberos-button-hover-styles';
            style.textContent = css;
            document.head.appendChild(style);

            console.log('✨ Universelle Button-Hover-Effekte aktiviert!');
            console.log('📱 Mobile Responsivität aktiviert!');
            console.log('🎨 Alle Hover-Effekte und Animationen geladen!');
        } // <- Diese schließende Klammer fehlte!




        // Fallback-Funktion für Template-Platzhalter
        function replaceTemplatePlaceholders(html, module) {
            // Ersetze alle übrig gebliebenen Platzhalter mit leeren Strings oder Standardwerten
            html = html.replace(/\{\{[^}]+\}\}/g, (match) => {
                console.warn('Unbekannter Platzhalter gefunden:', match, 'in Modul:', module.name);
                return ''; // Oder einen Standardwert zurückgeben
            });

            return html;
        }

        function addStatsHoverEffects() {
            // Suchen Sie nach Ihrem Statistik-Modul CSS und ergänzen Sie:
            const statsHoverCSS = `
                <style>
                .stat-item, .kerberos-stat-card {
                    transition: all 0.3s ease !important;
                    cursor: pointer !important;
                }
                .stat-item:hover, .kerberos-stat-card:hover {
                    transform: translateY(-8px) scale(1.05) !important;
                    background: rgba(6,58,168,0.05) !important;
                    box-shadow: 0 12px 32px rgba(6,58,168,0.15) !important;
                    border-radius: 12px !important;
                }
                .stat-item:hover [style*="font-family: 'Font Awesome 5 Pro'"],
                .kerberos-stat-card:hover [style*="font-family: 'Font Awesome 5 Pro'"] {
                    transform: scale(1.2) !important;
                    color: #009CE6 !important;
                }
                </style>
            `;
        }


        // ===== UNIVERSELLE HOVER-CSS GENERATION (CURSOR-KORRIGIERT) =====
        function generateUniversalHoverCSS(module) {
            if (!module || !module.properties) return '';
            
            const props = module.properties;
            
            // Nur generieren wenn Hover aktiviert ist
            if (props.enableHover === 'false') return '';
            
            // Hover-Werte aus Properties oder Fallbacks
            const hoverTransform = props.hoverTransform || props.cardHoverTransform || 'translateY(-4px)';
            const hoverShadow = props.hoverShadow || props.cardHoverShadow || '0 8px 24px rgba(6,58,168,0.15)';
            const hoverBackground = props.hoverBackground || props.cardHoverBackground || 'rgba(6,58,168,0.05)';
            const hoverDuration = props.hoverDuration || '0.3s';
            
            // CSS für verschiedene Hover-Elemente mit KORREKTEM Cursor-Verhalten
            return `
            <style>
                /* === UNIVERSELLE TRANSITIONS (KEIN CURSOR-CHANGE) === */
                .module-${module.id} .hover-element,
                .module-${module.id} .stat-item,
                .module-${module.id} .kerberos-stat-card,
                .module-${module.id} .feature-card,
                .module-${module.id} .product-card,
                .module-${module.id} .testimonial-card,
                .module-${module.id} .timeline-step,
                .module-${module.id} .solution-card,
                .module-${module.id} .benefit-card,
                .module-${module.id} .card {
                    transition: all ${hoverDuration} ease !important;
                    cursor: default !important; /* WICHTIG: Default-Cursor für alle */
                }
                
                /* === HOVER-EFFEKTE FÜR NICHT-INTERAKTIVE ELEMENTE === */
                .module-${module.id} .hover-element:not(a):not(button):not([onclick]):not([href]):hover,
                .module-${module.id} .stat-item:not(a):not(button):not([onclick]):not([href]):hover,
                .module-${module.id} .kerberos-stat-card:not(a):not(button):not([onclick]):not([href]):hover,
                .module-${module.id} .feature-card:not(a):not(button):not([onclick]):not([href]):hover,
                .module-${module.id} .product-card:not(a):not(button):not([onclick]):not([href]):hover,
                .module-${module.id} .testimonial-card:not(a):not(button):not([onclick]):not([href]):hover,
                .module-${module.id} .timeline-step:not(a):not(button):not([onclick]):not([href]):hover,
                .module-${module.id} .solution-card:not(a):not(button):not([onclick]):not([href]):hover,
                .module-${module.id} .benefit-card:not(a):not(button):not([onclick]):not([href]):hover,
                .module-${module.id} .card:not(a):not(button):not([onclick]):not([href]):hover {
                    transform: ${hoverTransform} !important;
                    box-shadow: ${hoverShadow} !important;
                    background: ${hoverBackground} !important;
                    cursor: default !important; /* BLEIBT Default-Cursor */
                }
                
                /* === HOVER-EFFEKTE FÜR INTERAKTIVE ELEMENTE (mit Pointer-Cursor) === */
                .module-${module.id} a.hover-element:hover,
                .module-${module.id} a.stat-item:hover,
                .module-${module.id} a.kerberos-stat-card:hover,
                .module-${module.id} a.feature-card:hover,
                .module-${module.id} a.product-card:hover,
                .module-${module.id} a.testimonial-card:hover,
                .module-${module.id} a.timeline-step:hover,
                .module-${module.id} a.solution-card:hover,
                .module-${module.id} a.benefit-card:hover,
                .module-${module.id} a.card:hover,
                .module-${module.id} button.hover-element:hover,
                .module-${module.id} button.stat-item:hover,
                .module-${module.id} button.kerberos-stat-card:hover,
                .module-${module.id} [onclick].hover-element:hover,
                .module-${module.id} [onclick].stat-item:hover,
                .module-${module.id} [onclick].kerberos-stat-card:hover {
                    transform: ${hoverTransform} !important;
                    box-shadow: ${hoverShadow} !important;
                    background: ${hoverBackground} !important;
                    cursor: pointer !important; /* NUR hier Pointer-Cursor */
                }
                
                /* === CURSOR-REGELN (HÖCHSTE PRIORITÄT) === */
                .module-${module.id} a[href],
                .module-${module.id} button,
                .module-${module.id} [onclick],
                .module-${module.id} [role="button"],
                .module-${module.id} .kerberos-btn {
                    cursor: pointer !important;
                }
                
                /* === EXPLIZITE DEFAULT-CURSOR-REGELN === */
                .module-${module.id} .hover-element:not(a):not(button):not([onclick]):not([href]),
                .module-${module.id} .stat-item:not(a):not(button):not([onclick]):not([href]),
                .module-${module.id} .kerberos-stat-card:not(a):not(button):not([onclick]):not([href]),
                .module-${module.id} .feature-card:not(a):not(button):not([onclick]):not([href]),
                .module-${module.id} .product-card:not(a):not(button):not([onclick]):not([href]),
                .module-${module.id} .card:not(a):not(button):not([onclick]):not([href]),
                .module-${module.id} div:not([onclick]):not([role="button"]),
                .module-${module.id} p:not([onclick]):not([role="button"]),
                .module-${module.id} h1:not([onclick]):not([role="button"]),
                .module-${module.id} h2:not([onclick]):not([role="button"]),
                .module-${module.id} h3:not([onclick]):not([role="button"]),
                .module-${module.id} span:not([onclick]):not([role="button"]) {
                    cursor: default !important;
                }
            </style>`;
        }
    
        // NEUE FUNKTION: Dynamische Button Event Handler
        function bindDynamicButtonHandlers() {
            const canvas = document.getElementById('canvas');
            if (!canvas) return;

            // Alle Buttons und Links im Canvas finden
            canvas.querySelectorAll('a[href], button, .filter-btn').forEach(element => {
                // Entferne alte Event Listener (Clone-Trick)
                const newElement = element.cloneNode(true);
                element.parentNode.replaceChild(newElement, element);
                
                // Neue Event Listener hinzufügen
                newElement.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    const dataFilter = this.getAttribute('data-filter');
                    
                    // Filter Buttons für Integrations Grid
                    if (dataFilter) {
                        e.preventDefault();
                        
                        // Active State setzen
                        canvas.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Filter anwenden
                        const cards = canvas.querySelectorAll('[data-category]');
                        cards.forEach(card => {
                            if (dataFilter === 'all' || card.getAttribute('data-category') === dataFilter) {
                                card.style.display = 'block';
                            } else {
                                card.style.display = 'none';
                            }
                        });
                        
                        console.log('🎯 Filter angewendet:', dataFilter);
                        return;
                    }
                    
                    // Normale Links
                    if (href) {
                        // Interne Anker
                        if (href.startsWith('#')) {
                            e.preventDefault();
                            const target = document.querySelector(href);
                            if (target) {
                                target.scrollIntoView({ behavior: 'smooth' });
                            }
                        }
                        // Externe Links - normale Funktion
                        else if (href.startsWith('http') || href.startsWith('mailto')) {
                            return true;
                        }
                    }
                    
                    console.log('✅ Button geklickt:', this.textContent.trim());
                });
            });

            // Hover-Effekte für Feature Cards
            canvas.querySelectorAll('.feature-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                    this.style.boxShadow = '0 10px 25px rgba(0,0,0,0.1)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                });
            });

            console.log('🎯 Dynamische Button Handler gebunden');
        }

        // Globale Template-Platzhalter Ersetzung (Fallback)
        function replaceTemplatePlaceholders(html, module) {
            if (!module || !module.properties) return html;

            // Ersetze alle übrig gebliebenen Template-Platzhalter
            Object.entries(module.properties).forEach(([key, value]) => {
                const regex = new RegExp(`{{${key}}}`, 'g');
                html = html.replace(regex, value || '');
            });

            // Spezielle Platzhalter
            html = html.replace(/{{imageUrl}}/g, module.properties.imageUrl || '');
            html = html.replace(/{{currentValue}}/g, '');

            return html;
        }

        // ✨ Hover-Effekte CSS für Export generieren
        function embedHoverEffectsCSS(module, html) {
            const props = module.properties;

            // Hover-Properties mit Fallback-Werten
            const hoverColor = props.buttonHoverColor || '#FFFFFF';
            const hoverBg = props.buttonHoverBg || 'rgba(6,58,168,0.8)';
            const hoverTransform = props.buttonHoverTransform || 'translateY(-2px)';
            const hoverShadow = props.buttonHoverShadow || '0 8px 24px rgba(6,58,168,0.25)';
            const moduleId = module.id || 'default';

            // 1. Modul-spezifische Klasse nur hinzufügen wenn noch keine kerberos-module Klasse vorhanden
            const wrapperClass = 'kerberos-module-' + moduleId;
            if (!html.includes('kerberos-module-') && (html.includes('<section') || html.includes('<div'))) {
                html = html.replace(/(<(?:section|div)[^>]*)(>)/, '$1 class="' + wrapperClass + '"$2');
            }

            // 2. Button-Klassen zu Links hinzufügen (wichtig für CSS-Targeting)
            html = html.replace(
                /(<a[^>]*style="[^"]*background:[^"]*"[^>]*>)/g,
                (match) => {
                    // Prüfe ob es bereits eine kerberos-btn Klasse hat
                    if (match.includes('kerberos-btn')) {
                        return match;
                    }
                    // Füge Button-Klassen hinzu
                    if (match.includes('display: inline-flex') ||
                        match.includes('padding:') ||
                        match.includes('border-radius:')) {
                        return match.replace('<a', `<a class="kerberos-btn kerberos-btn-${moduleId}"`);
                    }
                    return match;
                }
            );

            // 3. CSS-Styles generieren (NICHT Inline-Events!)
            const css = `
                <style>
                /* Kerberos Button Hover Effects - Modul ${moduleId} */
                .kerberos-btn-${moduleId} {
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                    cursor: pointer !important;
                    position: relative !important;
                    overflow: hidden !important;
                }
                .kerberos-btn-${moduleId}:hover {
                    background: ${hoverBg} !important;
                    color: ${hoverColor} !important;
                    transform: ${hoverTransform} !important;
                    box-shadow: ${hoverShadow} !important;
                }
                .kerberos-btn-${moduleId}:active {
                    transform: translateY(0px) !important;
                    transition: all 0.1s ease !important;
                }
                /* Mobile Responsive für SVG */
                @media (max-width: 768px) {
                    .kerberos-module-${module.id} .hero-svg-code {
                        width: 200px !important;
                        height: 100px !important;
                        max-width: 80vw !important;
                    }
                    
                    .kerberos-module-${module.id} > div > div:first-child {
                        margin-bottom: 1.5rem !important;
                    }
                }

                @media (max-width: 480px) {
                    .kerberos-module-${module.id} .hero-svg-code {
                        display: none !important;
                    }
                    
                    .kerberos-module-${module.id} > div > div:first-child {
                        margin-bottom: 0 !important;
                    }
                }

                /* Fallback für Buttons ohne spezifische Klasse */
                .kerberos-module-${module.id} a[style*="background"]:not(.kerberos-btn):hover {
                    filter: brightness(1.1) saturate(1.1) !important;
                    transform: translateY(-1px) !important;
                    box-shadow: 0 6px 20px rgba(6,58,168,0.2) !important;
                    transition: all 0.3s ease !important;
                }
                </style>
            `;

            // 4. CSS am Anfang des HTML hinzufügen
            html = css + html;

            return html;
        }


        // NEUE FUNKTION: Auto-Update für Live-Vorschau
        function autoUpdatePreview() {
            // Debounce für bessere Performance
            clearTimeout(window.autoUpdateTimeout);
            window.autoUpdateTimeout = setTimeout(() => {
                if (selectedModule) {
                    renderCanvas();
                }
            }, 300);
        }

        function groupPropertiesForAccordion(properties) {
            // SPEZIELLE BEHANDLUNG für Challenge-Solution Module
            if (selectedModule && selectedModule.templateId === 'kerberos-solution-triple') {
                return groupChallengeSolutionProperties(properties);
            }

            const groups = {
                general: [],
                styling: [],     // 🆕 Hinzugefügt
                advanced: []     // 🆕 Hinzugefügt
            };

            Object.entries(properties).forEach(([key, value]) => {
                if (shouldHideProperty(key)) return;

                // 🎨 DESIGN & STYLING (höchste Priorität)
                if (key.includes('Shadow') || key.includes('Glow') || key.includes('Transform') ||
                    key.includes('Hover') || key.includes('Gradient') ||
                    (key.includes('Border') && !key.includes('Color'))) {
                    groups.styling.push([key, value]);
                }

                // 🔧 ERWEITERTE EINSTELLUNGEN
                else if (key.includes('buttonHover') || key.includes('cardHover') ||
                    key.includes('textShadow') || key.includes('cardShadow') ||
                    key.includes('Filter') || key.includes('Backdrop')) {
                    groups.advanced.push([key, value]);
                }

                // 📊 SPEZIFISCHE MODULE-GRUPPEN
                else if (key.includes('testimonial')) {
                    if (!groups.testimonials) groups.testimonials = [];
                    groups.testimonials.push([key, value]);
                }
                else if (key.includes('feature') && (key.includes('Plan') || key.includes('Name'))) {
                    if (!groups.features) groups.features = [];
                    groups.features.push([key, value]);
                }
                else if (key.includes('member') || key.includes('team')) {
                    if (!groups.team) groups.team = [];
                    groups.team.push([key, value]);
                }
                else if (key.includes('stat') && key.match(/\d/)) {
                    if (!groups.stats) groups.stats = [];
                    groups.stats.push([key, value]);
                }
                else if (key.includes('row') && key.match(/\d/)) {
                    if (!groups.rows) groups.rows = [];
                    groups.rows.push([key, value]);
                }
                else if (key.includes('plan') && key.match(/\d/)) {
                    if (!groups.plans) groups.plans = [];
                    groups.plans.push([key, value]);
                }

                // 🏠 ALLGEMEINE EIGENSCHAFTEN (niedrigste Priorität)
                else {
                    groups.general.push([key, value]);
                }
            });

            // Entferne leere Gruppen
            Object.keys(groups).forEach(key => {
                if (groups[key].length === 0) {
                    delete groups[key];
                }
            });

            return groups;
        }

        function formatGroupName(groupKey) {
            const names = {
                // Spezielle Namen für Challenge-Solution Modul
                content: selectedModule?.templateId === 'kerberos-solution-triple-richtext' ? '📝 Inhalte bearbeiten' : 'Allgemeine Einstellungen',
                styling: '🎨 Design & Farben',
                settings: '⚙️ Sichtbarkeit & Layout',

                // Standard-Namen für andere Module
                general: 'Allgemeine Einstellungen',
                advanced: '🔧 Erweiterte Einstellungen',
                testimonials: '💬 Testimonials & Bewertungen',
                features: '⭐ Features & Eigenschaften',
                team: '👥 Team-Mitglieder',
                stats: '📊 Statistiken & Zahlen',
                rows: '📋 Tabellen-Zeilen',
                plans: '💰 Preispläne',
                members: '👤 Mitarbeiter'
            };
            return names[groupKey] || groupKey;
        }


        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.accordion-icon');
            const isOpen = content.style.maxHeight !== '0px' && content.style.maxHeight !== '';

            if (isOpen) {
                content.style.maxHeight = '0px';
                icon.textContent = '+';
            } else {
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.textContent = '−';
            }
        }

        // Globale Funktion verfügbar machen
        window.toggleAccordion = toggleAccordion;



        // NEUE FUNKTION: Spezielle Gruppierung für Challenge-Solution Module
        function groupChallengeRequirementSolution(properties) {
            const groups = {
                content: [],
                styling: [],
                settings: []
            };

            Object.entries(properties).forEach(([key, value]) => {
                // HAUPTINHALTE
                if (key === 'mainTitle' || key === 'subtitle') {
                    groups.content.push([key, value]);
                }
                // CHALLENGE SEKTION
                else if (key.startsWith('challenge')) {
                    groups.content.push([key, value]);
                }
                // REQUIREMENT SEKTION  
                else if (key.startsWith('requirement')) {
                    groups.content.push([key, value]);
                }
                // SOLUTION SEKTION
                else if (key.startsWith('solution')) {
                    groups.content.push([key, value]);
                }
                // CTA BEREICH
                else if (key.includes('cta') || key.includes('Cta')) {
                    groups.content.push([key, value]);
                }
                // FARBEN & DESIGN
                else if (key.includes('Color') || key.includes('Background') || key.includes('Shadow')) {
                    groups.styling.push([key, value]);
                }
                // EINSTELLUNGEN
                else if (key.includes('show') || key.includes('Show') || key.includes('Auto') || key.includes('Spacing')) {
                    groups.settings.push([key, value]);
                }
                // FALLBACK zu Content
                else {
                    groups.content.push([key, value]);
                }
            });

            // Leere Gruppen entfernen
            Object.keys(groups).forEach(key => {
                if (groups[key].length === 0) {
                    delete groups[key];
                }
            });

            return groups;
        }

        function groupPropertiesByContext(properties) {
            // Special handling for Challenge-Requirement-Solution Module
            if (selectedModule.templateId === 'kerberos-solution-triple') {
                return groupChallengeRequirementSolution(properties);
            }
            const groups = {
                'Allgemein': {},
                'Plan 1': {},
                'Plan 2': {},
                'Plan 3': {},
                'Tabelle': {},
                'Layout': {}
            };

            Object.entries(properties).forEach(([key, value]) => {
                if (shouldHideProperty(key)) return;

                if (key.includes('plan1')) groups['Plan 1'][key] = value;
                else if (key.includes('plan2')) groups['Plan 2'][key] = value;
                else if (key.includes('plan3')) groups['Plan 3'][key] = value;
                else if (key.includes('table') || key.includes('feature')) groups['Tabelle'][key] = value;
                else if (key.includes('Spacing') || key.includes('Gap')) groups['Layout'][key] = value;
                else groups['Allgemein'][key] = value;
            });

            // Leere Gruppen entfernen
            return Object.fromEntries(Object.entries(groups).filter(([, props]) => Object.keys(props).length > 0));
        }

        function switchPropertyTab(e) {
            const targetGroup = e.target.dataset.group;

            // Update Tabs
            document.querySelectorAll('.property-tab').forEach(tab => {
                const isActive = tab.dataset.group === targetGroup;
                tab.style.background = isActive ? '#063AA8' : 'transparent';
                tab.style.color = isActive ? 'white' : '#063AA8';
            });

            // Update Content
            document.querySelectorAll('.property-group').forEach(group => {
                group.style.display = group.dataset.group === targetGroup ? 'block' : 'none';
            });
        }

        // Generische Property-Type-Erkennung für alle Module
        function getFieldType(key, value) {

            // Size/Größen-Dropdowns
            if (key.includes('SizeType')) {
                return 'size-dropdown';
            }
            
            // Padding/Spacing-Dropdowns
            if (key.includes('PaddingType') || key.includes('SpacingType') || key.includes('GapType')) {
                return 'spacing-dropdown';
            }
            
            // Radius-Dropdowns
            if (key.includes('RadiusType')) {
                return 'radius-dropdown';
            }
            
            // Shadow-Dropdowns
            if (key.includes('ShadowType')) {
                return 'shadow-dropdown';
            }
            
            // Transform/Hover-Dropdowns
            if (key.includes('TransformType') || key.includes('HoverTransformType')) {
                return 'transform-dropdown';
            }
            
            // Width/Height-Dropdowns - KORRIGIERT
            if (key === 'heightType' || key === 'mobileHeightType' || key === 'tabletHeightType') {
                return 'select'; // Standard-Select für Height-Types
            }
            if (key.includes('WidthType') || key.includes('HeightType') || key.includes('MinWidthType')) {
                return 'dimension-dropdown';
            }
            
            // Alignment-Dropdowns
            if (key.includes('AlignmentType') || key.includes('JustifyType')) {
                return 'alignment-dropdown';
            }
            
            // Border-Dropdowns
            if (key.includes('BorderType')) {
                return 'border-dropdown';
            }
            
            // Filter/Effect-Dropdowns
            if (key.includes('FilterType') || key.includes('OpacityType')) {
                return 'effect-dropdown';
            }
            
            // SPEZIELLE AUSNAHMEN: Diese Properties sollen normale Select-Dropdowns sein
            if (key === 'buttonStyleType' || key === 'secondaryButtonStyleType' || key === 'iconBackgroundType' || key.includes('OpacityType')) {
                return 'select';
            }

            // Style-Dropdowns
            if (key.includes('StyleType') || key.includes('buttonStyle') || key.includes('ButtonStyle')) {                 
                return 'select';             
            }

            // SPEZIELLE AUSNAHMEN: Bildbearbeitungsfelder sollen NICHT als Image-Picker gerendert werden
            if (key === 'imageHeight' || key === 'imageObjectFit' || key === 'imageObjectPosition' || key === 'imageCustomCSS') {
                if (key === 'imageObjectFit') {
                    return 'select'; // Dropdown für cover/contain/etc
                }
                if (key === 'imageObjectPosition') {
                    return 'select'; // Dropdown für center/top/etc
                }
                return 'text'; // Normale Text-Eingabe
            }

            // Layout-Dropdowns
            if (key.includes('LayoutType') || key.includes('GridType') || key.includes('ColumnsType')) {
                return 'layout-dropdown';
            }
            // Layout-Dropdowns
            if (key.includes('LayoutType') || key.includes('GridType') || key.includes('ColumnsType')) {
                return 'layout-dropdown';
            }

            // Scale-Dropdowns
            if (key.includes('ScaleType') || key.includes('HoverScale')) {
                return 'scale-dropdown';
            }

            // Display-Dropdowns
            if (key.includes('DisplayType')) {
                return 'display-dropdown';
            }

            // Speed/Animation-Dropdowns
            if (key.includes('SpeedType') || key.includes('DurationType')) {
                return 'animation-dropdown';
            }

            // Object-Fit/Position-Dropdowns
            if (key.includes('ObjectFitType') || key.includes('ObjectPositionType')) {
                return 'object-dropdown';
            }

            // Pattern/Background-Dropdowns
            if (key.includes('PatternType') || key.includes('BackgroundType')) {
                return 'pattern-dropdown';
            }

            // Gradient-Type-Dropdowns
            if (key.includes('GradientType') || key.includes('gradientType')) {
                return 'select';
            }

            // === GUIDE-FLOW SPEZIFISCHE FELDTYPEN ===
            if (selectedModule && selectedModule.templateId === 'kerberos-guide-flow') {
                if (key.includes('HotspotX') || key.includes('HotspotY')) {
                    return 'guide-hotspot-range';
                }
                if (key === 'stepsActive') {
                    return 'guide-steps-number';
                }
                if (key.includes('Icon') && key.startsWith('step')) {
                    return 'guide-step-icon';
                }
            }
            // Farben (immer Color Picker)
            if (key.includes('Color') || key.includes('color')) return 'color';

            // WICHTIG: Dropdown-Eigenschaften ZUERST prüfen (*Type, *Style, layout*, *Preset)
            if (key.endsWith('Type') || key.endsWith('Style') || key.startsWith('layout') || key.endsWith('Preset')) {
                // Ausnahmen für Text-Inputs
                if (key.includes('custom') || key.includes('Custom') || 
                    key.includes('interval') || key.includes('Interval') ||
                    key.includes('width') || key.includes('Width') ||
                    key.includes('height') || key.includes('Height')) {
                    return 'text';
                }
                return 'select';
            }

            // SVG-spezifische Properties
            if (key === 'svgType') return 'select';
            if (key === 'svgCode') return 'textarea';
            if (key === 'svgWidth') return 'svg-sizer';
            if (key === 'svgHeight') return 'svg-sizer-hidden'; // Wird automatisch gesetzt

            // Boolean-Eigenschaften (show*, *Active, auto*, *Advance)
            if (key.startsWith('show') || key.endsWith('Active') || 
                key.startsWith('auto') || key.includes('Advance') ||
                (typeof value === 'string' && (value === 'true' || value === 'false'))) {
                return 'boolean';
            }

            // Icons (nur echte Icon-Properties, NICHT *Type Properties)
            if ((key.includes('Icon') || key.includes('icon')) && !key.endsWith('Type') && !key.endsWith('Style') && !key.endsWith('Preset') && key !== 'iconSize' && key !== 'iconSpacing' && key !== 'iconRadius' && key !== 'iconBackground' && key !== 'iconContainerSize') return 'icon';

            // Bilder (nur echte URLs)
            if ((key.includes('Image') || key.includes('image') || key.endsWith('Url')) && !key.includes('Alt') && !key.includes('Order') && !key.includes('Radius') && !key.includes('Shadow') && !key.includes('Background') && !key.endsWith('Type') && !key.includes('Height') && !key.includes('ObjectFit') && !key.includes('ObjectPosition') && !key.includes('CustomCSS')) return 'image';
            
            // Position-Eigenschaften
            if (key.includes('Position') || key.includes('position')) return 'position';

            // Spacing-Eigenschaften (erweitert)
            // SPEZIELLE AUSNAHME: verticalSpacing ist ein Dropdown, nicht normaler Spacing-Input
            if (key === 'verticalSpacing') return 'select';

            // Spacing-Eigenschaften (erweitert)
            if (key.includes('Spacing') || key.includes('spacing') || key.includes('Gap') || key.includes('gap') || key.includes('Padding') || key.includes('padding') || key.includes('Margin') || key.includes('margin')) return 'spacing';

            // Shadow/Hover/Gradient/Border Presets - ERWEITERT
            if (key.includes('Shadow') && (key.includes('Type') || key.includes('Preset'))) return 'shadow-preset';
            if (key.includes('Hover') && (key.includes('Type') || key.includes('Preset'))) return 'hover-preset';
            if (key.includes('Transform') && !key.includes('Type')) return 'hover-preset'; // für hoverTransform
            if (key === 'enableHover' || key === 'hoverEnabled') return 'boolean';
            if (key.includes('Gradient') && (key.includes('Type') || key.includes('Preset'))) return 'gradient-preset';
            if (key.includes('Border') && (key.includes('Type') || key.includes('Preset'))) return 'border-preset';

            // Positionierung (position, Position)
            if (key.includes('Position') || key.includes('position')) return 'position';

            // 🎨 PRESET-PROPERTIES (Smart Dropdowns)
            if (key.includes('Shadow') || key.includes('Glow')) return 'shadow-preset';
            if (key.includes('Transform') || key.includes('Hover')) return 'hover-preset';
            if (key.includes('Gradient') || key.includes('Background') && key.includes('Gradient')) return 'gradient-preset';

            // 🔧 ERWEITERTE PROPERTIES (versteckt in Accordion)
            if (key.includes('buttonHover') || key.includes('cardHover') ||
                key.includes('textShadow') || key.includes('cardShadow') ||
                key.includes('Filter') || key.includes('Backdrop')) return 'advanced';

            // CSS-Eigenschaften (für fortgeschrittene User)
            if (key.includes('Border') && !key.includes('Color') && !key.includes('Radius')) return 'border-preset';

            // Dropdowns für Optionen (OHNE Alt-Text)
            if (key.includes('Order') || key.includes('order') ||
                key.includes('Count') || key.includes('count') ||
                key.includes('Layout') || key.includes('layout') ||
                key.includes('Type') || key.includes('type') ||
                key.includes('Border') || key.includes('border') ||
                key.includes('Align') || key.includes('align')) return 'select';

            // Abstände (vereinfacht)
            if (key.includes('Spacing') || key.includes('spacing') ||
                key.includes('Margin') || key.includes('margin') ||
                key.includes('Padding') || key.includes('padding') ||
                key.includes('Gap') || key.includes('gap')) return 'spacing';

            // 🆕 RICH TEXT für längere Texte und spezielle Felder
            if (key.includes('Question') || key.includes('Answer') ||
                key.includes('Description') || key.includes('Text') ||
                key.includes('Content') || key.includes('text') ||
                key.includes('title') || key.includes('Title') ||
                key.includes('subtitle') || key.includes('Subtitle') ||
                (typeof value === 'string' && value.length > 100)) return 'richtext';

            // Normale Textarea für mittlere Texte
            if ((key.includes('text') || key.includes('Description') || key.includes('description')) && value.length > 50 && value.length <= 100) return 'textarea';

            // Default: Text input
            return 'text';
        }

        // Height-Type Options für Select-Dropdowns
        function getHeightTypeOptions() {
            return [
                { value: 'small', label: '📏 Klein' },
                { value: 'medium', label: '📏 Normal' }, 
                { value: 'large', label: '📏 Groß' },
                { value: 'extra-large', label: '📏 Sehr groß' }
            ];
        }

        function getGridDropdownOptions() {
            return {
                'auto-fit-250': '🏠 Klein (250px)',
                'auto-fit-300': '🏘️ Normal (300px)', 
                'auto-fit-350': '🏙️ Groß (350px)',
                'auto-fit-400': '🌆 Extra groß (400px)',
                'repeat(1, 1fr)': '📱 1 Spalte',
                'repeat(2, 1fr)': '📋 2 Spalten',
                'repeat(3, 1fr)': '🗂️ 3 Spalten',
                'repeat(4, 1fr)': '🏢 4 Spalten',
                'repeat(5, 1fr)': '🏭 5 Spalten'
            };
        }

        function getTransformDropdownOptions() {
            return {
                'none': '🚫 Kein Effekt',
                'translateY(-2px)': '⬆️ Leicht nach oben',
                'translateY(-4px)': '⬆️⬆️ Nach oben',
                'translateY(-8px)': '⬆️⬆️⬆️ Stark nach oben',
                'scale(1.02)': '🔍 Leicht vergrößern',
                'scale(1.05)': '🔍🔍 Vergrößern',
                'scale(1.1)': '🔍🔍🔍 Stark vergrößern'
            };
        }

        function getScaleDropdownOptions() {
            return {
                '1': '🚫 Keine Skalierung',
                '1.01': '🔍 Minimal (1%)',
                '1.02': '🔍 Klein (2%)',
                '1.05': '🔍🔍 Normal (5%)',
                '1.1': '🔍🔍🔍 Groß (10%)'
            };
        }

        function getRadiusDropdownOptions() {
            return {
                'none': '📐 Eckig (0px)',
                'small': '📐 Klein (4px)',
                'medium': '📐 Normal (8px)',
                'large': '📐 Groß (16px)',
                'extra-large': '📐 Extra groß (24px)',
                'circle': '⭕ Rund (50%)',
                'pill': '💊 Pill (999px)'
            };
        }

        // === SIZE DROPDOWNS ===
        function getSizeOptions(key) {
            if (key.includes('icon') || key.includes('Icon')) {
                return {
                    'small': '1.25rem',
                    'medium': '1.75rem', 
                    'large': '2.5rem',
                    'extra-large': '4rem'
                };
            }
            
            if (key.includes('title') || key.includes('heading')) {
                return {
                    'small': 'var(--heading-4-size)',
                    'medium': 'var(--heading-3-size)',
                    'large': 'var(--heading-2-size)',
                    'extra-large': 'var(--heading-1-size)'
                };
            }
            
            if (key.includes('text') || key.includes('subtitle')) {
                return {
                    'small': 'var(--small-text-size)',
                    'medium': 'var(--normal-text-size)',
                    'large': 'var(--large-text-size)',
                    'extra-large': 'var(--heading-4-size)'
                };
            }
            
            if (key.includes('button') || key.includes('nav')) {
                return {
                    'small': '32px',
                    'medium': '40px',
                    'large': '56px',
                    'extra-large': '72px'
                };
            }
            
            return {
                'small': '0.75rem',
                'medium': '1rem',
                'large': '1.5rem',
                'extra-large': '2rem'
            };
        }

        // === SPACING/PADDING DROPDOWNS ===
        function getSpacingOptions(key) {
            if (key.includes('section')) {
                return {
                    'none': '0',
                    'small': '2rem 0',
                    'medium': '4rem 0',
                    'large': '6rem 0',
                    'extra-large': '8rem 0'
                };
            }
            
            if (key.includes('Padding') || key.includes('padding')) {
                return {
                    'none': '0',
                    'small': '0.5rem 1rem',
                    'medium': '1rem 2rem',
                    'large': '1.25rem 2.5rem',
                    'extra-large': '1.5rem 3rem'
                };
            }
            
            return {
                'none': '0',
                'small': '1rem',
                'medium': '2rem',
                'large': '3rem',
                'extra-large': '4rem'
            };
        }

        // === RADIUS DROPDOWNS ===
        function getRadiusOptions() {
            return {
                'none': '0',
                'small': '4px',
                'medium': '8px',
                'large': '12px',
                'extra-large': '16px',
                'circle': '50%',
                'pill': '9999px'
            };
        }

        // === SHADOW DROPDOWNS ===
        function getShadowOptions() {
            return {
                'none': 'none',
                'light': '0 2px 8px rgba(0,0,0,0.1)',
                'medium': '0 4px 12px rgba(6,58,168,0.2)',
                'strong': '0 8px 24px rgba(6,58,168,0.25)',
                'extra-strong': '0 16px 40px rgba(6,58,168,0.3)'
            };
        }

        // === TRANSFORM DROPDOWNS ===
        function getTransformOptions() {
            return {
                'none': 'none',
                'translateY(-2px)': 'translateY(-2px)',
                'translateY(-4px)': 'translateY(-4px)',
                'translateY(-8px)': 'translateY(-8px)',
                'scale(1.05)': 'scale(1.05)',
                'scale(1.1)': 'scale(1.1)',
                'scale(1.1) rotate(5deg)': 'scale(1.1) rotate(5deg)'
            };
        }

        // === DIMENSION DROPDOWNS ===
        function getDimensionOptions(key) {
            if (key.includes('Height')) {
                return {
                    'auto': 'auto',
                    'small': '200px',
                    'medium': '300px',
                    'large': '400px',
                    'full': '100vh'
                };
            }
            
            if (key.includes('Width') || key.includes('MinWidth')) {
                return {
                    'small': '200px',
                    'medium': '300px',
                    'large': '500px',
                    'extra-large': '800px',
                    'full': '100%'
                };
            }
            
            return {
                'small': '2px',
                'medium': '3px',
                'large': '4px'
            };
        }

        // === ALIGNMENT DROPDOWNS ===
        function getAlignmentOptions(key) {
            if (key.includes('text') || key.includes('Text')) {
                return {
                    'left': 'left',
                    'center': 'center',
                    'right': 'right',
                    'justify': 'justify'
                };
            }
            
            if (key.includes('justify') || key.includes('Justify')) {
                return {
                    'start': 'flex-start',
                    'center': 'center',
                    'end': 'flex-end',
                    'space-between': 'space-between',
                    'space-around': 'space-around'
                };
            }
            
            return {
                'start': 'flex-start',
                'center': 'center',
                'end': 'flex-end'
            };
        }

        // === BORDER DROPDOWNS ===
        function getBorderOptions() {
            return {
                'none': 'none',
                'thin': '1px solid #DEE2E6',
                'medium': '2px solid #063AA8',
                'thick': '3px solid #063AA8',
                'dashed': '2px dashed #063AA8',
                'dotted': '2px dotted #063AA8'
            };
        }

        // === EFFECT DROPDOWNS ===
        function getEffectOptions(key) {
            if (key.includes('Opacity')) {
                return {
                    'none': '🚫 Kein Overlay (0%)',
                    'light': '☁️ Leicht (20%)',
                    'medium': '🌫️ Mittel (40%)',
                    'strong': '🌧️ Stark (60%)',
                    'heavy': '⛈️ Sehr stark (80%)',
                    'full': '🌑 Vollständig (100%)'
                };
            }
            
            if (key.includes('Filter')) {
                return {
                    'none': 'none',
                    'bright': 'brightness(1.2)',
                    'contrast': 'contrast(1.2)',
                    'blur': 'blur(2px)',
                    'grayscale': 'grayscale(0.5)'
                };
            }
            
            return {
                'none': 'none',
                'light': 'light',
                'medium': 'medium',
                'strong': 'strong'
            };
        }

        // === DISPLAY DROPDOWNS ===
        function getDisplayOptions() {
            return {
                'none': 'none',
                'block': 'block',
                'inline': 'inline',
                'inline-block': 'inline-block',
                'inline-flex': 'inline-flex',
                'flex': 'flex',
                'grid': 'grid'
            };
        }

        // === ANIMATION DROPDOWNS ===
        function getAnimationOptions() {
            return {
                'fast': '0.2s',
                'medium': '0.5s',
                'slow': '0.8s',
                'extra-slow': '1.2s'
            };
        }




        function updateImageProperty(baseKey, property, value) {
            if (!selectedModule) {
                console.error('❌ Kein selectedModule gefunden');
                return;
            }

            // Korrekte Property-Namen generieren
            const propertyKey = `${baseKey}${property.charAt(0).toUpperCase() + property.slice(1)}`;
            selectedModule.properties[propertyKey] = value;
            
            console.log('🎨 updateImageProperty:', propertyKey, '=', value);

            // Modul sofort neu rendern
            refreshModule();

            // Properties-Panel aktualisieren
            setTimeout(() => {
                renderPropertyPanel();
            }, 100);

            showNotification(`🎨 Bild-${property} auf "${value}" gesetzt`);
        }

        // FEHLENDE HILFSFUNKTIONEN HINZUFÜGEN
        function applyDirectImageStyles(canvas) {
            if (!canvas || !selectedModule) return;
            
            // Finde alle Bilder im Canvas
            const images = canvas.querySelectorAll('img');
            images.forEach(img => {
                // Wende Standard-Bildoptimierungen an
                if (img.src.includes('svgrepo.com') || img.src.includes('svg')) {
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                    img.style.objectFit = 'contain';
                }
            });
            
            console.log('🖼️ Direct Image Styles angewendet auf', images.length, 'Bilder');
        }

        // FEHLENDE UTILITY-FUNKTIONEN
        function setAllImagesHeight(height) {
            if (!selectedModule) return;
            
            const keys = Object.keys(selectedModule.properties);
            keys.forEach(key => {
                if (key.includes('Height') && key.includes('Image') || key.includes('svg') || key.includes('background')) {
                    updateImageProperty(key.replace('Height', ''), 'height', height);
                }
            });
            
            showNotification(`📏 Alle Bilder auf ${height} gesetzt`);
        }

        function setAllImagesObjectFit(fit) {
            if (!selectedModule) return;
            
            const keys = Object.keys(selectedModule.properties);
            keys.forEach(key => {
                if (key.includes('Url') || key.includes('Image')) {
                    const baseKey = key.replace('Url', '').replace('Image', '');
                    updateImageProperty(baseKey, 'objectFit', fit);
                }
            });
            
            showNotification(`🖼️ Alle Bilder auf ${fit} gesetzt`);
        }







        function applyImagePreset(property, presetType) {
            const baseKey = property.replace('Url', '');
            
            switch(presetType) {
                case 'hero':
                    updateImageProperty(baseKey, 'objectFit', 'cover');
                    updateImageProperty(baseKey, 'objectPosition', 'center');
                    updateImageProperty(baseKey, 'height', '400px');
                    break;
                case 'card':
                    updateImageProperty(baseKey, 'objectFit', 'cover');
                    updateImageProperty(baseKey, 'objectPosition', 'center');
                    updateImageProperty(baseKey, 'height', '200px');
                    break;
                case 'thumbnail':
                    updateImageProperty(baseKey, 'objectFit', 'cover');
                    updateImageProperty(baseKey, 'objectPosition', 'center');
                    updateImageProperty(baseKey, 'height', '150px');
                    break;
                case 'background':
                    updateImageProperty(baseKey, 'objectFit', 'cover');
                    updateImageProperty(baseKey, 'objectPosition', 'center');
                    updateImageProperty(baseKey, 'height', '100vh');
                    break;
                case 'profile':
                    updateImageProperty(baseKey, 'objectFit', 'cover');
                    updateImageProperty(baseKey, 'objectPosition', 'center');
                    updateImageProperty(baseKey, 'height', '300px');
                    break;
                case 'wide':
                    updateImageProperty(baseKey, 'objectFit', 'cover');
                    updateImageProperty(baseKey, 'objectPosition', 'center');
                    updateImageProperty(baseKey, 'height', '250px');
                    break;
            }
            
            showNotification(`🎨 ${presetType}-Preset angewendet`);
        }


        function showImageEditor(property) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 2000; display: flex; 
                align-items: center; justify-content: center;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 1rem 0; color: var(--kerberos-primary);">🎨 Bild-Editor</h3>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem;">
                        <h4 style="color: #856404; margin: 0 0 0.5rem 0; font-size: 0.9rem;">💡 Häufige Probleme lösen</h4>
                        <button onclick="fixWhiteStripes('${property}')" class="btn btn-warning" style="width: 100%; margin-bottom: 0.5rem;">🔧 Weiße Striche entfernen</button>
                        <button onclick="resetImageCSS('${property}')" class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;">🔄 CSS zurücksetzen</button>
                    </div>
                    
                    <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem;">
                        <h4 style="color: #0c5460; margin: 0 0 1rem 0; font-size: 0.9rem;">🌐 Alle Bilder gleichzeitig</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <button onclick="setAllImagesHeight('200px')" class="btn btn-info" style="font-size: 0.8rem;">📏 Alle: 200px</button>
                            <button onclick="setAllImagesHeight('250px')" class="btn btn-info" style="font-size: 0.8rem;">📏 Alle: 250px</button>
                            <button onclick="setAllImagesHeight('300px')" class="btn btn-info" style="font-size: 0.8rem;">📏 Alle: 300px</button>
                            <button onclick="setAllImagesHeight('400px')" class="btn btn-info" style="font-size: 0.8rem;">📏 Alle: 400px</button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <button onclick="setAllImagesObjectFit('cover')" class="btn btn-info" style="font-size: 0.8rem;">🖼️ Alle: Cover</button>
                            <button onclick="setAllImagesObjectFit('contain')" class="btn btn-info" style="font-size: 0.8rem;">🖼️ Alle: Contain</button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <button onclick="setAllImagesObjectPosition('center')" class="btn btn-info" style="font-size: 0.8rem;">📍 Alle: Mitte</button>
                            <button onclick="setAllImagesObjectPosition('top')" class="btn btn-info" style="font-size: 0.8rem;">📍 Alle: Oben</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 1rem 0; font-size: 1rem;">Schnell-Anpassungen:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <button onclick="applyImagePreset('${property}', 'hero')" class="btn btn-primary" style="font-size: 0.85rem;">🖼️ Hero-Stil</button>
                            <button onclick="applyImagePreset('${property}', 'card')" class="btn btn-primary" style="font-size: 0.85rem;">🃏 Karten-Stil</button>
                            <button onclick="applyImagePreset('${property}', 'thumbnail')" class="btn btn-primary" style="font-size: 0.85rem;">🔍 Vorschau-Stil</button>
                            <button onclick="applyImagePreset('${property}', 'background')" class="btn btn-primary" style="font-size: 0.85rem;">🌄 Hintergrund-Stil</button>
                            <button onclick="applyImagePreset('${property}', 'profile')" class="btn btn-primary" style="font-size: 0.85rem;">👤 Profil-Stil</button>
                            <button onclick="applyImagePreset('${property}', 'wide')" class="btn btn-primary" style="font-size: 0.85rem;">📐 Breit-Stil</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button onclick="closeImageEditor()" class="btn btn-secondary">Schließen</button>
                    </div>
                </div>
            `;

            modal.id = 'imageEditorModal';
            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeImageEditor();
                }
            });
        }

        function closeImageEditor() {
            const modal = document.getElementById('imageEditorModal');
            if (modal) modal.remove();
        }

        // ===== SQUARESPACE CODE IMPORTER =====

        function showSquarespaceImporter() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 2000; display: flex; 
                align-items: center; justify-content: center; padding: 2rem;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 90vw; max-height: 90vh; width: 800px; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                    <div style="padding: 2rem; border-bottom: 1px solid #dee2e6;">
                        <h2 style="margin: 0; color: var(--kerberos-primary); font-size: 1.5rem;">🔄 Squarespace Code Importer</h2>
                        <p style="margin: 0.5rem 0 0; color: #6c757d;">Fügen Sie Squarespace HTML/CSS Code ein und lassen Sie ihn automatisch analysieren</p>
                    </div>
                    
                    <div style="padding: 2rem;">
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #212529;">Squarespace Code einfügen:</label>
                            <textarea id="squarespaceCodeInput" placeholder="Fügen Sie hier Ihren Squarespace HTML/CSS Code ein..." 
                                style="width: 100%; height: 300px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 0.9rem; border: 2px solid #dee2e6; border-radius: 8px; padding: 1rem; resize: vertical; background: #f8f9fa;"></textarea>
                        </div>
                        
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 0.5rem; color: #856404; font-size: 0.9rem;">💡 Unterstützte Formate:</h4>
                            <ul style="margin: 0; color: #856404; font-size: 0.85rem; padding-left: 1.2rem;">
                                <li>Squarespace HTML Export Code</li>
                                <li>Kerberos Module Code</li>
                                <li>HTML mit inline CSS</li>
                                <li>Komplette Section-Tags</li>
                            </ul>
                        </div>
                        
                        <div id="analysisResult" style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; display: none;">
                            <h4 style="margin: 0 0 0.5rem; color: #063AA8;">🔍 Analyse-Ergebnis:</h4>
                            <div id="analysisDetails"></div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="analyzeSquarespaceCode()" class="btn btn-primary" style="background: #063AA8;">🔍 Code Analysieren</button>
                            <div id="autoImportInfo" style="display: none; color: #28a745; font-size: 0.9rem; font-weight: 600;">
                                ⚡ Automatisches Einfügen aktiviert
                            </div>
                            <button onclick="closeSquarespaceImporter()" class="btn btn-secondary">Schließen</button>
                        </div>
                    </div>
                </div>
            `;

            modal.id = 'squarespaceImporterModal';
            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeSquarespaceImporter();
                }
            });
        }

        function closeSquarespaceImporter() {
            const modal = document.getElementById('squarespaceImporterModal');
            if (modal) modal.remove();
        }



        // Direkte Manipulation aller img-Tags im Canvas
        function applyDirectImageStyles(canvas) {
            if (!selectedModule || !canvas) return;
            
            const props = selectedModule.properties;
            const globalHeight = props.globalImageHeight || '200px';
            const globalObjectFit = props.globalImageObjectFit || 'cover';
            const globalObjectPosition = props.globalImageObjectPosition || 'center';
            const globalCustomCSS = props.globalImageCustomCSS || '';
            
            // Finde alle img-Tags im Canvas
            const images = canvas.querySelectorAll('img');
            let updatedCount = 0;
            
            images.forEach(img => {
                const newStyle = `width: 100%; height: ${globalHeight}; object-fit: ${globalObjectFit}; object-position: ${globalObjectPosition}; display: block; margin: 0; line-height: 0; ${globalCustomCSS}`;
                img.style.cssText = newStyle;
                updatedCount++;
            });
            
            console.log(`🎨 Direct Style Update: ${updatedCount} Bilder aktualisiert`);
        }

        // Alle Bilder im Modul auf gleiche Höhe setzen
        function setAllImagesHeight(height) {
            if (!selectedModule) return;
            
            // 1. Setze globale Properties
            selectedModule.properties.globalImageHeight = height;
            selectedModule.properties.globalImageObjectFit = 'cover';
            selectedModule.properties.globalImageObjectPosition = 'center';
            
            // 2. Setze für alle einzelnen Produkte
            for (let i = 1; i <= 12; i++) {
                selectedModule.properties[`product${i}ImageHeight`] = height;
                selectedModule.properties[`product${i}ImageObjectFit`] = 'cover';
                selectedModule.properties[`product${i}ImageObjectPosition`] = 'center';
            }
            
            // 3. Aktualisiere die Anzeige
            const canvas = document.getElementById('canvas');
            if (canvas) {
                canvas.innerHTML = processModuleHTML(selectedModule);
                
                // 4. DIREKTE MANIPULATION aller img-Tags
                setTimeout(() => {
                    applyDirectImageStyles(canvas);
                }, 100);
            }
            
            renderPropertyPanel();
            showNotification(`🎨 Alle Bilder auf Höhe "${height}" gesetzt`);
        }

        // Alle Bilder auf gleichen Object-Fit setzen
        function setAllImagesObjectFit(objectFit) {
            if (!selectedModule) return;
            
            // Globale Properties setzen
            selectedModule.properties.globalImageObjectFit = objectFit;
            
            // Für alle Produkte setzen
            for (let i = 1; i <= 12; i++) {
                selectedModule.properties[`product${i}ImageObjectFit`] = objectFit;
            }
            
            const canvas = document.getElementById('canvas');
            if (canvas) {
                canvas.innerHTML = processModuleHTML(selectedModule);
                
                // Direkte Manipulation
                setTimeout(() => {
                    applyDirectImageStyles(canvas);
                }, 100);
            }
            
            renderPropertyPanel();
            showNotification(`🎨 Alle Bilder auf "${objectFit}" gesetzt`);
        }

        function setAllImagesObjectPosition(objectPosition) {
            if (!selectedModule) return;
            
            // Globale Properties setzen
            selectedModule.properties.globalImageObjectPosition = objectPosition;
            
            // Für alle Produkte setzen
            for (let i = 1; i <= 12; i++) {
                selectedModule.properties[`product${i}ImageObjectPosition`] = objectPosition;
            }
            
            const canvas = document.getElementById('canvas');
            if (canvas) {
                canvas.innerHTML = processModuleHTML(selectedModule);
                
                // Direkte Manipulation
                setTimeout(() => {
                    applyDirectImageStyles(canvas);
                }, 100);
            }
            
            renderPropertyPanel();
            showNotification(`🎨 Alle Bilder-Fokus auf "${objectPosition}" gesetzt`);
        }

        function setAllImagesObjectPosition(objectPosition) {
            if (!selectedModule) return;
            
            let updatedCount = 0;
            
            // Globale Property setzen
            selectedModule.properties.globalImageObjectPosition = objectPosition;
            
            // Für alle Produkte setzen
            for (let i = 1; i <= 9; i++) {
                if (selectedModule.properties[`product${i}Active`] === 'true' || selectedModule.properties[`product${i}Image`]) {
                    selectedModule.properties[`product${i}ImageObjectPosition`] = objectPosition;
                    updatedCount++;
                }
            }
            
            if (updatedCount > 0) {
                const canvas = document.getElementById('canvas');
                if (canvas) {
                    canvas.innerHTML = processModuleHTML(selectedModule);
                }
                renderPropertyPanel();
                showNotification(`🎨 ${updatedCount} Bilder-Fokus auf "${objectPosition}" gesetzt`);
            }
        }

        function setAllImagesObjectPosition(objectPosition) {
            if (!selectedModule) return;
            
            let updatedCount = 0;
            
            Object.keys(selectedModule.properties).forEach(key => {
                if ((key.toLowerCase().includes('image') || key.toLowerCase().includes('url')) && selectedModule.properties[key]) {
                    const baseKey = key.replace('Url', '').replace('Image', '').replace('image', '');
                    const objectPositionProperty = `${baseKey}ObjectPosition`;
                    selectedModule.properties[objectPositionProperty] = objectPosition;
                    updatedCount++;
                }
            });
            
            if (updatedCount > 0) {
                const canvas = document.getElementById('canvas');
                if (canvas) {
                    canvas.innerHTML = processModuleHTML(selectedModule);
                }
                renderPropertyPanel();
                showNotification(`🎨 ${updatedCount} Bilder-Fokus auf "${objectPosition}" gesetzt`);
            }
        }        

        function fixWhiteStripes(property) {
            if (!selectedModule) return;

            const baseKey = property.replace('Url', '').replace('Image', '').replace('image', '');

            // Füge CSS-Properties hinzu um weiße Striche zu entfernen
            selectedModule.properties[`${baseKey}ObjectFit`] = 'cover';
            selectedModule.properties[`${baseKey}CustomCSS`] = 'margin: 0; display: block; line-height: 0;';
            selectedModule.properties[`${baseKey}Height`] = 'auto';

            applyChanges();
            renderPropertyPanel();
            showNotification('🔧 Weiße Striche entfernt');
            closeImageEditor();
        }

        function resetImageCSS(property) {
            if (!selectedModule) return;

            const baseKey = property.replace('Url', '').replace('Image', '').replace('image', '');

            // Entferne alle Image-CSS Properties
            delete selectedModule.properties[`${baseKey}ObjectFit`];
            delete selectedModule.properties[`${baseKey}ObjectPosition`];
            delete selectedModule.properties[`${baseKey}Height`];
            delete selectedModule.properties[`${baseKey}CustomCSS`];

            applyChanges();
            renderPropertyPanel();
            showNotification('🔄 Bild-CSS zurückgesetzt');
            closeImageEditor();
        }

        function applyImagePreset(property, preset) {
            if (!selectedModule) return;

            const baseKey = property.replace('Url', '').replace('Image', '').replace('image', '');

            const presets = {
                hero: {
                    objectFit: 'cover',
                    objectPosition: 'center',
                    height: '400px',
                    customCSS: 'margin: 0; display: block;'
                },
                card: {
                    objectFit: 'cover',
                    objectPosition: 'center',
                    height: '250px',
                    customCSS: 'margin: 0; display: block; border-radius: 8px;'
                },
                thumbnail: {
                    objectFit: 'cover',
                    objectPosition: 'center',
                    height: '120px',
                    customCSS: 'margin: 0; display: block; border-radius: 4px;'
                },
                background: {
                    objectFit: 'cover',
                    objectPosition: 'center',
                    height: '100vh',
                    customCSS: 'margin: 0; display: block;'
                },
                profile: {
                    objectFit: 'cover',
                    objectPosition: 'center top',
                    height: '300px',
                    customCSS: 'margin: 0; display: block; border-radius: 50%;'
                },
                wide: {
                    objectFit: 'cover',
                    objectPosition: 'center',
                    height: '200px',
                    customCSS: 'margin: 0; display: block; width: 100%;'
                }
            };

            const selectedPreset = presets[preset];
            if (selectedPreset) {
                // Alle Preset-Eigenschaften anwenden
                Object.keys(selectedPreset).forEach(prop => {
                    const propertyKey = `${baseKey}${prop.charAt(0).toUpperCase() + prop.slice(1)}`;
                    selectedModule.properties[propertyKey] = selectedPreset[prop];
                });

                // Sofort anwenden
                const canvas = document.getElementById('canvas');
                if (canvas) {
                    canvas.innerHTML = processModuleHTML(selectedModule);
                }
                
                renderPropertyPanel();
                showNotification(`🎨 ${preset.charAt(0).toUpperCase() + preset.slice(1)}-Stil angewendet`);
                closeImageEditor();
            }
        }

        // Globale Funktionen verfügbar machen
        window.showImageEditor = showImageEditor;
        window.closeImageEditor = closeImageEditor;
        window.fixWhiteStripes = fixWhiteStripes;
        window.resetImageCSS = resetImageCSS;
        window.applyImagePreset = applyImagePreset;
        window.updateImageProperty = updateImageProperty;

        // Property Name formatieren - Vollständige deutsche Übersetzung
        function formatPropertyName(key) {
            const names = {
                // === TITEL & TEXT ===
                title: 'Titel',
                subtitle: 'Untertitel',
                text: 'Text',
                description: 'Beschreibung',

                // === FARBEN ===
                titleColor: 'Titel-Farbe',
                subtitleColor: 'Untertitel-Farbe',
                textColor: 'Text-Farbe',
                backgroundColor: 'Hintergrund-Farbe',
                nameColor: 'Name-Farbe',
                positionColor: 'Position-Farbe',
                descriptionColor: 'Beschreibung-Farbe',

                // === BUTTONS (für alle Module) ===
                buttonText: 'Button-Text',
                buttonLink: 'Button-Link',
                buttonBgColor: 'Button-Hintergrund',
                buttonTextColor: 'Button-Text-Farbe',
                buttonPadding: 'Button-Innenabstand',
                buttonRadius: 'Button-Rundung',
                buttonBorder: 'Button-Rahmen',
                buttonShadow: 'Button-Schatten',
                buttonSpacing: 'Button-Abstand',
                buttonIcon: 'Button-Icon',

                // === BUTTON HOVER-EFFEKTE (universell) ===
                buttonHoverBgColor: 'Button-Hover-Hintergrund',
                buttonHoverTextColor: 'Button-Hover-Text',
                buttonHoverTransform: 'Button-Hover-Transformation',
                buttonHoverShadow: 'Button-Hover-Schatten',

                // === UNIVERSELLE HOVER-EFFEKTE ===
                enableHover: 'Hover-Effekte aktivieren',
                hoverTransform: 'Hover-Transformation',
                hoverShadow: 'Hover-Schatten',
                hoverBackground: 'Hover-Hintergrund',
                hoverDuration: 'Hover-Dauer',
                cardHoverTransform: 'Karten-Hover-Transformation',
                cardHoverShadow: 'Karten-Hover-Schatten',
                cardHoverBackground: 'Karten-Hover-Hintergrund',

                // === CTA BUTTONS (für moderne Module) ===
                primaryButtonText: 'Haupt-Button Text',
                primaryButtonLink: 'Haupt-Button Link',
                primaryButtonBg: 'Haupt-Button Farbe',
                primaryButtonColor: 'Haupt-Button Text-Farbe',
                secondaryButtonText: 'Zweit-Button Text',
                secondaryButtonLink: 'Zweit-Button Link',
                secondaryButtonBg: 'Zweit-Button Farbe',
                secondaryButtonColor: 'Zweit-Button Text-Farbe',

                // === BILDER ===
                imageUrl: 'Bild-URL',
                imageAlt: 'Bild-Beschreibung',
                imageRadius: 'Bild-Rundung',
                imageShadow: 'Bild-Schatten',
                imageOverlay: 'Bild-Overlay',
                backgroundImage: 'Hintergrundbild',

                // === ICONS ===
                iconClass: 'Icon',
                iconColor: 'Icon-Farbe',
                iconBackground: 'Icon-Hintergrund',
                iconRadius: 'Icon-Rundung',
                iconSpacing: 'Icon-Abstand',
                iconContainerSize: 'Icon-Container-Größe',

                // === LAYOUT & ABSTÄNDE ===
                layoutType: 'Layout',
                layout: 'Layout',
                sectionSpacing: 'Bereich-Abstand',
                contentGap: 'Inhalt-Abstand',
                contentPadding: 'Inhalt-Innenabstand',
                titleSpacing: 'Titel-Abstand',
                textSpacing: 'Text-Abstand',
                elementSpacing: 'Element-Abstand',

                // === TEAM MODULE ===
                teamGap: 'Team-Abstand',
                cardPadding: 'Karten-Innenabstand',
                avatarSize: 'Avatar-Größe',
                maxColumns: 'Max. Spalten',
                teamMemberCount: 'Anzahl Personen',

                // Team Member 1
                member1Name: 'Person 1: Name',
                member1Position: 'Person 1: Position',
                member1Description: 'Person 1: Beschreibung',
                member1Image: 'Person 1: Bild',
                member1InitialBg: 'Person 1: Avatar-Farbe',
                member1Active: 'Person 1: Anzeigen',

                // Team Member 2
                member2Name: 'Person 2: Name',
                member2Position: 'Person 2: Position',
                member2Description: 'Person 2: Beschreibung',
                member2Image: 'Person 2: Bild',
                member2InitialBg: 'Person 2: Avatar-Farbe',
                member2Active: 'Person 2: Anzeigen',

                // Team Member 3
                member3Name: 'Person 3: Name',
                member3Position: 'Person 3: Position',
                member3Description: 'Person 3: Beschreibung',
                member3Image: 'Person 3: Bild',
                member3InitialBg: 'Person 3: Avatar-Farbe',
                member3Active: 'Person 3: Anzeigen',

                // Team Member 4
                member4Name: 'Person 4: Name',
                member4Position: 'Person 4: Position',
                member4Description: 'Person 4: Beschreibung',
                member4Image: 'Person 4: Bild',
                member4InitialBg: 'Person 4: Avatar-Farbe',
                member4Active: 'Person 4: Anzeigen',

                // === STATISTIKEN MODULE ===
                statsGap: 'Statistik-Abstand',
                statMinWidth: 'Statistik-Breite',
                statPadding: 'Statistik-Innenabstand',

                // Statistik 1
                stat1Number: 'Statistik 1: Zahl',
                stat1Text: 'Statistik 1: Text',
                stat1Icon: 'Statistik 1: Icon',
                stat1IconColor: 'Statistik 1: Icon-Farbe',
                stat1NumberColor: 'Statistik 1: Zahlen-Farbe',
                stat1TextColor: 'Statistik 1: Text-Farbe',

                // Statistik 2
                stat2Number: 'Statistik 2: Zahl',
                stat2Text: 'Statistik 2: Text',
                stat2Icon: 'Statistik 2: Icon',
                stat2IconColor: 'Statistik 2: Icon-Farbe',
                stat2NumberColor: 'Statistik 2: Zahlen-Farbe',
                stat2TextColor: 'Statistik 2: Text-Farbe',

                // Statistik 3
                stat3Number: 'Statistik 3: Zahl',
                stat3Text: 'Statistik 3: Text',
                stat3Icon: 'Statistik 3: Icon',
                stat3IconColor: 'Statistik 3: Icon-Farbe',
                stat3NumberColor: 'Statistik 3: Zahlen-Farbe',
                stat3TextColor: 'Statistik 3: Text-Farbe',

                // Statistik 4
                stat4Number: 'Statistik 4: Zahl',
                stat4Text: 'Statistik 4: Text',
                stat4Icon: 'Statistik 4: Icon',
                stat4IconColor: 'Statistik 4: Icon-Farbe',
                stat4NumberColor: 'Statistik 4: Zahlen-Farbe',
                stat4TextColor: 'Statistik 4: Text-Farbe',

                // === VERALTETE PROPERTIES (versteckt) ===
                imageOrder: 'Bild-Position',
                textOrder: 'Text-Position',

                // === GENERISCHE FALLBACKS ===
                // Automatische Patterns für unbekannte Properties
            };

            // Direkte Übersetzung falls vorhanden
            if (names[key]) {
                return names[key];
            }

            // Generische Pattern-Erkennung für unbekannte Properties
            let formattedName = key;

            // Color -> Farbe
            if (key.endsWith('Color') || key.endsWith('color')) {
                formattedName = key.replace(/Color$|color$/, '-Farbe');
            }

            // Spacing -> Abstand
            if (key.endsWith('Spacing') || key.endsWith('spacing')) {
                formattedName = key.replace(/Spacing$|spacing$/, '-Abstand');
            }

            // Padding -> Innenabstand
            if (key.endsWith('Padding') || key.endsWith('padding')) {
                formattedName = key.replace(/Padding$|padding$/, '-Innenabstand');
            }

            // Margin -> Außenabstand  
            if (key.endsWith('Margin') || key.endsWith('margin')) {
                formattedName = key.replace(/Margin$|margin$/, '-Außenabstand');
            }

            // Gap -> Abstand
            if (key.endsWith('Gap') || key.endsWith('gap')) {
                formattedName = key.replace(/Gap$|gap$/, '-Abstand');
            }

            // Size -> Größe
            if (key.endsWith('Size') || key.endsWith('size')) {
                formattedName = key.replace(/Size$|size$/, '-Größe');
            }

            // Radius -> Rundung
            if (key.endsWith('Radius') || key.endsWith('radius')) {
                formattedName = key.replace(/Radius$|radius$/, '-Rundung');
            }

            // Shadow -> Schatten
            if (key.endsWith('Shadow') || key.endsWith('shadow')) {
                formattedName = key.replace(/Shadow$|shadow$/, '-Schatten');
            }

            // Border -> Rahmen
            if (key.endsWith('Border') || key.endsWith('border')) {
                formattedName = key.replace(/Border$|border$/, '-Rahmen');
            }

            // Background -> Hintergrund
            if (key.endsWith('Background') || key.endsWith('background')) {
                formattedName = key.replace(/Background$|background$/, '-Hintergrund');
            }

            // Image -> Bild
            if (key.endsWith('Image') || key.endsWith('image')) {
                formattedName = key.replace(/Image$|image$/, '-Bild');
            }

            // Icon -> Icon
            if (key.endsWith('Icon') || key.endsWith('icon')) {
                formattedName = key.replace(/Icon$|icon$/, '-Icon');
            }

            // Button -> Button
            if (key.startsWith('button') || key.startsWith('Button')) {
                formattedName = key.replace(/^button|^Button/, 'Button-');
            }

            // CamelCase in Bindestriche umwandeln und ersten Buchstaben groß machen
            formattedName = formattedName
                .replace(/([a-z])([A-Z])/g, '$1-$2')
                .toLowerCase()
                .split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join('-');

            return formattedName;
        }


        // Separate Initialisierungsfunktion
        function initializeRichTextEditor(editorId, propertyKey) {
            const editor = document.getElementById(editorId);
            if (!editor) return;

            const toolbar = editor.parentElement.querySelector('.richtext-toolbar');
            if (!toolbar) return;

            // Toolbar Events
            toolbar.addEventListener('click', (e) => {
                if (e.target.classList.contains('rt-btn')) {
                    e.preventDefault();
                    const command = e.target.dataset.command;

                    if (command === 'createLink') {
                        // Enhanced Link Dialog
                        const url = prompt('Link-URL eingeben:', 'https://');
                        if (url) {
                            const openInNewTab = confirm('Link in neuem Tab öffnen?\n\nOK = Neuer Tab\nAbbrechen = Gleicher Tab');
                            
                            // Erstelle Link mit document.execCommand
                            document.execCommand(command, false, url);
                            
                            // Finde den gerade erstellten Link und füge target hinzu
                            setTimeout(() => {
                                const selection = window.getSelection();
                                if (selection.rangeCount > 0) {
                                    const range = selection.getRangeAt(0);
                                    const link = range.commonAncestorContainer.parentElement;
                                    
                                    if (link && link.tagName === 'A') {
                                        if (openInNewTab) {
                                            link.setAttribute('target', '_blank');
                                            link.setAttribute('rel', 'noopener noreferrer');
                                        } else {
                                            link.removeAttribute('target');
                                            link.removeAttribute('rel');
                                        }
                                    }
                                    
                                    // Update Property
                                    updatePropertyFromRichText(propertyKey, editor.innerHTML);
                                }
                            }, 50);
                        }
                        } else if (command === 'createLinkNewTab') {
                            const url = prompt('Link-URL eingeben (öffnet in neuem Tab):', 'https://');
                            if (url) {
                                document.execCommand('createLink', false, url);
                                
                                // Finde den gerade erstellten Link und füge target hinzu
                                setTimeout(() => {
                                    const selection = window.getSelection();
                                    if (selection.rangeCount > 0) {
                                        const range = selection.getRangeAt(0);
                                        const link = range.commonAncestorContainer.parentElement;
                                        
                                        if (link && link.tagName === 'A') {
                                            link.setAttribute('target', '_blank');
                                            link.setAttribute('rel', 'noopener noreferrer');
                                        }
                                        
                                        updatePropertyFromRichText(propertyKey, editor.innerHTML);
                                    }
                                }, 50);
                            }
                            } else if (command === 'formatBlock') {
                                const value = e.target.dataset.value;
                                
                                // Saubere formatBlock-Implementierung
                                const selection = window.getSelection();
                                if (selection.rangeCount > 0) {
                                    const range = selection.getRangeAt(0);
                                    
                                    // Finde das umschließende Block-Element
                                    let blockElement = range.commonAncestorContainer;
                                    while (blockElement && blockElement.nodeType !== Node.ELEMENT_NODE) {
                                        blockElement = blockElement.parentNode;
                                    }
                                    
                                    // Finde das nächste Block-Element (h1-h6, p, div)
                                    while (blockElement && !['H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'P', 'DIV'].includes(blockElement.tagName)) {
                                        blockElement = blockElement.parentNode;
                                    }
                                    
                                    if (blockElement && blockElement.tagName !== value.toUpperCase()) {
                                        // Erstelle neues Element mit dem gewünschten Tag
                                        const newElement = document.createElement(value);
                                        newElement.innerHTML = blockElement.innerHTML;
                                        
                                        // Kopiere Styles (falls vorhanden)
                                        if (blockElement.getAttribute('style')) {
                                            newElement.setAttribute('style', blockElement.getAttribute('style'));
                                        }
                                        
                                        // Ersetze das alte Element
                                        blockElement.parentNode.replaceChild(newElement, blockElement);
                                        
                                        // Setze Selection auf das neue Element
                                        const newRange = document.createRange();
                                        newRange.selectNodeContents(newElement);
                                        selection.removeAllRanges();
                                        selection.addRange(newRange);
                                    } else {
                                        // Fallback für komplexere Fälle
                                        document.execCommand(command, false, value);
                                    }
                                }
                                
                                updatePropertyFromRichText(propertyKey, editor.innerHTML);
                            } else {
                                document.execCommand(command, false, null);
                            }

                    editor.focus();
                    updatePropertyFromRichText(propertyKey, editor.innerHTML);
                }
            });

            // Content Changes
            editor.addEventListener('input', () => {
                updatePropertyFromRichText(propertyKey, editor.innerHTML);
            });

            // Paste as plain text
            editor.addEventListener('paste', (e) => {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text');
                document.execCommand('insertText', false, text);
            });

            // Update active toolbar buttons
            const updateToolbarState = () => {
                toolbar.querySelectorAll('.rt-btn').forEach(btn => {
                    btn.style.background = 'white';
                });

                if (document.queryCommandState('bold')) {
                    toolbar.querySelector('.rt-bold').style.background = '#e3f2fd';
                }
                if (document.queryCommandState('italic')) {
                    toolbar.querySelector('.rt-italic').style.background = '#e3f2fd';
                }
                if (document.queryCommandState('underline')) {
                    toolbar.querySelector('.rt-underline').style.background = '#e3f2fd';
                }
                // Heading-States prüfen
                const currentTag = document.queryCommandValue('formatBlock').toLowerCase();
                toolbar.querySelectorAll('.rt-h1, .rt-h2, .rt-h3, .rt-h4, .rt-p').forEach(btn => {
                    btn.style.background = 'white';
                });

                if (currentTag === 'h1') {
                    const h1Btn = toolbar.querySelector('.rt-h1');
                    if (h1Btn) h1Btn.style.background = '#e3f2fd';
                } else if (currentTag === 'h2') {
                    const h2Btn = toolbar.querySelector('.rt-h2');
                    if (h2Btn) h2Btn.style.background = '#e3f2fd';
                } else if (currentTag === 'h3') {
                    const h3Btn = toolbar.querySelector('.rt-h3');
                    if (h3Btn) h3Btn.style.background = '#e3f2fd';
                } else if (currentTag === 'h4') {
                    const h4Btn = toolbar.querySelector('.rt-h4');
                    if (h4Btn) h4Btn.style.background = '#e3f2fd';
                } else if (currentTag === 'p' || currentTag === 'div') {
                    const pBtn = toolbar.querySelector('.rt-p');
                    if (pBtn) pBtn.style.background = '#e3f2fd';
                }

                // Listen-States prüfen
                if (document.queryCommandState('insertUnorderedList')) {
                    toolbar.querySelector('.rt-ul').style.background = '#e3f2fd';
                }
                if (document.queryCommandState('insertOrderedList')) {
                    const olBtn = toolbar.querySelector('.rt-ol');
                    if (olBtn) olBtn.style.background = '#e3f2fd';
                }
            };

            editor.addEventListener('keyup', updateToolbarState);
            editor.addEventListener('mouseup', updateToolbarState);
        }

        // 3️⃣ RICH TEXT PROPERTY UPDATE FUNKTION
        // Füge diese neue globale Funktion hinzu:

        function updatePropertyFromRichText(key, htmlValue) {
            if (!selectedModule) return;

            selectedModule.properties[key] = htmlValue;

            // === SOFORTIGE CANVAS-SYNC ===
            const canvasElement = document.querySelector(`[data-module-id="${selectedModule.id}"]`);
            if (canvasElement && selectedModule.templateId === 'kerberos-hero-advanced-richtext') {
                
                if (key === 'titleContent') {
                    const canvasTitle = canvasElement.querySelector('.title-wrapper h1, .title-wrapper h2, .title-wrapper h3, .title-wrapper h4, .title-wrapper h5, .title-wrapper h6, .title-wrapper p');
                    if (canvasTitle) {
                        canvasTitle.innerHTML = htmlValue;
                        // Farbe aus Properties forcieren
                        const titleColor = selectedModule.properties.titleColor || '#FFFFFF';
                        const currentStyle = canvasTitle.getAttribute('style') || '';
                        const newStyle = currentStyle.replace(/color:\s*[^;]+;?/g, '') + `color: ${titleColor} !important;`;
                        canvasTitle.setAttribute('style', newStyle);
                    }
                } 
                
                else if (key === 'subtitleContent') {
                    const canvasSubtitle = canvasElement.querySelector('div[style*="font-family: var(--body-font"]');
                    if (canvasSubtitle) {
                        canvasSubtitle.innerHTML = htmlValue;
                        // Farbe aus Properties forcieren
                        const subtitleColor = selectedModule.properties.subtitleColor || '#FFFFFF';
                        const currentStyle = canvasSubtitle.getAttribute('style') || '';
                        const newStyle = currentStyle.replace(/color:\s*[^;]+;?/g, '') + `color: ${subtitleColor} !important;`;
                        canvasSubtitle.setAttribute('style', newStyle);
                    }
                } 
                
                else if (key === 'buttonText') {
                    const canvasButton = canvasElement.querySelector(`a.kerberos-btn-${selectedModule.id}`);
                    if (canvasButton) {
                        canvasButton.innerHTML = htmlValue;
                    }
                }
            }

            // === FARBEN NACH RICHTEXT-ÄNDERUNG SYNC ===
            setTimeout(() => {
                if (typeof window.syncAllRichTextColors === 'function') {
                    window.syncAllRichTextColors();
                }
            }, 100);

            // Live-Update mit Debouncing (reduzierte Häufigkeit)
            clearTimeout(window.richTextTimeout);
            window.richTextTimeout = setTimeout(() => {
                renderCanvasWithInteractivity();
                showNotification('✅ Text aktualisiert');
            }, 1000); // Längere Verzögerung
        }

        // === UNIVERSELLE RICHTEXT-FARB-SYNC FÜR ALLE FELDER ===
        window.syncAllRichTextColors = function() {
            if (!selectedModule) return;
            
            // Alle möglichen RichText-Farb-Properties finden
            const colorProperties = {};
            Object.keys(selectedModule.properties).forEach(key => {
                if (key.includes('Color') && !key.includes('Background') && !key.includes('Hover')) {
                    // Entsprechendes Content-Property finden
                    const contentKey = key.replace('Color', 'Content');
                    if (selectedModule.properties[contentKey] !== undefined) {
                        colorProperties[contentKey] = selectedModule.properties[key];
                    }
                }
            });
            
            // Canvas-Elemente aktualisieren
            const canvasElement = document.querySelector(`[data-module-id="${selectedModule.id}"]`);
            if (canvasElement) {
                Object.keys(colorProperties).forEach(contentKey => {
                    const color = colorProperties[contentKey];
                    
                    // Canvas-Element basierend auf Content-Type finden
                    let canvasTarget = null;
                    if (contentKey === 'titleContent') {
                        canvasTarget = canvasElement.querySelector('.title-wrapper h1, .title-wrapper h2, .title-wrapper h3, .title-wrapper h4, .title-wrapper h5, .title-wrapper h6, .title-wrapper p');
                    } else if (contentKey === 'subtitleContent') {
                        canvasTarget = canvasElement.querySelector('div[style*="font-family: var(--body-font"]');
                    } else if (contentKey === 'buttonText') {
                        canvasTarget = canvasElement.querySelector(`a.kerberos-btn-${selectedModule.id}`);
                    }
                    
                    if (canvasTarget) {
                        const style = canvasTarget.getAttribute('style') || '';
                        const newStyle = style.replace(/color:\s*[^;]+;?/g, '') + `color: ${color} !important;`;
                        canvasTarget.setAttribute('style', newStyle);
                    }
                });
            }
            
            // RichText-CSS für alle Editoren aktualisieren
            let css = document.getElementById('kerberos-richtext-color-fix');
            if (!css) {
                css = document.createElement('style');
                css.id = 'kerberos-richtext-color-fix';
                document.head.appendChild(css);
            }
            
            let cssRules = '';
            Object.keys(colorProperties).forEach(contentKey => {
                const color = colorProperties[contentKey];
                cssRules += `
                    .richtext-editor[data-property="${contentKey}"],
                    .richtext-editor[data-property="${contentKey}"] *,
                    .richtext-editor[data-property="${contentKey}"] h1,
                    .richtext-editor[data-property="${contentKey}"] h2,
                    .richtext-editor[data-property="${contentKey}"] h3,
                    .richtext-editor[data-property="${contentKey}"] h4,
                    .richtext-editor[data-property="${contentKey}"] p,
                    .richtext-editor[data-property="${contentKey}"] span,
                    .richtext-editor[data-property="${contentKey}"] div {
                        color: ${color} !important;
                    }
                    
                    /* Canvas-Container Sync */
                    .title-container h1,
                    .title-container h2, 
                    .title-container h3,
                    .title-container h4,
                    .title-container p,
                    .title-container span,
                    .title-container div {
                        color: inherit !important;
                        font-family: inherit !important;
                        font-size: inherit !important;
                        margin: 0 !important;
                    }
                `;
            });
            
            css.innerHTML = cssRules;
        };

        // Event-Listener für manuelle Hex-Eingaben
        document.addEventListener('input', (e) => {
            if (e.target.type === 'text' && 
                e.target.getAttribute('oninput') && 
                e.target.getAttribute('oninput').includes('Color') && 
                selectedModule) {
                
                setTimeout(() => {
                    window.syncAllRichTextColors();
                }, 100);
            }
        });

        // Event-Listener für Color-Picker
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('color-option') && selectedModule) {
                setTimeout(() => {
                    window.syncAllRichTextColors();
                }, 100);
            }
        });

        // Event-Listener für RichText-Toolbar
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('rt-btn')) {
                setTimeout(() => {
                    window.syncAllRichTextColors();
                }, 150);
            }
        });

        // Property aktualisieren mit Live-Vorschau
        let autoApplyTimeout = null;

        // Update-Status verwalten
        let updateStatus = 'idle'; // 'idle', 'pending', 'updating'

        function showUpdateStatus(status) {
            const statusElement = document.querySelector('.auto-update-status');
            if (!statusElement) return;

            switch (status) {
                case 'pending':
                    statusElement.innerHTML = '<span style="color: #ff9800;">⏳ Änderung erkannt...</span>';
                    break;
                case 'updating':
                    statusElement.innerHTML = '<span style="color: #2196f3;">🔄 Aktualisiere...</span>';
                    break;
                case 'updated':
                    statusElement.innerHTML = '<span style="color: #4caf50;">✅ Aktualisiert</span>';
                    setTimeout(() => {
                        if (statusElement) {
                            statusElement.innerHTML = '<span style="color: #1976d2;">⚡ Auto-Update aktiv</span>';
                        }
                    }, 2000);
                    break;
                default:
                    statusElement.innerHTML = '<span style="color: #1976d2;">⚡ Auto-Update aktiv</span>';
            }
        }

        // Hilfsfunktion: Bestimmt ob Property sofort aktualisiert werden soll
        function shouldUpdateImmediately(key) {
            const immediateKeys = [
                'title', 'subtitle', 'text', 'buttonText', 'description',
                'titleColor', 'textColor', 'backgroundColor', 'iconColor',
                'iconClass', 'buttonIcon', 'imageUrl'
            ];
            return immediateKeys.some(pattern => key.includes(pattern));
        }


        function updateSolutionsOverviewCSS(module, moduleElement) {
            const props = module.properties;

            // Entferne altes CSS
            const oldStyle = moduleElement.querySelector('.solutions-hover-style');
            if (oldStyle) oldStyle.remove();

            // Neues CSS mit maximaler Spezifität erstellen
            const newCSS = `
                .kerberos-module-${module.templateId} .solutions-card-${module.id}:hover {
                    background-color: ${props.hoverBackgroundColor} !important;
                    background: ${props.hoverBackgroundColor} !important;
                    transform: translateY(-8px) !important;
                    box-shadow: 0 12px 32px rgba(6,58,168,0.3) !important;
                }
                .kerberos-module-${module.templateId} .solutions-card-${module.id}:hover .solutions-title-${module.id} {
                    color: ${props.hoverTitleColor} !important;
                }
                .kerberos-module-${module.templateId} .solutions-card-${module.id}:hover .solutions-desc-${module.id} {
                    color: ${props.hoverDescriptionColor} !important;
                }
                section.kerberos-module-${module.templateId} a.solutions-card-${module.id}:hover h4.solutions-title-${module.id} {
                    color: ${props.hoverTitleColor} !important;
                }
                section.kerberos-module-${module.templateId} a.solutions-card-${module.id}:hover p.solutions-desc-${module.id} {
                    color: ${props.hoverDescriptionColor} !important;
                }
            `;

            // CSS als Style-Element einfügen
            const styleElement = document.createElement('style');
            styleElement.className = 'solutions-hover-style';
            styleElement.textContent = newCSS;
            moduleElement.appendChild(styleElement);
        }


        // ===== UNIVERSELLE HOVER-SYSTEM =====
        function applyUniversalHover(module, moduleElement) {
            if (!module || !moduleElement) return;
            
            const props = module.properties;
            
            // Entferne alte Hover-Styles
            const oldHoverStyle = moduleElement.querySelector('.universal-hover-style');
            if (oldHoverStyle) oldHoverStyle.remove();
            
            // Nur anwenden wenn Hover aktiviert ist
            if (props.enableHover === 'false') return;
            
            // Hover-Werte mit Fallbacks
            const hoverTransform = props.hoverTransform || 'translateY(-4px)';
            const hoverShadow = props.hoverShadow || '0 8px 24px rgba(6,58,168,0.15)';
            const hoverBackground = props.hoverBackground || 'rgba(6,58,168,0.05)';
            const hoverDuration = props.hoverDuration || '0.3s';
            
            // Cursor nur bei echten Links setzen
            const cursorRule = `
                .module-${module.id} a {
                    cursor: pointer !important;
                }
                .module-${module.id} button {
                    cursor: pointer !important;
                }
                .module-${module.id} [onclick] {
                    cursor: pointer !important;
                }
            `;
            
            // Generiere universelle Hover-CSS
            const hoverCSS = `
                /* Universelle Transitions für alle hover-fähigen Elemente */
                .module-${module.id} .hover-element,
                .module-${module.id} .stat-item,
                .module-${module.id} .kerberos-stat-card,
                .module-${module.id} .feature-card,
                .module-${module.id} .product-card,
                .module-${module.id} .card,
                .module-${module.id} .timeline-step,
                .module-${module.id} .testimonial-card {
                    transition: all ${hoverDuration} ease !important;
                }
                
                /* Hover-Effekte NUR für Elemente OHNE Links */
                .module-${module.id} .hover-element:hover:not(a):not([href]),
                .module-${module.id} .stat-item:hover:not(a):not([href]),
                .module-${module.id} .kerberos-stat-card:hover:not(a):not([href]),
                .module-${module.id} .feature-card:hover:not(a):not([href]),
                .module-${module.id} .product-card:hover:not(a):not([href]),
                .module-${module.id} .card:hover:not(a):not([href]),
                .module-${module.id} .timeline-step:hover:not(a):not([href]),
                .module-${module.id} .testimonial-card:hover:not(a):not([href]) {
                    transform: ${hoverTransform} !important;
                    box-shadow: ${hoverShadow} !important;
                    background: ${hoverBackground} !important;
                }
                
                /* Hover-Effekte für Link-Elemente */
                .module-${module.id} a.hover-element:hover,
                .module-${module.id} a.stat-item:hover,
                .module-${module.id} a.kerberos-stat-card:hover,
                .module-${module.id} a.feature-card:hover,
                .module-${module.id} a.product-card:hover,
                .module-${module.id} a.card:hover,
                .module-${module.id} a.timeline-step:hover,
                .module-${module.id} a.testimonial-card:hover {
                    transform: ${hoverTransform} !important;
                    box-shadow: ${hoverShadow} !important;
                    background: ${hoverBackground} !important;
                }
                
                ${cursorRule}
            `;
            
            // CSS als Style-Element einfügen
            const styleElement = document.createElement('style');
            styleElement.className = 'universal-hover-style';
            styleElement.textContent = hoverCSS;
            moduleElement.appendChild(styleElement);
            
            console.log('✅ Universelle Hover-Effekte angewendet für:', module.id);
        }


        // ===== VOLLSTÄNDIGE updatePropertyLive() FUNKTION =====
        function updatePropertyLive(key, value) {
            if (!selectedModule) return;

            const moduleElement = document.querySelector(`[data-module-id="${selectedModule.id}"] .module-content`);
            if (!moduleElement) return;

            try {
                // ===== 1. NEUE TYPE-BASIERTE UPDATES (HÖCHSTE PRIORITÄT) =====
                
                // Size-Updates
                if (key.includes('SizeType')) {
                    const sizeMapping = getSizeOptions(key);
                    const actualValue = sizeMapping[value] || value;
                    
                    if (key.includes('icon')) {
                        const icons = moduleElement.querySelectorAll('[style*="font-family: \'Font Awesome"]');
                        icons.forEach(icon => {
                            icon.style.fontSize = actualValue;
                        });
                    } else if (key.includes('title')) {
                        const titles = moduleElement.querySelectorAll('h1, h2, h3, h4, h5, h6');
                        titles.forEach(title => {
                            title.style.fontSize = actualValue;
                        });
                    } else if (key.includes('button')) {
                        const buttons = moduleElement.querySelectorAll('a[style*="padding"], button');
                        buttons.forEach(button => {
                            if (key.includes('navButton')) {
                                button.style.width = actualValue;
                                button.style.height = actualValue;
                            } else {
                                button.style.fontSize = actualValue;
                            }
                        });
                    }
                    return;
                }
                
                // Spacing-Updates
                if (key.includes('PaddingType') || key.includes('SpacingType')) {
                    const spacingMapping = getSpacingOptions(key);
                    const actualValue = spacingMapping[value] || value;
                    
                    if (key.includes('section')) {
                        moduleElement.style.padding = actualValue;
                    } else if (key.includes('Padding')) {
                        const elements = moduleElement.querySelectorAll('a, button, .card, .container');
                        elements.forEach(el => {
                            el.style.padding = actualValue;
                        });
                    }
                    return;
                }
                
                // Radius-Updates
                if (key.includes('RadiusType')) {
                    const radiusMapping = getRadiusOptions();
                    const actualValue = radiusMapping[value] || value;
                    
                    const elements = moduleElement.querySelectorAll('.card, a, button, img, div[style*="border-radius"]');
                    elements.forEach(el => {
                        el.style.borderRadius = actualValue;
                    });
                    return;
                }
                
                // Shadow-Updates
                if (key.includes('ShadowType')) {
                    const shadowMapping = getShadowOptions();
                    const actualValue = shadowMapping[value] || value;
                    
                    const elements = moduleElement.querySelectorAll('.card, a, button, img');
                    elements.forEach(el => {
                        el.style.boxShadow = actualValue;
                    });
                    return;
                }
                
                // Transform-Updates (für Hover-Previews)
                if (key.includes('TransformType')) {
                    const transformMapping = getTransformOptions();
                    const actualValue = transformMapping[value] || value;
                    
                    // Update CSS Custom Properties für Hover-Effekte
                    moduleElement.style.setProperty('--hover-transform', actualValue);
                    return;
                }

                // Product Showcase Hover Update
                else if (module.templateId === 'kerberos-product-showcase' && key.includes('hover')) {
                    const style = moduleElement.querySelector('style.product-hover-style');
                    if (style) {
                        style.textContent = `
                            .product-card-${module.id}:hover {
                                background: ${props.hoverBackground || '#063AA8'} !important;
                            }
                            .product-card-${module.id}:hover * {
                                color: ${props.hoverTextColor || 'white'} !important;
                            }
                        `;
                    }
                }
                
                // Dimension-Updates
                if (key.includes('WidthType') || key.includes('HeightType')) {
                    const dimensionMapping = getDimensionOptions(key);
                    const actualValue = dimensionMapping[value] || value;
                    
                    if (key.includes('Width')) {
                        moduleElement.style.width = actualValue;
                    } else if (key.includes('Height')) {
                        moduleElement.style.height = actualValue;
                    }
                    return;
                }
                
                // Display-Updates
                if (key.includes('show') && key.includes('Type')) {
                    const displayMapping = getDisplayOptions();
                    const actualValue = displayMapping[value] || value;
                    
                    const targetElements = moduleElement.querySelectorAll(`[data-element="${key}"]`);
                    targetElements.forEach(el => {
                        el.style.display = actualValue;
                    });
                    return;
                }

                // ===== 2. STANDARD TEXT-UPDATES =====

                // Title-Updates
                if (key === 'title') {
                    const titleElements = moduleElement.querySelectorAll('h1, h2, h3, h4, h5, h6');
                    titleElements.forEach(el => {
                        if (el.textContent.includes(selectedModule.properties.title) || el.textContent.trim() !== '') {
                            el.textContent = value;
                        }
                    });
                    return;
                }

                // === SPACING UPDATES (VOLLSTÄNDIGE NEUGENERIERUNG) ===
                if (key === 'sectionSpacing' || key === 'verticalSpacing') {
                    // Bei Spacing-Änderungen komplettes Modul neu generieren
                    clearTimeout(autoApplyTimeout);
                    autoApplyTimeout = setTimeout(() => applyChanges(), 100);
                    return;
                }

                // ===== HERO ADVANCED RICH-TEXT SPEZIAL-UPDATES =====
                if (selectedModule.templateId === 'kerberos-hero-advanced-richtext') {
                    // RichText Content Updates mit Farb-Support
                    if (key === 'titleContent') {
                        const titleElement = moduleElement.querySelector('h1');
                        if (titleElement) {
                            titleElement.innerHTML = value;
                            // Farbe aus Properties anwenden
                            if (selectedModule.properties.titleColor) {
                                titleElement.style.color = selectedModule.properties.titleColor;
                            }
                        }
                        return;
                    }
                    
                    if (key === 'subtitleContent') {
                        const subtitleElement = moduleElement.querySelector('div[style*="font-family: var(--body-font"]');
                        if (subtitleElement) {
                            subtitleElement.innerHTML = value;
                            // Farbe aus Properties anwenden
                            if (selectedModule.properties.subtitleColor) {
                                subtitleElement.style.color = selectedModule.properties.subtitleColor;
                            }
                        }
                        return;
                    }
                    
                    if (key === 'buttonText') {
                        const buttonElement = moduleElement.querySelector(`a.kerberos-btn-${selectedModule.id}`);
                        if (buttonElement) {
                            buttonElement.innerHTML = value;
                        }
                        return;
                    }
                    
                    // Farb-Updates für Hero Advanced
                    if (key === 'titleColor') {
                        const titleElement = moduleElement.querySelector('h1');
                        if (titleElement) {
                            titleElement.style.color = value;
                        }
                        return;
                    }
                    
                    if (key === 'subtitleColor') {
                        const subtitleElement = moduleElement.querySelector('div[style*="font-family: var(--body-font"]');
                        if (subtitleElement) {
                            subtitleElement.style.color = value;
                        }
                        return;
                    }
                    
                    // Layout-Changes erfordern vollständiges Re-Render
                    if (key === 'layoutType' || key === 'sectionSpacing' || key === 'contentGap') {
                        clearTimeout(autoApplyTimeout);
                        autoApplyTimeout = setTimeout(() => applyChanges(), 100);
                        return;
                    }
                }

                // Button-Text Updates
                if (key === 'buttonText') {
                    const buttons = moduleElement.querySelectorAll('a[href], button');
                    buttons.forEach(btn => {
                        if (btn.textContent.trim() === selectedModule.properties.buttonText || btn.textContent.trim() !== '') {
                            btn.textContent = value;
                        }
                    });
                    return;
                }

                // Text-Content Updates
                if (key === 'text' || key === 'description' || key === 'subtitle') {
                    const paragraphs = moduleElement.querySelectorAll('p');
                    paragraphs.forEach(p => {
                        if (p.textContent.includes(selectedModule.properties[key]) || p.textContent.length > 20) {
                            p.textContent = value;
                        }
                    });
                    return;
                }

                // Timeline Live-Updates
                else if ((module.templateId === 'kerberos-process-timeline' || module.templateId === 'kerberos-process-timeline-fixed') && 
                        key.includes('step') && key.includes('Active')) {
                    // Timeline komplett neu rendern wenn Steps aktiviert/deaktiviert werden
                    clearTimeout(autoApplyTimeout);
                    autoApplyTimeout = setTimeout(() => {
                        applyChanges();
                    }, 100);
                    return;
                }

                // ===== 3. FARB-UPDATES =====
                
                if (key.includes('Color') || key.includes('color')) {
                    updateColorsLive(moduleElement, key, value);
                    return;
                }

                // ===== 4. ICON-UPDATES =====
                
                if (key.includes('Icon') || key.includes('icon')) {
                    const iconElements = moduleElement.querySelectorAll('[style*="Font Awesome"]');
                    iconElements.forEach(el => {
                        if (key === 'iconClass') {
                            el.innerHTML = value;
                        } else if (key === 'iconColor') {
                            el.style.color = value;
                        } else if (key === 'iconSize') {
                            el.style.fontSize = value;
                        }
                    });

                    // Fallback: Komplettes Modul neu rendern
                    const moduleContainer = document.getElementById(`module-${selectedModule.id}`);
                    if (moduleContainer) {
                        const template = MODULE_TEMPLATES.find(t => t.id === selectedModule.templateId);
                        if (template) {
                            moduleContainer.querySelector('.module-content').innerHTML = processModuleHTML(selectedModule);
                        }
                    }
                    return;
                }

                // ===== 5. BACKGROUND-UPDATES =====
                
                if (key === 'backgroundColor') {
                    const section = moduleElement.closest('.canvas-module').querySelector('section');
                    if (section) {
                        section.style.background = value;
                    }
                    return;
                }


                // ===== AUTOMATISCHE FEATURE-BREAKER UPDATES =====
                if (selectedModule.templateId === 'kerberos-feature-breaker') {
                    // Auto-Update für alle breaker-spezifischen Properties
                    if (key.includes('title') || key.includes('subtitle') || key.includes('description') || 
                        key.includes('button') || key.includes('pricing') || key.includes('countdown')) {
                        
                        // Komplettes Modul neu rendern für Feature Breaker
                        const moduleElement = document.getElementById(`module-${selectedModule.id}`);
                        if (moduleElement) {
                            const template = MODULE_TEMPLATES.find(t => t.id === selectedModule.templateId);
                            if (template) {
                                moduleElement.innerHTML = processUniversalModule(selectedModule, template.html);
                                console.log('🎯 Feature Breaker Auto-Update ausgeführt für:', key);
                            }
                        }
                        return;
                    }
                }

                // ===== 6. SPEZIELLE MODULE-UPDATES =====
                // ===== FAQ ACCORDION LIVE-UPDATES =====
                if (selectedModule.templateId === 'kerberos-faq-accordion') {
                    // FAQ Question Updates
                    if (key.includes('faq') && key.includes('Question')) {
                        const faqNumber = key.match(/faq(\d+)Question/)?.[1];
                        if (faqNumber) {
                            const faqItem = moduleElement.querySelector(`[data-faq-id="${faqNumber}"]`);
                            if (faqItem) {
                                const questionElement = faqItem.querySelector('.faq-header h3');
                                if (questionElement) {
                                    questionElement.textContent = value;
                                }
                            }
                        }
                        return;
                    }
                    
                    // FAQ Answer Updates
                    if (key.includes('faq') && key.includes('Answer')) {
                        const faqNumber = key.match(/faq(\d+)Answer/)?.[1];
                        if (faqNumber) {
                            const faqItem = moduleElement.querySelector(`[data-faq-id="${faqNumber}"]`);
                            if (faqItem) {
                                const answerElement = faqItem.querySelector('.faq-content > div');
                                if (answerElement) {
                                    answerElement.innerHTML = value; // innerHTML für HTML-Content
                                }
                            }
                        }
                        return;
                    }
                    
                    // FAQ Active Status Updates
                    if (key.includes('faq') && key.includes('Active')) {
                        const faqNumber = key.match(/faq(\d+)Active/)?.[1];
                        if (faqNumber) {
                            const faqItem = moduleElement.querySelector(`[data-faq-id="${faqNumber}"]`);
                            if (faqItem) {
                                if (value === 'true') {
                                    faqItem.style.display = 'block';
                                } else {
                                    faqItem.style.display = 'none';
                                }
                            }
                        }
                        return;
                    }
                    
                    // FAQ Border/Style Updates
                    if (key === 'borderColor') {
                        const faqItems = moduleElement.querySelectorAll('.kerberos-faq-item');
                        faqItems.forEach(item => {
                            item.style.borderColor = value;
                        });
                        return;
                    }
                    
                    if (key === 'cardBackground') {
                        const faqItems = moduleElement.querySelectorAll('.kerberos-faq-item');
                        faqItems.forEach(item => {
                            item.style.background = value;
                        });
                        return;
                    }
                    
                    if (key === 'hoverColor') {
                        const faqIcons = moduleElement.querySelectorAll('.faq-icon');
                        faqIcons.forEach(icon => {
                            icon.style.color = value;
                        });
                        return;
                    }
                }
                // SVG Hero Live Updates
                if (selectedModule.templateId === 'kerberos-svg-hero') {
                    if (key === 'svgType') {
                        // Komplettes Modul neu rendern bei Typ-Wechsel
                        const moduleElement = document.getElementById(`module-${selectedModule.id}`);
                        if (moduleElement) {
                            const template = MODULE_TEMPLATES.find(t => t.id === selectedModule.templateId);
                            if (template) {
                                moduleElement.innerHTML = processUniversalModule(selectedModule, template.html);
                            }
                        }
                        return;
                    }
                    
                    if (key === 'svgUrl') {
                        const svgEl = moduleElement.querySelector('.hero-svg');
                        if (svgEl && selectedModule.properties.svgType === 'url') svgEl.src = value;
                        return;
                    }
                    
                    if (key === 'svgCode' || key === 'svgColor') {
                        if (selectedModule.properties.svgType === 'code') {
                            // Komplettes Modul neu rendern
                            const moduleElement = document.getElementById(`module-${selectedModule.id}`);
                            if (moduleElement) {
                                const template = MODULE_TEMPLATES.find(t => t.id === selectedModule.templateId);
                                if (template) {
                                    moduleElement.innerHTML = processUniversalModule(selectedModule, template.html);
                                }
                            }
                        }
                        return;
                    }
                    
                    if (key === 'svgWidth' || key === 'svgHeight') {
                        const svgEl = moduleElement.querySelector('.hero-svg');
                        if (svgEl) {
                            if (key === 'svgWidth') svgEl.style.width = value;
                            if (key === 'svgHeight') svgEl.style.height = value;
                        }
                        return;
                    }
                    
                    if (key === 'svgOpacity') {
                        const svgEl = moduleElement.querySelector('.hero-svg');
                        if (svgEl) svgEl.style.opacity = value;
                        return;
                    }
                    
                    if (key === 'buttonBg') {
                        const btnEl = moduleElement.querySelector('.kerberos-btn');
                        if (btnEl) btnEl.style.background = value;
                        return;
                    }
                    
                    // Für toggles - komplettes Modul neu rendern
                    if (key === 'showSvg' || key === 'showSubtitle' || key === 'showButton') {
                        const template = MODULE_TEMPLATES.find(t => t.id === selectedModule.templateId);
                        if (template) {
                            moduleElement.innerHTML = processUniversalModule(selectedModule, template.html);
                        }
                        return;
                    }
                }

                // Feature Breaker Live Updates
                if (moduleElement.classList.contains('kerberos-module-kerberos-feature-breaker')) {
                    if (key === 'primaryButtonText') {
                        const btnEl = moduleElement.querySelector('.breaker-btn-primary');
                        if (btnEl) {
                            const iconHtml = btnEl.querySelector('span') ? btnEl.querySelector('span').outerHTML : '';
                            btnEl.innerHTML = value + ' ' + iconHtml;
                        }
                        return;
                    }
                    
                    if (key === 'badgeText' && value) {
                        const badgeEl = moduleElement.querySelector('.breaker-badge');
                        if (badgeEl) badgeEl.textContent = value;
                        return;
                    }
                    
                    if (key === 'showBadge') {
                        const badgeEl = moduleElement.querySelector('.breaker-badge');
                        if (badgeEl) badgeEl.style.display = value === 'true' ? 'block' : 'none';
                        return;
                    }
                    
                    if (key === 'showSecondaryButton') {
                        const btnEl = moduleElement.querySelector('.breaker-btn-secondary');
                        if (btnEl) btnEl.style.display = value === 'true' ? 'inline-flex' : 'none';
                        return;
                    }
                    
                    if (key === 'showIcon') {
                        const iconEl = moduleElement.querySelector('.breaker-icon');
                        if (iconEl) iconEl.style.display = value === 'true' ? 'block' : 'none';
                        return;
                    }
                    
                    if (key === 'countdownActive') {
                        const countdownEl = moduleElement.querySelector('.breaker-countdown');
                        if (countdownEl) countdownEl.style.display = value === 'true' ? 'block' : 'none';
                        return;
                    }
                    
                    if (key === 'showPricing') {
                        const pricingEl = moduleElement.querySelector('.breaker-pricing');
                        if (pricingEl) pricingEl.style.display = value === 'true' ? 'block' : 'none';
                        return;
                    }
                }

                // Company Presentation Live Updates
                if (key.startsWith('stat') && key.includes('Value')) {
                    const statNumber = key.match(/stat(\d+)Value/)[1];
                    const statElements = moduleElement.querySelectorAll(`div[style*="font-size: 1.4rem"]`);
                    if (statElements[statNumber - 1]) {
                        statElements[statNumber - 1].textContent = value;
                    }
                    return;
                }
                
                if (key.startsWith('stat') && key.includes('Description')) {
                    const statNumber = key.match(/stat(\d+)Description/)[1];
                    const descElements = moduleElement.querySelectorAll(`div[style*="font-size: 0.9rem"]`);
                    if (descElements[statNumber - 1]) {
                        descElements[statNumber - 1].textContent = value;
                    }
                    return;
                }
                
                if (key === 'shapeColor') {
                    const shapeElement = moduleElement.querySelector('[style*="height: 300px"]');
                    if (shapeElement) {
                        shapeElement.style.background = value;
                    }
                    return;
                }

                // Timeline Spacing Updates
                if (key === 'timelineSpacing') {
                    const wrappers = moduleElement.querySelectorAll('.timeline-wrapper-' + module.id);
                    wrappers.forEach((wrapper, index) => {
                        if (index > 0) { // Nicht der erste
                            wrapper.style.marginTop = value;
                        }
                    });
                    return;
                }

             
                // FAQ-Module: Reaktiviere Interaktivität nach kritischen Updates
                if (selectedModule.templateId === 'kerberos-faq-accordion' && 
                    (key.includes('faq') && key.includes('Active'))) {
                    // Warte kurz, dann reaktiviere FAQ-Klicks
                    setTimeout(() => {
                        console.log('🔄 Reaktiviere FAQ-Interaktivität nach Update...');
                        
                        // Nur die FAQ-Interaktivität reaktivieren
                        const faqItems = moduleElement.querySelectorAll('.kerberos-faq-item');
                        faqItems.forEach(item => {
                            const header = item.querySelector('.faq-header');
                            const content = item.querySelector('.faq-content');
                            const icon = item.querySelector('.faq-icon');

                            if (header && content && icon) {
                                // Entferne alte Event-Listener
                                const newHeader = header.cloneNode(true);
                                header.parentNode.replaceChild(newHeader, header);
                                
                                // Neue Referenzen
                                const newContent = item.querySelector('.faq-content');
                                const newIcon = item.querySelector('.faq-icon');

                                newHeader.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    
                                    const isOpen = newContent.style.maxHeight && newContent.style.maxHeight !== '0px';
                                    
                                    // Schließe alle anderen FAQs
                                    item.parentElement.querySelectorAll('.kerberos-faq-item').forEach(otherItem => {
                                        if (otherItem !== item) {
                                            const otherContent = otherItem.querySelector('.faq-content');
                                            const otherIcon = otherItem.querySelector('.faq-icon');
                                            if (otherContent && otherIcon) {
                                                otherContent.style.maxHeight = '0px';
                                                otherIcon.style.transform = 'rotate(0deg)';
                                                otherIcon.innerHTML = '&#xf067;';
                                                otherItem.style.background = '#FFFFFF';
                                            }
                                        }
                                    });
                                    
                                    // Toggle aktuelles FAQ
                                    if (!isOpen) {
                                        newContent.style.maxHeight = newContent.scrollHeight + 'px';
                                        newIcon.style.transform = 'rotate(45deg)';
                                        newIcon.innerHTML = '&#xf068;';
                                        item.style.background = 'rgba(6,58,168,0.02)';
                                    } else {
                                        newContent.style.maxHeight = '0px';
                                        newIcon.style.transform = 'rotate(0deg)';
                                        newIcon.innerHTML = '&#xf067;';
                                        item.style.background = '#FFFFFF';
                                    }
                                });
                            }
                        });
                    }, 50);
                    return;
                }

                // ===== 7. KOMPLEXE MODULE-UPDATES (FALLBACK) =====

                // Stats Module
                if (selectedModule.templateId === 'kerberos-warning-facts' &&
                    (key.startsWith('fact') && (key.includes('Number') || key.includes('Description') || key.includes('Active')))) {
                    // Facts geändert - komplettes Modul neu rendern
                    const moduleElement = document.getElementById(`module-${selectedModule.id}`);
                    if (moduleElement) {
                        const template = MODULE_TEMPLATES.find(t => t.id === selectedModule.templateId);
                        if (template) {
                            moduleElement.innerHTML = processUniversalModule(selectedModule, template.html);
                        }
                    }
                    return;
                }

                // Testimonials Updates
                if (key.includes('testimonial')) {
                    const module = modules.find(m => m.id === moduleId);
                    if (module && (module.templateId === 'kerberos-testimonials-carousel' || module.templateId === 'kerberos-testimonials-pro')) {
                        setTimeout(() => {
                            initializeTestimonialsCarousels();
                        }, 100);
                    }
                    return;
                }

                // Image Updates (Trigger vollständiges Re-Render)
                if (key === 'imageUrl') {
                    applyChanges();
                    return;
                }

                // ===== 8. FALLBACK FÜR KOMPLEXE MODULE =====
                
                if (updateComplexModuleLive(selectedModule.id, key, value)) {
                    // Erfolgreich mit speziellem Handler behandelt
                    return;
                }

            } catch (error) {
                console.warn('Live-Update fehlgeschlagen, fallback zu vollständigem Update:', error);
                // Fallback zu komplettem Update
                clearTimeout(autoApplyTimeout);
                autoApplyTimeout = setTimeout(() => applyChanges(), 100);
            }
        }

        // Spezielle Live-Updates für komplexe Module
        function updateComplexModuleLive(moduleId, key, value) {
            const module = modules.find(m => m.id === moduleId);
            if (!module) return false;

            // Team Gallery Live-Updates
            if (module.templateId === 'kerberos-team-gallery') {
                return updateTeamGalleryLive(moduleId, key, value);
            }

            // Stats Module Live-Updates
            if (module.templateId === 'kerberos-stats') {
                return updateStatsModuleLive(moduleId, key, value);
            }

            // Hero Advanced Rich-Text Live-Updates
            if (module.templateId === 'kerberos-hero-advanced-richtext') {
                return updateHeroAdvancedRichtextLive(moduleId, key, value);
            }
            return false; // Kein spezielles Handling gefunden
        }



        // Live-Updates für Hero Advanced Rich-Text
        function updateHeroAdvancedRichtextLive(moduleId, key, value) {
            const moduleElement = document.querySelector(`[data-module-id="${moduleId}"] .module-content`);
            if (!moduleElement) return false;

            try {
                // Title Content Updates
                if (key === 'titleContent') {
                    const titleElement = moduleElement.querySelector('h1');
                    if (titleElement) {
                        titleElement.innerHTML = value;
                        return true;
                    }
                }

                // Title Color Updates
                if (key === 'titleColor') {
                    const titleElement = moduleElement.querySelector('h1');
                    if (titleElement) {
                        titleElement.style.color = value;
                        return true;
                    }
                }

                // Subtitle Content Updates
                if (key === 'subtitleContent') {
                    const subtitleElement = moduleElement.querySelector('h2');
                    if (subtitleElement) {
                        subtitleElement.innerHTML = value;
                        return true;
                    }
                }

                // Subtitle Color Updates
                if (key === 'subtitleColor') {
                    const subtitleElement = moduleElement.querySelector('h2');
                    if (subtitleElement) {
                        subtitleElement.style.color = value;
                        return true;
                    }
                }

                // Button Text Updates
                if (key === 'buttonText') {
                    const buttonElement = moduleElement.querySelector(`a.kerberos-btn-${moduleId}`);
                    if (buttonElement) {
                        buttonElement.textContent = value;
                        return true;
                    }
                }

                // Button Link Updates
                if (key === 'buttonLink') {
                    const buttonElement = moduleElement.querySelector(`a.kerberos-btn-${moduleId}`);
                    if (buttonElement) {
                        buttonElement.href = value;
                        return true;
                    }
                }

                // Background Color Updates
                if (key === 'backgroundColor') {
                    const sectionElement = moduleElement.closest('section');
                    if (sectionElement) {
                        sectionElement.style.backgroundColor = value;
                        return true;
                    }
                }

                // Image URL Updates
                if (key === 'imageUrl') {
                    const imageElement = moduleElement.querySelector('img');
                    if (imageElement) {
                        imageElement.src = value;
                        return true;
                    }
                }

                // Complex updates - force full re-render for layout changes
                if (key === 'layoutType' || key === 'sectionSpacing' || key === 'contentGap') {
                    return false; // Fallback zu vollständigem Update
                }

            } catch (error) {
                console.warn('Hero Advanced Rich-Text Live-Update fehlgeschlagen:', error);
                return false;
            }

            return false;
        }

        // Live-Updates für Team Gallery
        function updateTeamGalleryLive(moduleId, key, value) {
            const moduleElement = document.querySelector(`[data-module-id="${moduleId}"] .module-content`);
            if (!moduleElement) return false;

            // Member Name Updates
            if (key.startsWith('member') && key.includes('Name')) {
                const memberIndex = key.match(/member(\d+)/)[1];
                const nameElement = moduleElement.querySelector(`h4:nth-of-type(${memberIndex})`);
                if (nameElement) {
                    nameElement.textContent = value;
                    return true;
                }
            }

            // Member Position Updates
            if (key.startsWith('member') && key.includes('Position')) {
                const memberIndex = key.match(/member(\d+)/)[1];
                const positionElements = moduleElement.querySelectorAll('p[style*="font-weight: 600"]');
                if (positionElements[memberIndex - 1]) {
                    positionElements[memberIndex - 1].textContent = value;
                    return true;
                }
            }

            return false;
        }

        // Live-Updates für Stats Module
        function updateStatsModuleLive(moduleId, key, value) {
            const moduleElement = document.querySelector(`[data-module-id="${moduleId}"] .module-content`);
            if (!moduleElement) return false;

            // Statistik Number Updates
            if (key.includes('Number')) {
                const statIndex = key.match(/stat(\d+)/)?.[1];
                if (statIndex) {
                    const numberElements = moduleElement.querySelectorAll('[style*="font-size"][style*="font-weight: 700"]');
                    if (numberElements[statIndex - 1]) {
                        numberElements[statIndex - 1].textContent = value;
                        return true;
                    }
                }
            }

            return false;
        }

        // Live Farb-Updates
        function updateColorsLive(moduleElement, key, value) {
            const colorMappings = {
                'titleColor': 'h1, h2, h3, h4, h5, h6',
                'textColor': 'p:not([style*="font-weight: 600"])',
                'subtitleColor': 'p:not([style*="font-weight: 600"]), .subtitle',
                'buttonBgColor': 'a[href], button',
                'buttonTextColor': 'a[href], button',
                'iconColor': '[style*="Font Awesome"], .faq-icon',
                'hoverColor': '.faq-icon',
                'nameColor': 'h4',
                'positionColor': 'p[style*="font-weight: 600"]',
                'descriptionColor': 'p:not([style*="font-weight: 600"])',
                'borderColor': '.kerberos-faq-item',
                'cardBackground': '.kerberos-faq-item'
            };

            const selector = colorMappings[key];
            if (selector) {
                const elements = moduleElement.querySelectorAll(selector);
                elements.forEach(el => {
                    if (key.includes('Bg') || key.includes('background') || key.includes('Background')) {
                        el.style.backgroundColor = value;
                        el.style.background = value;
                    } else if (key === 'borderColor') {
                        el.style.borderColor = value;
                    } else {
                        el.style.color = value;
                    }
                });
            }
        }

        // Live Icon-Updates
        function updateIconsLive(moduleElement, key, value) {
            const iconElements = moduleElement.querySelectorAll('[style*="Font Awesome"]');
            iconElements.forEach(el => {
                if (el.textContent.includes('&#x') || el.innerHTML.includes('&#x')) {
                    el.innerHTML = value;
                }
            });
        }



        function highlightChangedElement(property) {
            const moduleElement = document.querySelector(`[data-module-id="${selectedModule.id}"] .module-content`);
            if (!moduleElement) return;

            // Highlight das geänderte Element
            const elements = moduleElement.querySelectorAll('*');
            elements.forEach(el => {
                if (el.style.color === selectedModule.properties[property] ||
                    el.textContent.includes(selectedModule.properties[property])) {
                    el.style.transition = 'all 0.3s ease';
                    el.style.outline = '2px solid #009CE6';
                    el.style.outlineOffset = '2px';

                    setTimeout(() => {
                        el.style.outline = 'none';
                    }, 2000);
                }
            });
        }

        // NEUE RESET-FUNKTION
        function forceResetModuleSelection() {
            console.log('🔧 Force Reset: Modulauswahl zurücksetzen');

            // Variable zurücksetzen
            selectedModule = null;

            // Alle möglichen Module-Elemente zurücksetzen
            const selectors = [
                '.canvas-module', '[data-module-id]', '.selected', '.module-item',
                '.kerberos-module', '.active', '[id*="module"]'
            ];

            selectors.forEach(selector => {
                document.querySelectorAll(selector).forEach(element => {
                    element.classList.remove('selected', 'active');
                    element.style.border = '';
                    element.style.boxShadow = '';
                    element.style.background = '';
                    element.style.zIndex = '';
                    element.style.position = '';
                });
            });

            // Property Panel zurücksetzen
            renderPropertyPanel();

            // Canvas neu rendern
            setTimeout(() => {
                renderCanvas();
            }, 100);

            showNotification('🔧 Module-Auswahl zurückgesetzt');
        }

        // Hotkeys für Reset hinzufügen
        document.addEventListener('keydown', function (e) {
            // Strg + Shift + Escape = Force Reset
            if (e.ctrlKey && e.shiftKey && e.key === 'Escape') {
                e.preventDefault();
                forceResetModuleSelection();
            }

            // Strg + R = Sanfter Reset (nur wenn nicht in Input-Feld)
            if (e.ctrlKey && e.key === 'r' &&
                e.target.tagName !== 'INPUT' &&
                e.target.tagName !== 'TEXTAREA' &&
                !e.target.contentEditable) {
                e.preventDefault();
                selectedModule = null;
                renderPropertyPanel();
                showNotification('🔧 Module-Auswahl gelöst');
            }
        });

        // Globale Funktionen
        window.selectModule = selectModule;
        window.forceResetModuleSelection = forceResetModuleSelection;
        window.applyPlanTemplate = applyPlanTemplate;
        window.copyFromPlan = copyFromPlan;
        window.switchPropertyTab = switchPropertyTab;
        window.groupPropertiesByContext = groupPropertiesByContext;
        window.renderPlanQuickSetup = renderPlanQuickSetup;
        window.highlightChangedElement = highlightChangedElement;

        // Seite speichern
        // Template-Validierung
        function validateTemplate(template) {
            if (!template || typeof template !== 'object') return false;
            if (!template.id || typeof template.id !== 'string') return false;
            if (!template.name) template.name = 'Unbenanntes Modul';
            if (!template.category) template.category = 'Custom';
            if (!template.html) template.html = '<div>Standard HTML</div>';
            if (!template.properties) template.properties = {};
            return true;
        }

        // DEBUG: Template-Status prüfen
        console.log('MODULE_TEMPLATES Status:', {
            exists: typeof MODULE_TEMPLATES !== 'undefined',
            isArray: Array.isArray(MODULE_TEMPLATES),
            length: MODULE_TEMPLATES ? MODULE_TEMPLATES.length : 'N/A',
            type: typeof MODULE_TEMPLATES
        });


        function generateHtmlFromProperties(moduleData) {
            // Standard-HTML für Benefits-Module
            if (moduleData.templateId === 'kerberos-benefits') {
                // Template mit Platzhaltern erstellen
                let benefitsTemplate = '<section data-style="BENEFITS_SECTION_STYLES"><div data-style="BENEFITS_CONTAINER_STYLES"><div data-style="BENEFITS_HEADER_STYLES"><h2 data-style="BENEFITS_TITLE_STYLES">{{title}}</h2><p data-style="BENEFITS_SUBTITLE_STYLES">{{subtitle}}</p></div><div data-style="BENEFITS_GRID_STYLES">{{benefitItems}}</div></div></section>';

                // CSS separat für jedes Element definieren
                const benefitsSectionStyles = [
                    'padding: {{sectionSpacing}}',
                    'background: {{backgroundColor}}'
                ].join('; ');

                const benefitsContainerStyles = [
                    'max-width: 1200px',
                    'margin: 0 auto',
                    'padding: 0 2rem'
                ].join('; ');

                const benefitsHeaderStyles = [
                    'text-align: center',
                    'margin-bottom: {{titleSpacing}}'
                ].join('; ');

                const benefitsTitleStyles = [
                    'font-family: var(--heading-font-font-family)',
                    'font-size: var(--heading-2-size)',
                    'font-weight: var(--heading-font-font-weight)',
                    'line-height: var(--heading-font-line-height)',
                    'color: {{titleColor}}',
                    'margin: 0'
                ].join('; ');

                const benefitsSubtitleStyles = [
                    'font-family: var(--body-font-font-family)',
                    'font-size: var(--normal-text-size)',
                    'line-height: var(--body-font-line-height)',
                    'color: {{subtitleColor}}',
                    'margin: 1rem 0 0 0'
                ].join('; ');

                const benefitsGridStyles = [
                    'display: grid',
                    'grid-template-columns: repeat(auto-fit, minmax({{benefitMinWidth}}, 1fr))',
                    'gap: {{benefitsGap}}'
                ].join('; ');

                // Alle Replace-Operationen
                benefitsTemplate = benefitsTemplate.replace('data-style="BENEFITS_SECTION_STYLES"', 'style="' + benefitsSectionStyles + '"');
                benefitsTemplate = benefitsTemplate.replace('data-style="BENEFITS_CONTAINER_STYLES"', 'style="' + benefitsContainerStyles + '"');
                benefitsTemplate = benefitsTemplate.replace('data-style="BENEFITS_HEADER_STYLES"', 'style="' + benefitsHeaderStyles + '"');
                benefitsTemplate = benefitsTemplate.replace('data-style="BENEFITS_TITLE_STYLES"', 'style="' + benefitsTitleStyles + '"');
                benefitsTemplate = benefitsTemplate.replace('data-style="BENEFITS_SUBTITLE_STYLES"', 'style="' + benefitsSubtitleStyles + '"');
                benefitsTemplate = benefitsTemplate.replace('data-style="BENEFITS_GRID_STYLES"', 'style="' + benefitsGridStyles + '"');

                return benefitsTemplate;
            }

            // Fallback für andere Module
            let fallbackTemplate = '<section data-style="FALLBACK_SECTION_STYLES"><div data-style="FALLBACK_CONTAINER_STYLES"><h2 data-style="FALLBACK_TITLE_STYLES">{{title}}</h2><p data-style="FALLBACK_TEXT_STYLES">{{text}}</p></div></section>';

            // CSS für Fallback-Template
            const fallbackSectionStyles = [
                'padding: {{sectionSpacing}}',
                'background: {{backgroundColor}}'
            ].join('; ');

            const fallbackContainerStyles = [
                'max-width: 1200px',
                'margin: 0 auto',
                'padding: 0 2rem'
            ].join('; ');

            const fallbackTitleStyles = [
                'color: {{titleColor}}'
            ].join('; ');

            const fallbackTextStyles = [
                'color: {{textColor}}'
            ].join('; ');

            // Replace-Operationen für Fallback
            fallbackTemplate = fallbackTemplate.replace('data-style="FALLBACK_SECTION_STYLES"', 'style="' + fallbackSectionStyles + '"');
            fallbackTemplate = fallbackTemplate.replace('data-style="FALLBACK_CONTAINER_STYLES"', 'style="' + fallbackContainerStyles + '"');
            fallbackTemplate = fallbackTemplate.replace('data-style="FALLBACK_TITLE_STYLES"', 'style="' + fallbackTitleStyles + '"');
            fallbackTemplate = fallbackTemplate.replace('data-style="FALLBACK_TEXT_STYLES"', 'style="' + fallbackTextStyles + '"');

            return fallbackTemplate;
        }

        function updateExportButtons() {
            const btn = document.getElementById('exportSelectedBtn');
            if (selectedModule) {
                btn.disabled = false;
                btn.textContent = '🔧 "' + selectedModule.name + '" exportieren';
            } else {
                btn.disabled = true;
                btn.textContent = '🔧 Ausgewähltes Modul exportieren';
            }
        }

        // Spacing/Ratio System
        function showSettingsModal() {
            document.getElementById('settingsModal').style.display = 'block';
            loadSpacingSettings();
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // === MODULE-BIBLIOTHEK VERWALTUNG ===

        function closeModuleLibraryModal() {
            document.getElementById('moduleLibraryModal').style.display = 'none';
        }

        // 🆕 BULK EDIT MODAL - HIER EINFÜGEN:
        function showBulkEditModal() {
            const modal = document.createElement('div');
            modal.id = 'bulkEditModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="color: #063AA8; margin: 0 0 1.5rem 0;">🔧 Bulk-Bearbeitung</h3>
                        
                        <div style="margin-bottom: 2rem; padding: 1rem; background: #F8F9FA; border-radius: 6px;">
                            <h4 style="margin: 0 0 1rem 0; font-size: 1rem;">💰 Preise anpassen</h4>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Alle Preise mit Faktor multiplizieren:</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" id="priceMultiplier" step="0.1" value="1.0" style="flex: 1; padding: 0.5rem; border: 1px solid #DEE2E6; border-radius: 4px;">
                                <button onclick="applyBulkPriceChange()" class="btn btn-primary">✓ Anwenden</button>
                            </div>
                            <small style="color: #6c757d;">Beispiel: 1.1 = +10%, 0.9 = -10%</small>
                        </div>
                        
                        <div style="margin-bottom: 2rem; padding: 1rem; background: #F8F9FA; border-radius: 6px;">
                            <h4 style="margin: 0 0 1rem 0; font-size: 1rem;">🎨 Farben ersetzen</h4>
                            <div style="display: grid; grid-template-columns: 1fr auto 1fr auto; gap: 0.5rem; align-items: center;">
                                <input type="text" id="oldColor" placeholder="Alte Farbe (z.B. #063AA8)" style="padding: 0.5rem; border: 1px solid #DEE2E6; border-radius: 4px;">
                                <span>→</span>
                                <input type="text" id="newColor" placeholder="Neue Farbe" style="padding: 0.5rem; border: 1px solid #DEE2E6; border-radius: 4px;">
                                <button onclick="applyBulkColorChange()" class="btn btn-primary">✓ Ersetzen</button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 2rem; padding: 1rem; background: #F8F9FA; border-radius: 6px;">
                            <h4 style="margin: 0 0 1rem 0; font-size: 1rem;">📝 Text ersetzen</h4>
                            <div style="display: grid; grid-template-columns: 1fr auto 1fr auto; gap: 0.5rem; align-items: center;">
                                <input type="text" id="oldText" placeholder="Alter Text" style="padding: 0.5rem; border: 1px solid #DEE2E6; border-radius: 4px;">
                                <span>→</span>
                                <input type="text" id="newText" placeholder="Neuer Text" style="padding: 0.5rem; border: 1px solid #DEE2E6; border-radius: 4px;">
                                <button onclick="applyBulkTextChange()" class="btn btn-primary">✓ Ersetzen</button>
                            </div>
                        </div>
                        
                        <div style="text-align: right; border-top: 1px solid #DEE2E6; padding-top: 1rem;">
                            <button onclick="closeBulkEditModal()" class="btn btn-secondary">Schließen</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeBulkEditModal();
                }
            });
        }

        function closeBulkEditModal() {
            const modal = document.getElementById('bulkEditModal');
            if (modal) {
                modal.remove();
            }
        }

        function applyBulkPriceChange() {
            const multiplier = parseFloat(document.getElementById('priceMultiplier').value);
            if (!multiplier || !selectedModule) return;

            let changedCount = 0;
            Object.keys(selectedModule.properties).forEach(key => {
                if (key.includes('Price') || key.includes('price')) {
                    const currentValue = selectedModule.properties[key];
                    // Extract number from price string (e.g., "€299" -> 299)
                    const match = currentValue.match(/[\d,.]+/);
                    if (match) {
                        const number = parseFloat(match[0].replace(',', ''));
                        const newNumber = Math.round(number * multiplier);
                        selectedModule.properties[key] = currentValue.replace(match[0], newNumber.toString());
                        changedCount++;
                    }
                }
            });

            if (changedCount > 0) {
                renderPropertyPanel();
                applyChanges();
                showNotification(`✅ ${changedCount} Preise aktualisiert (Faktor: ${multiplier})`);
                closeBulkEditModal();
            }
        }


        // Gelöschte Templates anzeigen und wiederherstellen
        function showDeletedTemplatesManager() {
            const deletedList = getDeletedTemplatesBlacklist();

            if (deletedList.length === 0) {
                showNotification('✅ Keine gelöschten Templates vorhanden');
                return;
            }

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 2500; display: flex; 
                align-items: center; justify-content: center;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 1rem 0; color: var(--kerberos-primary);">🗑️ Gelöschte Templates</h3>
                    <p style="color: #6c757d; margin-bottom: 1.5rem;">Diese Templates wurden gelöscht und können wiederhergestellt werden:</p>
                    
                    <div id="deletedTemplatesList" style="margin-bottom: 1.5rem;">
                        ${deletedList.map(templateId => `
                            <div style="border: 1px solid #ddd; border-radius: 6px; padding: 1rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: var(--kerberos-primary);">${templateId}</strong>
                                    <br><small style="color: #999;">Gelöschtes Template</small>
                                </div>
                                <button onclick="restoreDeletedTemplate('${templateId}'); closeDeletedTemplatesModal();" class="btn btn-success" style="font-size: 0.85rem;">
                                    ↻ Wiederherstellen
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: right;">
                        <button onclick="closeDeletedTemplatesModal()" class="btn btn-secondary">Schließen</button>
                    </div>
                </div>
            `;

            modal.id = 'deletedTemplatesModal';
            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeDeletedTemplatesModal();
                }
            });
        }

        function closeDeletedTemplatesModal() {
            const modal = document.getElementById('deletedTemplatesModal');
            if (modal) modal.remove();
        }





        function repairTemplateLibrary() {
            let repaired = 0;
            MODULE_TEMPLATES.forEach(template => {
                // Markiere alle nicht-Standard Module als customized
                if (!template.id.startsWith('kerberos-hero') ||
                    template.id.includes('extended') ||
                    template.id.includes('comparison') ||
                    template.id.includes('pricing')) {
                    if (!template.customized) {
                        template.customized = true;
                        repaired++;
                    }
                }
            });

            if (repaired > 0) {
                saveCustomTemplates();
                showNotification(`🔧 ${repaired} Templates als exportierbar markiert`);
            } else {
                showNotification('✅ Template-Bibliothek ist bereits korrekt');
            }
        }

        // Globale Funktion verfügbar machen
        window.repairTemplateLibrary = repairTemplateLibrary;

        function saveCustomTemplates() {
            window.templateManager.saveCustomTemplates();
        }

        function loadCustomTemplates() {
            window.templateManager.loadCustomTemplates();
        }

        // Template-Blacklist Management
        function addToDeletedTemplatesBlacklist(templateId) {
            try {
                const deletedList = getDeletedTemplatesBlacklist();
                if (!deletedList.includes(templateId)) {
                    deletedList.push(templateId);
                    localStorage.setItem('kerberos-deleted-templates', JSON.stringify(deletedList));
                }
            } catch (e) {
                console.error('Fehler beim Speichern der Blacklist:', e);
            }
        }

        function getDeletedTemplatesBlacklist() {
            try {
                const saved = localStorage.getItem('kerberos-deleted-templates');
                return saved ? JSON.parse(saved) : [];
            } catch (e) {
                console.error('Fehler beim Laden der Blacklist:', e);
                return [];
            }
        }

        function removeFromDeletedTemplatesBlacklist(templateId) {
            try {
                const deletedList = getDeletedTemplatesBlacklist();
                const index = deletedList.indexOf(templateId);
                if (index > -1) {
                    deletedList.splice(index, 1);
                    localStorage.setItem('kerberos-deleted-templates', JSON.stringify(deletedList));
                }
            } catch (e) {
                console.error('Fehler beim Aktualisieren der Blacklist:', e);
            }
        }

        // Template-Wiederherstellung
        function restoreDeletedTemplate(templateId) {
            window.templateManager.restoreDeletedTemplate(templateId);
            loadModuleLibraryList();
            showNotification(`✅ Template wiederhergestellt`);
        }


        // === NEUE EXPORT/LÖSCH FUNKTIONEN ===


        function deleteIndividualModule(moduleId) {
            const module = modules.find(m => m.id === moduleId);
            if (!module) return;

            const moduleName = module.name || 'Unbenanntes Modul';

            if (confirm(`Modul "${moduleName}" wirklich löschen?\n\nDiese Aktion kann nicht rückgängig gemacht werden.`)) {
                modules = modules.filter(m => m.id !== moduleId);

                // Canvas neu rendern
                renderCanvas();

                // Wenn das gelöschte Modul ausgewählt war, Property Panel zurücksetzen
                if (selectedModule && selectedModule.id === moduleId) {
                    selectedModule = null;
                    renderPropertyPanel();
                }

                // Placeholder anzeigen falls keine Module mehr da sind
                if (modules.length === 0) {
                    const placeholder = document.querySelector('.canvas-placeholder');
                    if (placeholder) placeholder.style.display = 'block';
                }

                showNotification(`🗑️ Modul "${moduleName}" gelöscht`);
            }
        }

        function showModuleQuickActions(moduleId) {
            const module = modules.find(m => m.id === moduleId);
            if (!module) return;

            const actions = `
                <div style="position: absolute; top: 100%; right: 0; background: white; border: 1px solid #DEE2E6; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 200px;">
                    <div style="padding: 0.5rem;">
                        <button onclick="selectModule('${moduleId}')" style="width: 100%; padding: 0.5rem; border: none; background: transparent; text-align: left; cursor: pointer; border-radius: 4px;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">✏️ Bearbeiten</button>
                        <button onclick="duplicateModule('${moduleId}')" style="width: 100%; padding: 0.5rem; border: none; background: transparent; text-align: left; cursor: pointer; border-radius: 4px;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">📋 Duplizieren</button>
                        <button onclick="exportSingleModule('${moduleId}')" style="width: 100%; padding: 0.5rem; border: none; background: transparent; text-align: left; cursor: pointer; border-radius: 4px;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">📤 Exportieren</button>
                        <hr style="margin: 0.5rem 0; border: none; border-top: 1px solid #DEE2E6;">
                        <button onclick="deleteIndividualModule('${moduleId}')" style="width: 100%; padding: 0.5rem; border: none; background: transparent; text-align: left; cursor: pointer; border-radius: 4px; color: #dc3545;" onmouseover="this.style.background='#fee'" onmouseout="this.style.background='transparent'">🗑️ Löschen</button>
                    </div>
                </div>`;

            return actions;
        }



        // 🚀 ERWEITERTE STORAGE-LÖSUNG (erweitert bestehende LocalFileSync)
        // Füge diese Ergänzungen zu deiner bestehenden LocalFileSync Klasse hinzu

        // ERGÄNZUNG 1: Erweiterte LocalFileSync Methoden
        if (typeof LocalFileSync !== 'undefined' && LocalFileSync.prototype) {
            
            // Erweiterte saveToFile Methode mit Quota-Handling
            const originalSaveToFile = LocalFileSync.prototype.saveToFile;
            LocalFileSync.prototype.saveToFile = function(showDownload = false) {
                try {
                    return originalSaveToFile.call(this, showDownload);
                } catch (error) {
                    if (error.name === 'QuotaExceededError') {
                        console.warn('🚨 LocalStorage voll - verwende intelligente Bereinigung');
                        
                        // Bereinige alte Backups
                        const keysToRemove = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && (key.includes('backup') || key.includes('temp'))) {
                                keysToRemove.push(key);
                            }
                        }
                        
                        keysToRemove.forEach(key => {
                            localStorage.removeItem(key);
                            console.log('🧹 Entfernt:', key);
                        });
                        
                        // Erneut versuchen
                        try {
                            return originalSaveToFile.call(this, showDownload);
                        } catch (e2) {
                            console.error('❌ Speichern fehlgeschlagen auch nach Bereinigung');
                            if (typeof showNotification === 'function') {
                                showNotification('⚠️ Speicher voll - bitte manuell exportieren');
                            }
                            return false;
                        }
                    }
                    throw error;
                }
            };

            // Intelligenteres Auto-Save
            const originalStartAutoSave = LocalFileSync.prototype.startAutoSave;
            LocalFileSync.prototype.startAutoSave = function() {
                // Stoppe altes Auto-Save
                if (this.autoSaveInterval) {
                    clearInterval(this.autoSaveInterval);
                }
                
                this.saveInProgress = false;
                this.lastDataHash = null;
                
                // Neues intelligentes Auto-Save
                this.autoSaveInterval = setInterval(() => {
                    if (this.saveInProgress) return;
                    
                    // Prüfe auf Änderungen durch Hash-Vergleich
                    const currentData = {
                        modules: window.modules?.length || 0,
                        websites: window.websites?.length || 0,
                        selected: window.selectedModule?.id || null
                    };
                    
                    const currentHash = JSON.stringify(currentData);
                    
                    if (currentHash !== this.lastDataHash) {
                        this.lastDataHash = currentHash;
                        
                        const hasWebsites = localStorage.getItem('kerberos-websites');
                        const hasPages = localStorage.getItem('kerberos-saved-pages');
                        const hasTemplates = localStorage.getItem('kerberos-custom-templates');
                        const hasCurrentModules = typeof modules !== 'undefined' && modules.length > 0;

                        if (hasWebsites || hasPages || hasTemplates || hasCurrentModules) {
                            this.saveInProgress = true;
                            console.log('💾 Intelligentes Auto-Save: Änderungen erkannt');
                            
                            try {
                                this.saveToFile(false);
                            } finally {
                                setTimeout(() => {
                                    this.saveInProgress = false;
                                }, 3000);
                            }
                        }
                    }
                }, 45000); // Alle 45 Sekunden (weniger häufig)
            };
        }

        // ERGÄNZUNG 2: Erweiterte renderCanvas mit besserer Duplikat-Prävention
        if (typeof window.renderCanvas === 'function') {
            const originalRenderCanvas = window.renderCanvas;
            
            window.renderCanvas = function(...args) {
                console.log('🎯 Erweiterte renderCanvas aufgerufen');
                
                // Performance-Tracking
                const startTime = performance.now();
                
                // Duplikat-Präventions-Check VOR dem Rendering
                const canvas = document.getElementById('canvas');
                if (canvas && window.modules) {
                    const existingIds = new Set();
                    const duplicateElements = [];
                    
                    canvas.querySelectorAll('[data-module-id]').forEach(el => {
                        const id = el.dataset.moduleId;
                        if (existingIds.has(id)) {
                            duplicateElements.push(el);
                        } else {
                            existingIds.add(id);
                        }
                    });
                    
                    if (duplicateElements.length > 0) {
                        console.log(`🧹 Bereinige ${duplicateElements.length} Duplikate vor Rendering`);
                        duplicateElements.forEach(el => el.remove());
                    }
                }
                
                // Originale Funktion aufrufen
                const result = originalRenderCanvas.apply(this, args);
                
                // Performance-Logging
                const renderTime = performance.now() - startTime;
                console.log(`⚡ Rendering abgeschlossen in ${Math.round(renderTime)}ms`);
                
                // Nach-Rendering Validierung
                setTimeout(() => {
                    if (canvas && window.modules) {
                        const domCount = canvas.querySelectorAll('.canvas-module').length;
                        const moduleCount = window.modules.length;
                        
                        if (domCount !== moduleCount) {
                            console.warn(`⚠️ DOM/Module Mismatch: ${domCount} DOM vs ${moduleCount} Module`);
                        }
                        
                        // Duplikat-Check nach Rendering
                        const postRenderIds = {};
                        canvas.querySelectorAll('[data-module-id]').forEach(el => {
                            const id = el.dataset.moduleId;
                            postRenderIds[id] = (postRenderIds[id] || 0) + 1;
                        });
                        
                        const postDuplicates = Object.keys(postRenderIds).filter(id => postRenderIds[id] > 1);
                        if (postDuplicates.length > 0) {
                            console.warn('🚨 Neue Duplikate nach Rendering:', postDuplicates);
                        }
                    }
                }, 100);
                
                return result;
            };
        }

        // ERGÄNZUNG 3: Erweiterte selectModule mit besserer Stabilität
        if (typeof window.selectModule === 'function') {
            const originalSelectModule = window.selectModule;
            
            window.selectModule = function(moduleId, ...args) {
                console.log('🎯 Erweiterte selectModule aufgerufen:', moduleId);
                
                // Pre-Selection Validierung
                if (moduleId) {
                    const moduleExists = window.modules && window.modules.find(m => m.id === moduleId);
                    if (!moduleExists) {
                        console.error('❌ Modul existiert nicht im Array:', moduleId);
                        return;
                    }
                    
                    // DOM-Bereinigung vor Selektion
                    const existingElements = document.querySelectorAll(`[data-module-id="${moduleId}"]`);
                    if (existingElements.length > 1) {
                        console.log(`🧹 Bereinige ${existingElements.length - 1} Duplikate vor Selektion`);
                        for (let i = 1; i < existingElements.length; i++) {
                            existingElements[i].remove();
                        }
                    }
                }
                
                // Originale Funktion aufrufen
                const result = originalSelectModule.call(this, moduleId, ...args);
                
                // Post-Selection Validierung
                if (moduleId && window.selectedModule) {
                    setTimeout(() => {
                        const selectedElements = document.querySelectorAll('.canvas-module.selected');
                        if (selectedElements.length === 0) {
                            console.warn('⚠️ Kein DOM-Element als selected markiert');
                        } else if (selectedElements.length > 1) {
                            console.warn('⚠️ Mehrere Elemente als selected markiert:', selectedElements.length);
                        }
                    }, 50);
                }
                
                return result;
            };
        }

        // ERGÄNZUNG 4: Erweiterte Utility-Funktionen
        window.editorEnhancements = {
            
            // Intelligente Duplikat-Bereinigung
            cleanupDuplicates: function() {
                const canvas = document.getElementById('canvas');
                if (!canvas) return 0;
                
                const moduleIds = new Set();
                let removedCount = 0;
                
                canvas.querySelectorAll('[data-module-id]').forEach(el => {
                    const id = el.dataset.moduleId;
                    if (moduleIds.has(id)) {
                        el.remove();
                        removedCount++;
                        console.log('🗑️ Duplikat entfernt:', id);
                    } else {
                        moduleIds.add(id);
                    }
                });
                
                if (removedCount > 0 && typeof showNotification === 'function') {
                    showNotification(`🧹 ${removedCount} Duplikate entfernt`);
                }
                
                return removedCount;
            },
            
            // Performance-Monitor
            performanceCheck: function() {
                const canvas = document.getElementById('canvas');
                const info = {
                    timestamp: new Date().toISOString(),
                    modules: {
                        arrayCount: window.modules?.length || 0,
                        domCount: canvas ? canvas.querySelectorAll('.canvas-module').length : 0,
                        selectedModule: window.selectedModule?.id || null
                    },
                    storage: {
                        localStorageUsed: this.getLocalStorageSize(),
                        quotaAvailable: this.checkStorageQuota()
                    },
                    dom: {
                        totalElements: document.querySelectorAll('*').length,
                        moduleElements: document.querySelectorAll('[data-module-id]').length
                    }
                };
                
                console.table(info.modules);
                console.table(info.storage);
                
                return info;
            },
            
            // LocalStorage Größe berechnen
            getLocalStorageSize: function() {
                let total = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        total += localStorage[key].length + key.length;
                    }
                }
                return Math.round(total / 1024); // KB
            },
            
            // Storage-Quota prüfen
            checkStorageQuota: function() {
                try {
                    const testKey = 'quota_test';
                    const testData = 'x'.repeat(1024); // 1KB
                    localStorage.setItem(testKey, testData);
                    localStorage.removeItem(testKey);
                    return true;
                } catch (e) {
                    return false;
                }
            },
            
            // Modul-Integrität prüfen
            validateModules: function() {
                if (!window.modules) return { valid: false, reason: 'No modules array' };
                
                const issues = [];
                const ids = new Set();
                
                window.modules.forEach((module, index) => {
                    if (!module.id) {
                        issues.push(`Module ${index}: Missing ID`);
                    } else if (ids.has(module.id)) {
                        issues.push(`Module ${index}: Duplicate ID '${module.id}'`);
                    } else {
                        ids.add(module.id);
                    }
                    
                    if (!module.name) {
                        issues.push(`Module ${module.id || index}: Missing name`);
                    }
                    
                    if (!module.html && !module.templateId) {
                        issues.push(`Module ${module.id || index}: Missing HTML and templateId`);
                    }
                });
                
                return {
                    valid: issues.length === 0,
                    issues: issues,
                    moduleCount: window.modules.length,
                    uniqueIds: ids.size
                };
            },
            
            // Emergency Reset
            emergencyReset: function() {
                if (!confirm('⚠️ Emergency Reset: Alle Module werden gelöscht und Canvas neu gerendert. Fortfahren?')) {
                    return;
                }
                
                // Stoppe alle laufenden Prozesse
                if (window.renderingInProgress) {
                    window.renderingInProgress = false;
                }
                
                // Bereinige DOM
                const canvas = document.getElementById('canvas');
                if (canvas) {
                    canvas.innerHTML = '';
                }
                
                // Deselektiere alles
                window.selectedModule = null;
                
                // Render neu
                if (typeof renderCanvas === 'function') {
                    setTimeout(() => {
                        renderCanvas();
                    }, 100);
                }
                
                console.log('🚑 Emergency Reset durchgeführt');
                if (typeof showNotification === 'function') {
                    showNotification('🚑 Emergency Reset abgeschlossen');
                }
            }
        };

        // ERGÄNZUNG 5: Keyboard-Shortcuts
        document.addEventListener('keydown', function(e) {
            // Nur wenn kein Input-Feld fokussiert ist
            if (document.activeElement.matches('input, textarea, [contenteditable="true"]')) {
                return;
            }
            
            // Hotkeys für erweiterte Funktionen
            if (e.ctrlKey || e.metaKey) {
                switch(e.key.toLowerCase()) {
                    case 's':
                        e.preventDefault();
                        // Speichern
                        if (window.localFileSync && typeof window.localFileSync.saveToFile === 'function') {
                            window.localFileSync.saveToFile(true);
                        }
                        break;
                        
                    case 'r':
                        e.preventDefault();
                        // Canvas neu rendern
                        if (typeof renderCanvas === 'function') {
                            renderCanvas();
                            if (typeof showNotification === 'function') {
                                showNotification('🔄 Canvas neu gerendert');
                            }
                        }
                        break;
                        
                    case 'd':
                        e.preventDefault();
                        // Duplikate bereinigen
                        const removed = window.editorEnhancements.cleanupDuplicates();
                        break;
                        
                    case 'p':
                        e.preventDefault();
                        // Performance-Check
                        window.editorEnhancements.performanceCheck();
                        break;
                }
            }
            
            // Escape für Deselection
            if (e.key === 'Escape' && window.selectedModule) {
                if (typeof selectModule === 'function') {
                    selectModule(null);
                }
            }
        });

        // ERGÄNZUNG 6: Auto-Cleanup Interval
        setInterval(() => {
            // Automatische Duplikat-Bereinigung alle 2 Minuten
            const removed = window.editorEnhancements.cleanupDuplicates();
            if (removed > 0) {
                console.log(`🧹 Auto-Cleanup: ${removed} Duplikate entfernt`);
            }
        }, 120000);

        console.log('🚀 Editor-Erweiterungen aktiviert!');


        // Automatisches Starten beim Laden
        document.addEventListener('DOMContentLoaded', () => {
            localFileSync.startAutoSave();
            localFileSync.startFileWatcher();
            localFileSync.updateSyncStatus('Bereit für Synchronisation');
        });


        // 🔧 REPARATUR: Auto-Error-Handler
        window.addEventListener('error', function (e) {
            if (e.message && e.message.includes('websites is not defined')) {
                if (typeof websites === 'undefined') window.websites = [];
                console.log('🔧 Auto-Fix: websites Variable repariert');
                return true;
            }
            if (e.message && e.message.includes('setupSearch is not defined')) {
                if (typeof setupImprovedModuleSearch === 'function') {
                    setupImprovedModuleSearch();
                }
                console.log('🔧 Auto-Fix: setupSearch repariert');
                return true;
            }
        });

        // Beim Schließen der Seite stoppen
        window.addEventListener('beforeunload', () => {
            localFileSync.stopAutoSave();
        });

        // === SVG SMART SIZING SYSTEM ===

        // SVG-Analyse Funktion (Verbessert)
        function analyzeSVG(svgCode) {
            if (!svgCode || typeof svgCode !== 'string') {
                console.log('❌ SVG Code ist leer oder kein String');
                return { aspectRatio: 1, format: "1:1" };
            }

            console.log('🔍 Analysiere SVG Code:', svgCode.substring(0, 200) + '...');

            // Mehrere Regex-Patterns für viewBox
            const patterns = [
                /viewBox=["']([^"']+)["']/,           // Standard
                /viewBox\s*=\s*["']([^"']+)["']/,    // Mit Leerzeichen
                /viewBox=["']([^"']*?)["']/,         // Non-greedy
                /viewBox\s*=\s*["']([0-9\s.+-]+)["']/,         // Mit Zahlen, Leerzeichen, Punkt und Plus/Minus
                /viewBox\s*=\s*([0-9\s.+-]+)/          // Ohne Anführungszeichen
            ];

            let viewBoxMatch = null;
            for (const pattern of patterns) {
                viewBoxMatch = svgCode.match(pattern);
                if (viewBoxMatch) {
                    console.log('✅ viewBox gefunden mit Pattern:', pattern, 'Match:', viewBoxMatch[1]);
                    break;
                }
            }

            if (viewBoxMatch) {
                const values = viewBoxMatch[1].trim().split(/\s+/).map(Number);
                console.log('📊 viewBox Values:', values);

                if (values.length >= 4) {
                    const [x, y, width, height] = values;
                    const aspectRatio = width / height;
                    const result = {
                        width,
                        height,
                        aspectRatio,
                        format: `${Math.round(width)}:${Math.round(height)}`
                    };
                    console.log('📐 Final Analysis:', result);
                    console.log('📊 Aspect Ratio Check:', { width, height, calculated: width / height, final: aspectRatio });
                    return result;
                }
            }

            console.log('❌ Fallback to 1:1');
            return { aspectRatio: 1, format: "1:1" };
        }

        // SVG Size Presets
        const SVG_SIZE_PRESETS = [
            { label: "🤏 Sehr Klein (80px)", multiplier: 0.8 },
            { label: "📱 Klein (120px)", multiplier: 1.2 },
            { label: "💻 Normal (160px)", multiplier: 1.6 },
            { label: "🖥️ Groß (200px)", multiplier: 2.0 },
            { label: "📺 Sehr Groß (300px)", multiplier: 3.0 },
            { label: "🏛️ Extra Groß (400px)", multiplier: 4.0 }
        ];

 
        // Globale Funktion verfügbar machen
        window.applySVGSize = applySVGSize;


        // ========== RESPONSIVE BILD-OPTIMIERUNG ==========
        function createResponsiveImage(imageUrl, alt = '', additionalClasses = '', sizes = '(max-width: 799px) 100vw, 50vw') {
            if (!imageUrl || !imageUrl.includes('images.squarespace-cdn.com')) {
                // Fallback für normale Bilder
                return `<img src="${imageUrl}" alt="${alt}" class="${additionalClasses}" style="width: 100%; height: auto;">`;
            }

            // Squarespace responsive formats
            const formats = [
                { width: '100w', format: '100w' },
                { width: '300w', format: '300w' },
                { width: '500w', format: '500w' },
                { width: '750w', format: '750w' },
                { width: '1000w', format: '1000w' },
                { width: '1500w', format: '1500w' },
                { width: '2500w', format: '2500w' }
            ];

            // srcset generieren
            const srcset = formats.map(f => {
                const separator = imageUrl.includes('?') ? '&' : '?';
                return `${imageUrl}${separator}format=${f.format} ${f.width}`;
            }).join(', ');

            return `<img src="${imageUrl}" 
                         srcset="${srcset}" 
                         sizes="${sizes}" 
                         alt="${alt}" 
                         class="${additionalClasses}" 
                         style="width: 100%; height: auto; object-fit: cover;"
                         loading="lazy"
                         decoding="async">`;
        }

        function createResponsiveBackgroundImage(imageUrl, fallbackColor = '#f8f9fa') {
            if (!imageUrl || !imageUrl.includes('images.squarespace-cdn.com')) {
                return `background-image: url('${imageUrl}');`;
            }

            // Für Hintergrundbilder nutzen wir das 1500w Format als Standard
            const separator = imageUrl.includes('?') ? '&' : '?';
            const optimizedUrl = `${imageUrl}${separator}format=1500w`;

            return `background-image: url('${optimizedUrl}'); background-color: ${fallbackColor};`;
        }


        // ===== UNIVERSELLE BUTTON-STYLING-FUNKTION (NEU) =====
        function getUniversalButtonStyles(props, moduleId) {
            // Einheitliche Button-Maps (für alle Module)
            const buttonStyleMap = {
                'primary': { bg: '#063AA8', text: '#FFFFFF' },
                'secondary': { bg: '#FFFFFF', text: '#063AA8' },
                'outline': { bg: 'transparent', text: '#FFFFFF', border: '2px solid rgba(255,255,255,0.5)' },
                'text': { bg: 'transparent', text: '#FFFFFF', border: 'none' },
                'gradient': { bg: 'linear-gradient(135deg, #063AA8, #009CE6)', text: '#FFFFFF' },
                'dark': { bg: '#212529', text: '#FFFFFF' }
            };

            const buttonPaddingMap = {
                'small': '0.5rem 1rem',
                'medium': '0.75rem 1.5rem',
                'large': '1rem 2rem',
                'extra-large': '1.5rem 3rem'
            };

            const buttonRadiusMap = {
                'none': '0', 'small': '4px', 'medium': '8px',
                'large': '12px', 'extra-large': '16px', 'circle': '50%', 'pill': '9999px'
            };

            const buttonShadowMap = {
                'none': 'none',
                'light': '0 2px 8px rgba(0,0,0,0.1)',
                'medium': '0 4px 12px rgba(6,58,168,0.2)',
                'strong': '0 8px 24px rgba(6,58,168,0.25)'
            };

            // Button-Style auflösen mit intelligenter Textfarbe
            const styleType = props.buttonStyleType || 'primary';
            const buttonStyle = buttonStyleMap[styleType] || buttonStyleMap['primary'];
            
            // Fallback: Wenn buttonColor gesetzt ist, überschreibt es die Auto-Textfarbe
            const finalTextColor = props.buttonColor || buttonStyle.text;
            const finalBgColor = props.buttonBackground || buttonStyle.bg;
            const finalBorder = buttonStyle.border || 'none';

            return {
                background: finalBgColor,
                color: finalTextColor,
                padding: buttonPaddingMap[props.buttonPaddingType] || '0.75rem 1.5rem',
                borderRadius: buttonRadiusMap[props.buttonRadiusType] || '8px',
                boxShadow: buttonShadowMap[props.buttonShadowType] || '0 4px 12px rgba(6,58,168,0.2)',
                border: finalBorder,
                textDecoration: 'none',
                display: 'inline-flex',
                alignItems: 'center',
                gap: '0.5rem',
                fontFamily: 'var(--button-font-family)',
                fontWeight: 'var(--button-font-weight)',
                transition: 'all 0.3s ease'
            };
        }


        // Intelligente Auto-Optimierung für alle Bilder
        function autoOptimizeAllImages(html, props) {
            // Alle Squarespace URLs automatisch optimieren
            const squarespaceRegex = /(https:\/\/images\.squarespace-cdn\.com\/[^"'\s]+)/g;

            return html.replace(squarespaceRegex, (url) => {
                if (!url.includes('format=')) {
                    const separator = url.includes('?') ? '&' : '?';
                    return `${url}${separator}format=1500w`;
                }
                return url;
            });
        }

        // UNIVERSELLE BILD-OPTIMIERUNG - NEUE FUNKTION
        function universalImageOptimization(module, html) {
            // Einfache aber effektive Bild-Optimierung
            try {
                // Suche nach img-Tags mit Squarespace URLs
                const imgRegex = /<img([^>]*src="([^"]*images\.squarespace-cdn\.com[^"]*)"[^>]*)>/g;

                html = html.replace(imgRegex, (fullMatch, attributes, imageUrl) => {
                    // Prüfe ob bereits optimiert
                    if (attributes.includes('srcset=')) {
                        return fullMatch; // Bereits optimiert
                    }

                    // Alt-Text extrahieren
                    const altMatch = attributes.match(/alt="([^"]*)"/) || ['', 'Bild'];
                    const altText = altMatch[1];

                    // Responsive Image erstellen
                    const responsiveImg = createResponsiveImage(
                        imageUrl,
                        altText,
                        '',
                        '(max-width: 768px) 100vw, 50vw'
                    );

                    // Style-Attribute extrahieren und übertragen
                    const styleMatch = attributes.match(/style="([^"]*)"/) || ['', 'width: 100%; height: auto; object-fit: cover;'];
                    const originalStyle = styleMatch[1];

                    // Styles übertragen
                    return responsiveImg.replace(
                        'style="width: 100%; height: auto; object-fit: cover;"',
                        `style="${originalStyle}"`
                    );
                });

                return html;
            } catch (error) {
                console.log('Fehler bei Bild-Optimierung:', error);
                return html; // Fallback: Original HTML zurückgeben
            }
        }

        // Automatische Squarespace URL-Optimierung
        function autoOptimizeSquarespaceUrls(html) {
            // Alle Squarespace Bild-URLs automatisch optimieren
            const squarespaceRegex = /(src=")([^"]*images\.squarespace-cdn\.com[^"]*?)(")/g;

            return html.replace(squarespaceRegex, (match, prefix, url, suffix) => {
                if (!url.includes('format=')) {
                    const separator = url.includes('?') ? '&' : '?';
                    const optimizedUrl = url + separator + 'format=1500w';
                    return prefix + optimizedUrl + suffix;
                }
                return match;
            });
        }

        // Erweiterte responsive Bildoptimierung für bestehende img-Tags
        function enhanceExistingImages(html) {
            // Suche nach img-Tags mit height: 200px und ersetze sie
            const imgRegex = /<img([^>]*src="[^"]*"[^>]*style="[^"]*height:\s*200px[^"]*"[^>]*)>/g;

            return html.replace(imgRegex, (match, attributes) => {
                // Lazy loading hinzufügen falls nicht vorhanden
                if (!match.includes('loading=')) {
                    match = match.replace('<img', '<img loading="lazy"');
                }
                return match;
            });
        }

        // Post-Processing für alle img-Tags im finalen HTML
        function postProcessAllImages(module, html) {
            // Sicherheitsprüfungen
            if (!module || !module.properties || !html || typeof html !== 'string') {
                console.warn('postProcessAllImages: Ungültige Parameter', { module, html });
                return html || '';
            }
            
            const props = module.properties;
            
            // Standard-Werte aus globalen Properties
            const globalHeight = props.globalImageHeight || '200px';
            const globalObjectFit = props.globalImageObjectFit || 'cover';
            const globalObjectPosition = props.globalImageObjectPosition || 'center';
            const globalCustomCSS = props.globalImageCustomCSS || '';
            
            try {
                // Finde alle img-Tags und aktualisiere ihre Styles
                const imgRegex = /<img([^>]*?)style="([^"]*?)"([^>]*?)>/g;
                
                html = html.replace(imgRegex, (match, beforeStyle, currentStyle, afterStyle) => {
                    // Prüfe ob das Bild bereits die richtigen Properties hat
                    if (!currentStyle.includes('height: ' + globalHeight)) {
                        // Erstelle neuen Style mit globalen Properties
                        let newStyle = currentStyle;
                        
                        // Entferne alte Eigenschaften
                        newStyle = newStyle.replace(/height:\s*[^;]+;?/g, '');
                        newStyle = newStyle.replace(/object-fit:\s*[^;]+;?/g, '');
                        newStyle = newStyle.replace(/object-position:\s*[^;]+;?/g, '');
                        
                        // Füge neue Eigenschaften hinzu
                        newStyle += `; height: ${globalHeight}; object-fit: ${globalObjectFit}; object-position: ${globalObjectPosition}; display: block; margin: 0; line-height: 0; ${globalCustomCSS}`;
                        
                        // Bereinige doppelte Semikolons
                        newStyle = newStyle.replace(/;+/g, ';').replace(/^;|;$/g, '');
                        
                        return `<img${beforeStyle}style="${newStyle}"${afterStyle}>`;
                    }
                    
                    return match;
                });
            } catch (error) {
                console.error('Fehler in postProcessAllImages:', error);
                return html;
            }
            
            return html;
        }



        // Utility Functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyToClipboard(elementId) {
            const text = processModuleHTML(selectedModule);

            navigator.clipboard.writeText(text).then(() => {
                showNotification('📋 Code in Zwischenablage kopiert');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('📋 Code kopiert');
            });
        }

        // Search
        // Fix für Kategorisierungs-Problem in der Modul-Suche

        // 🔧 REPARATUR: Globale Variablen (VS-Code freundlich)
        if (typeof websites === 'undefined') {
            window.websites = [];
        }
        if (typeof customTemplates === 'undefined') {
            window.customTemplates = {};
        }
        if (typeof modules === 'undefined') {
            window.modules = [];
        }
        if (typeof selectedModule === 'undefined') {
            window.selectedModule = null;
        }

        // 🔧 REPARATUR: setupSearch Funktion erstellen
        if (typeof setupSearch === 'undefined') {
            window.setupSearch = function () {
                console.log('🔧 setupSearch Backup ausgeführt');
                if (typeof setupImprovedModuleSearch === 'function') {
                    setupImprovedModuleSearch();
                }
            };
        }

        // Originale Kategorien speichern
        let originalCategoryState = null;

        function saveCategoryState() {
            originalCategoryState = {};
            document.querySelectorAll('.category-title').forEach(title => {
                const categoryName = title.textContent.trim();
                originalCategoryState[categoryName] = {
                    visible: title.style.display !== 'none',
                    modules: []
                };

                // Alle Module in dieser Kategorie sammeln
                let next = title.nextElementSibling;
                while (next && !next.classList.contains('category-title')) {
                    if (next.classList.contains('module-template')) {
                        originalCategoryState[categoryName].modules.push({
                            element: next,
                            visible: next.style.display !== 'none'
                        });
                    }
                    next = next.nextElementSibling;
                }
            });
        }

        function restoreCategoryState() {
            if (!originalCategoryState) return;

            Object.keys(originalCategoryState).forEach(categoryName => {
                const categoryData = originalCategoryState[categoryName];
                const titleElement = Array.from(document.querySelectorAll('.category-title'))
                    .find(el => el.textContent.trim() === categoryName);

                if (titleElement) {
                    titleElement.style.display = categoryData.visible ? 'block' : 'none';
                }

                categoryData.modules.forEach(moduleData => {
                    if (moduleData.element) {
                        moduleData.element.style.display = moduleData.visible ? 'block' : 'none';
                    }
                });
            });
        }

        // Verbesserte Suchfunktion mit Kategorisierungserhaltung
        function setupImprovedModuleSearch() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;

            // Kategorie-Status beim ersten Mal speichern
            saveCategoryState();

            // Event Listener für Suche
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase().trim();

                if (term === '') {
                    // Wenn Suchfeld leer ist, ursprünglichen Zustand wiederherstellen
                    restoreCategoryState();
                    return;
                }

                // Suche durchführen
                let hasVisibleModules = false;
                const categoryVisibility = {};

                document.querySelectorAll('.module-template').forEach(el => {
                    const name = el.querySelector('.module-name')?.textContent.toLowerCase() || '';
                    const desc = el.querySelector('.module-description')?.textContent.toLowerCase() || '';
                    const category = el.getAttribute('data-category') || '';

                    const matches = name.includes(term) || desc.includes(term);
                    el.style.display = matches ? 'block' : 'none';

                    if (matches) {
                        hasVisibleModules = true;
                        categoryVisibility[category] = true;
                    }
                });

                // Kategorien basierend auf sichtbaren Modulen anzeigen/verstecken
                document.querySelectorAll('.category-title').forEach(title => {
                    const categoryName = title.textContent.trim();
                    const nextElements = [];
                    let next = title.nextElementSibling;

                    while (next && !next.classList.contains('category-title')) {
                        if (next.classList.contains('module-template')) {
                            nextElements.push(next);
                        }
                        next = next.nextElementSibling;
                    }

                    const hasVisibleModulesInCategory = nextElements.some(el => el.style.display !== 'none');
                    title.style.display = hasVisibleModulesInCategory ? 'block' : 'none';
                });

                // Keine Ergebnisse Meldung
                const moduleLibrary = document.querySelector('.module-library');
                let noResultsMsg = document.querySelector('.no-search-results');

                if (!hasVisibleModules) {
                    if (!noResultsMsg) {
                        noResultsMsg = document.createElement('div');
                        noResultsMsg.className = 'no-search-results';
                        noResultsMsg.style.cssText = 'text-align: center; padding: 2rem; color: #666; font-style: italic;';
                        noResultsMsg.innerHTML = `
                            <p>Keine Module gefunden für: "<strong>${term}</strong>"</p>
                            <small>Versuchen Sie andere Suchbegriffe oder löschen Sie die Suche.</small>
                        `;
                        moduleLibrary?.appendChild(noResultsMsg);
                    }
                } else if (noResultsMsg) {
                    noResultsMsg.remove();
                }
            });

            // Kategorie-Attribute zu Modulen hinzufügen (falls nicht vorhanden)
            document.querySelectorAll('.module-template').forEach(moduleEl => {
                if (!moduleEl.getAttribute('data-category')) {
                    const prevTitle = findPreviousCategoryTitle(moduleEl);
                    if (prevTitle) {
                        moduleEl.setAttribute('data-category', prevTitle.textContent.trim());
                    }
                }
            });
        }

        function findPreviousCategoryTitle(element) {
            let prev = element.previousElementSibling;
            while (prev) {
                if (prev.classList.contains('category-title')) {
                    return prev;
                }
                prev = prev.previousElementSibling;
            }
            return null;
        }

        // Clear Search Funktion hinzufügen
        function addClearSearchButton() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;

            // Clear Button erstellen
            const clearButton = document.createElement('button');
            clearButton.innerHTML = '✕';
            clearButton.className = 'search-clear-btn';
            clearButton.style.cssText = `
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                font-size: 16px;
                cursor: pointer;
                color: #999;
                padding: 4px;
                border-radius: 50%;
                width: 24px;
                height: 24px;
                display: none;
            `;

            // Search-Container relativ positionieren
            const searchContainer = searchInput.parentElement;
            searchContainer.style.position = 'relative';
            searchContainer.appendChild(clearButton);

            // Clear Button Verhalten
            clearButton.addEventListener('click', () => {
                searchInput.value = '';
                restoreCategoryState();
                clearButton.style.display = 'none';
                searchInput.focus();

                // No-results Meldung entfernen
                const noResultsMsg = document.querySelector('.no-search-results');
                if (noResultsMsg) {
                    noResultsMsg.remove();
                }
            });

            // Clear Button anzeigen/verstecken
            searchInput.addEventListener('input', () => {
                clearButton.style.display = searchInput.value.length > 0 ? 'block' : 'none';
            });
        }

        // Kategorie-Filter-Buttons hinzufügen
        function addCategoryFilterButtons() {
            const moduleLibrary = document.querySelector('.module-library');
            if (!moduleLibrary) return;

            // Sammle alle Kategorien
            const categories = new Set();
            document.querySelectorAll('.category-title').forEach(title => {
                categories.add(title.textContent.trim());
            });

            // Filter-Container erstellen
            const filterContainer = document.createElement('div');
            filterContainer.className = 'category-filters';
            filterContainer.style.cssText = `
                margin-bottom: 1rem;
                padding: 1rem;
                background: #f8f9fa;
                border-radius: 6px;
                border: 1px solid #dee2e6;
            `;

            const filterTitle = document.createElement('small');
            filterTitle.textContent = 'Kategorien:';
            filterTitle.style.cssText = 'color: #666; margin-right: 0.5rem; font-weight: 500;';
            filterContainer.appendChild(filterTitle);

            // "Alle" Button
            const allButton = document.createElement('button');
            allButton.textContent = 'Alle';
            allButton.className = 'category-filter-btn active';
            allButton.style.cssText = `
                margin: 0.2rem;
                padding: 0.3rem 0.8rem;
                border: 1px solid #007bff;
                background: #007bff;
                color: white;
                border-radius: 4px;
                font-size: 0.85rem;
                cursor: pointer;
                transition: all 0.2s;
            `;

            allButton.addEventListener('click', () => {
                restoreCategoryState();
                document.getElementById('searchInput').value = '';
                updateActiveFilterButton(allButton);
            });

            filterContainer.appendChild(allButton);

            // Kategorie-Buttons
            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.className = 'category-filter-btn';
                button.setAttribute('data-category', category);
                button.style.cssText = `
                    margin: 0.2rem;
                    padding: 0.3rem 0.8rem;
                    border: 1px solid #6c757d;
                    background: white;
                    color: #6c757d;
                    border-radius: 4px;
                    font-size: 0.85rem;
                    cursor: pointer;
                    transition: all 0.2s;
                `;

                button.addEventListener('click', () => {
                    filterByCategory(category);
                    updateActiveFilterButton(button);
                });

                filterContainer.appendChild(button);
            });

            // Filter vor der Module-Library einfügen
            moduleLibrary.parentElement.insertBefore(filterContainer, moduleLibrary);
        }

        function updateActiveFilterButton(activeButton) {
            document.querySelectorAll('.category-filter-btn').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#6c757d';
                btn.style.borderColor = '#6c757d';
            });

            activeButton.style.background = '#007bff';
            activeButton.style.color = 'white';
            activeButton.style.borderColor = '#007bff';
        }

        function filterByCategory(targetCategory) {
            // Alle Module verstecken
            document.querySelectorAll('.module-template').forEach(el => {
                el.style.display = 'none';
            });

            // Alle Kategorien verstecken
            document.querySelectorAll('.category-title').forEach(title => {
                title.style.display = 'none';
            });

            // Nur gewählte Kategorie und ihre Module anzeigen
            document.querySelectorAll('.category-title').forEach(title => {
                if (title.textContent.trim() === targetCategory) {
                    title.style.display = 'block';

                    // Module in dieser Kategorie anzeigen
                    let next = title.nextElementSibling;
                    while (next && !next.classList.contains('category-title')) {
                        if (next.classList.contains('module-template')) {
                            next.style.display = 'block';
                        }
                        next = next.nextElementSibling;
                    }
                }
            });

            // Suchfeld leeren
            document.getElementById('searchInput').value = '';
        }

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function () {
            // Warten bis Module-Library geladen ist
            setTimeout(() => {
                setupImprovedModuleSearch();
                addClearSearchButton();
                addCategoryFilterButtons();
            }, 1500);
        });

        // Hook in die bestehende loadModuleLibrary Funktion
        const originalLoadModuleLibrary = window.loadModuleLibrary;
        if (originalLoadModuleLibrary) {
            window.loadModuleLibrary = function () {
                originalLoadModuleLibrary.apply(this, arguments);

                // Nach dem Laden der Module-Library die Verbesserungen anwenden
                setTimeout(() => {
                    saveCategoryState();
                    setupImprovedModuleSearch();
                }, 100);
            };
        }

        // Website-Suche Funktionalität
        function setupWebsiteSearch() {
            // Website-Suche HTML hinzufügen
            const websiteSidebarSearch = `
                <div class="website-search-container" style="margin-bottom: 1rem;">
                    <div class="search-box">
                        <input type="text" id="websiteSearchInput" placeholder="🔍 Websites durchsuchen..." 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="search-filters" style="margin-top: 0.5rem;">
                        <select id="websiteSearchCategory" style="padding: 0.3rem; margin-right: 0.5rem;">
                            <option value="">Alle Kategorien</option>
                            <option value="landingpage">Landing Pages</option>
                            <option value="portfolio">Portfolio</option>
                            <option value="business">Business</option>
                            <option value="blog">Blog</option>
                            <option value="shop">Shop</option>
                        </select>
                        <select id="websiteSearchSort" style="padding: 0.3rem;">
                            <option value="name">Nach Name</option>
                            <option value="date">Nach Datum</option>
                            <option value="modules">Nach Module-Anzahl</option>
                        </select>
                    </div>
                </div>
            `;

            // Suche zu Website-Sidebar hinzufügen
            const websitesList = document.querySelector('.websites-list');
            if (websitesList) {
                websitesList.insertAdjacentHTML('beforebegin', websiteSidebarSearch);
            }

            // Event Listeners
            const searchInput = document.getElementById('websiteSearchInput');
            const categoryFilter = document.getElementById('websiteSearchCategory');
            const sortFilter = document.getElementById('websiteSearchSort');

            if (searchInput) {
                searchInput.addEventListener('input', performWebsiteSearch);
            }
            if (categoryFilter) {
                categoryFilter.addEventListener('change', performWebsiteSearch);
            }
            if (sortFilter) {
                sortFilter.addEventListener('change', performWebsiteSearch);
            }
        }

        function performWebsiteSearch() {
            const searchTerm = document.getElementById('websiteSearchInput')?.value.toLowerCase() || '';
            const category = document.getElementById('websiteSearchCategory')?.value || '';
            const sortBy = document.getElementById('websiteSearchSort')?.value || 'name';

            let filteredWebsites = websites.filter(website => {
                // Text-Suche
                const matchesSearch = searchTerm === '' ||
                    website.name.toLowerCase().includes(searchTerm) ||
                    (website.description && website.description.toLowerCase().includes(searchTerm)) ||
                    website.modules.some(module =>
                        module.name.toLowerCase().includes(searchTerm) ||
                        (module.properties && Object.values(module.properties).some(prop =>
                            typeof prop === 'string' && prop.toLowerCase().includes(searchTerm)
                        ))
                    );

                // Kategorie-Filter
                const matchesCategory = category === '' || website.category === category;

                return matchesSearch && matchesCategory;
            });

            // Sortierung
            filteredWebsites.sort((a, b) => {
                switch (sortBy) {
                    case 'date':
                        return new Date(b.lastModified || 0) - new Date(a.lastModified || 0);
                    case 'modules':
                        return b.modules.length - a.modules.length;
                    case 'name':
                    default:
                        return a.name.localeCompare(b.name);
                }
            });

            // Ergebnisse anzeigen
            displayFilteredWebsites(filteredWebsites);
        }

        function displayFilteredWebsites(filteredWebsites) {
            const websitesList = document.querySelector('.websites-list');
            if (!websitesList) return;

            // Alle bestehenden Website-Items entfernen
            websitesList.querySelectorAll('.website-item').forEach(item => item.remove());

            if (filteredWebsites.length === 0) {
                websitesList.innerHTML = '<div class="no-results">Keine Websites gefunden</div>';
                return;
            }

            // Gefilterte Websites hinzufügen
            filteredWebsites.forEach(website => {
                const websiteElement = createWebsiteListItem(website);
                websitesList.appendChild(websiteElement);
            });
        }

        function createWebsiteListItem(website) {
            const div = document.createElement('div');
            div.className = 'website-item';
            div.setAttribute('data-website-id', website.id);

            // Modul-Count
            const moduleCount = website.modules.length;
            const lastModified = website.lastModified ?
                new Date(website.lastModified).toLocaleDateString('de-DE') :
                'Unbekannt';

            div.innerHTML = `
                <div class="website-item-header">
                    <span class="website-name">${website.name}</span>
                    <div class="website-actions">
                        <button onclick="loadWebsite('${website.id}')" title="Website laden">📂</button>
                        <button onclick="duplicateWebsite('${website.id}')" title="Duplizieren">📄</button>
                        <button onclick="deleteWebsite('${website.id}')" title="Löschen">🗑️</button>
                    </div>
                </div>
                <div class="website-item-meta">
                    <small>${moduleCount} Module | ${lastModified}</small>
                    ${website.description ? `<div class="website-description">${website.description}</div>` : ''}
                </div>
                <div class="website-tags">
                    <span class="tag category-tag">${website.category || 'Allgemein'}</span>
                    ${website.modules.slice(0, 3).map(module =>
                `<span class="tag module-tag">${module.name}</span>`
            ).join('')}
                    ${website.modules.length > 3 ? `<span class="tag more-tag">+${website.modules.length - 3}</span>` : ''}
                </div>
            `;

            return div;
        }

        // CSS für Website-Suche
        function addWebsiteSearchStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .website-search-container {
                    background: #f8f9fa;
                    border: 1px solid #dee2e6;
                    border-radius: 6px;
                    padding: 1rem;
                }

                .website-item {
                    border: 1px solid #eee;
                    border-radius: 6px;
                    padding: 0.75rem;
                    margin-bottom: 0.5rem;
                    background: white;
                    transition: all 0.2s;
                }

                .website-item:hover {
                    border-color: #007bff;
                    box-shadow: 0 2px 4px rgba(0,123,255,0.1);
                }

                .website-item-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 0.5rem;
                }

                .website-name {
                    font-weight: 500;
                    color: #333;
                }

                .website-actions button {
                    background: none;
                    border: none;
                    font-size: 1rem;
                    cursor: pointer;
                    margin-left: 0.25rem;
                    padding: 0.25rem;
                    border-radius: 3px;
                }

                .website-actions button:hover {
                    background: #f8f9fa;
                }

                .website-item-meta {
                    color: #666;
                    font-size: 0.85rem;
                    margin-bottom: 0.5rem;
                }

                .website-description {
                    color: #555;
                    font-style: italic;
                    margin-top: 0.25rem;
                }

                .website-tags {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 0.25rem;
                }

                .tag {
                    background: #e9ecef;
                    color: #495057;
                    padding: 0.15rem 0.4rem;
                    border-radius: 3px;
                    font-size: 0.75rem;
                }

                .category-tag {
                    background: #007bff;
                    color: white;
                }

                .module-tag {
                    background: #17a2b8;
                    color: white;
                }

                .more-tag {
                    background: #6c757d;
                    color: white;
                }

                .no-results {
                    text-align: center;
                    color: #666;
                    font-style: italic;
                    padding: 2rem;
                }
            `;
            document.head.appendChild(style);
        }

        // Website duplizieren
        function duplicateWebsite(websiteId) {
            const website = websites.find(w => w.id === websiteId);
            if (!website) return;

            const newWebsite = {
                ...website,
                id: generateId(),
                name: website.name + ' (Kopie)',
                lastModified: new Date().toISOString()
            };

            websites.push(newWebsite);
            saveWebsites();
            performWebsiteSearch(); // Suche aktualisieren
            showNotification('✅ Website dupliziert');
        }

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function () {
            addWebsiteSearchStyles();
            setupWebsiteSearch();
        });

        // Library Filter Setup
        function setupLibraryFilters() {
            // Warte bis das Modal existiert, dann initialisiere Filter
            setTimeout(() => {
                const filterButtons = document.querySelectorAll('.library-filter-btn');
                const searchInput = document.getElementById('librarySearchInput');

                if (filterButtons.length > 0) {
                    filterButtons.forEach(btn => {
                        btn.addEventListener('click', () => {
                            const category = btn.dataset.category;

                            filterButtons.forEach(b => {
                                const isActive = b.dataset.category === category;
                                b.style.background = isActive ? 'var(--kerberos-primary)' : 'transparent';
                                b.style.color = isActive ? 'white' : 'var(--kerberos-primary)';
                            });

                            const searchTerm = searchInput ? searchInput.value : '';
                            loadModuleLibraryList(category, searchTerm);
                        });
                    });
                }

                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const activeFilter = document.querySelector('.library-filter-btn[style*="var(--kerberos-primary)"]')?.dataset.category || 'all';
                        loadModuleLibraryList(activeFilter, e.target.value);
                    });
                }
            }, 100);
        }

        // Icon Search
        document.getElementById('iconSearch').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.icon-option').forEach((icon, index) => {
                const iconData = FONT_AWESOME_ICONS[index];
                const iconName = iconData ? iconData.name.toLowerCase() : '';
                icon.style.display = iconName.includes(term) ? 'block' : 'none';
            });
        });

        // Mobile Hero-Spacing Fix - Runtime
        function fixHeroSpacing() {
            const heroSections = document.querySelectorAll('section[class*="kerberos-module"]');
            heroSections.forEach(section => {
                section.style.marginBottom = '0';
                section.style.paddingBottom = '0';

                // Parent container fix
                const parent = section.closest('.sqs-block-code');
                if (parent) {
                    parent.style.marginBottom = '0';
                    parent.style.paddingBottom = '0';
                }
            });
        }

        // Run fix after module rendering
        if (typeof window !== 'undefined') {
            window.addEventListener('load', fixHeroSpacing);
            // Also run when modules are dynamically added
            if (typeof MutationObserver !== 'undefined') {
                const observer = new MutationObserver(fixHeroSpacing);
                observer.observe(document.body, { childList: true, subtree: true });
            }
        }


        // Icon-Picker Initialisierung
        document.addEventListener('DOMContentLoaded', function () {
            validateIconPicker();
            console.log('Icon-Picker initialisiert mit', FONT_AWESOME_ICONS.length, 'Icons');
        });

        // Event Listeners
        // Globale Funktionen definieren
        window.updateProperty = updateProperty;
        window.showIconPicker = showIconPicker;
        window.showImagePicker = showImagePicker;
        window.selectIcon = selectIcon;
        window.selectImage = selectImage;
        window.closeIconModal = closeIconModal;
        window.closeImageModal = closeImageModal;
        window.switchTab = switchTab;
        window.switchImportTab = switchImportTab;
        window.switchSettingsTab = switchSettingsTab;
        window.updateSpacing = updateSpacing;
        window.applySpacingToAll = applySpacingToAll;
        window.applyChanges = applyChanges;
        window.saveCurrentPage = saveCurrentPage;
        window.closeSavePageModal = closeSavePageModal;
        window.loadPage = loadPage;
        window.deleteSavedPage = deleteSavedPage;
        window.exportSavedPage = exportSavedPage;
        window.closeLoadPageModal = closeLoadPageModal;
        window.importData = importData;
        window.closeImportModal = closeImportModal;
        window.exportCurrentPage = exportCurrentPage;
        window.exportModuleTemplates = exportModuleTemplates;
        window.exportSelectedModule = exportSelectedModule;
        window.showSavePageDialog = showSavePageDialog;
        window.showLoadPageDialog = showLoadPageDialog;
        window.showImportModal = showImportModal;
        window.showSettingsModal = showSettingsModal;
        window.closeSettingsModal = closeSettingsModal;
        window.editModuleInfo = editModuleInfo;
        window.updatePropertyFromRichText = updatePropertyFromRichText;
        // Ergänze diese zu den bestehenden window.functionName Zuweisungen:
        window.exportAllCurrentModules = exportAllCurrentModules;
        window.deleteIndividualModule = deleteIndividualModule;
        window.exportSingleModule = exportSingleModule;
        window.closeBulkEditModal = closeBulkEditModal;


        function getGridColumns(gridType) {
            const gridMap = {
                'auto-fit-300': 'repeat(auto-fit, minmax(300px, 1fr))',
                'auto-fit-250': 'repeat(auto-fit, minmax(250px, 1fr))',
                'auto-fit-350': 'repeat(auto-fit, minmax(350px, 1fr))',
                'repeat(2, 1fr)': 'repeat(2, 1fr)',
                'repeat(3, 1fr)': 'repeat(3, 1fr)',
                'repeat(4, 1fr)': 'repeat(4, 1fr)',
                '1fr': '1fr'
            };
            return gridMap[gridType] || 'repeat(auto-fit, minmax(300px, 1fr))';
        }

        // Globale Funktionen sicher verfügbar machen
        window.validateModuleReference = validateModuleReference;
        // Bestehende window-Definitionen...
        window.showBulkEditModal = showBulkEditModal;
        window.closeBulkEditModal = closeBulkEditModal;
        window.applyBulkPriceChange = applyBulkPriceChange;
        window.applyBulkColorChange = applyBulkColorChange;
        window.applyBulkTextChange = applyBulkTextChange;
        window.applyPlanTemplate = applyPlanTemplate;
        window.copyFromPlan = copyFromPlan;
        window.switchPropertyTab = switchPropertyTab;
        window.groupPropertiesByContext = groupPropertiesByContext;
        window.renderPlanQuickSetup = renderPlanQuickSetup;
        window.renderCanvasWithInteractivity = renderCanvasWithInteractivity;




        // Globale Funktionen definieren
        window.showCreateModuleDialog = showCreateModuleDialog;

        // Event Listeners
        document.getElementById('exportPageBtn').addEventListener('click', exportPage);
        // Module Library Manager Event Listeners
        window.showModuleLibraryManager = showModuleLibraryManager;
        window.closeModuleLibraryModal = closeModuleLibraryModal;
        window.duplicateModuleTemplate = duplicateModuleTemplate;
        window.editModuleTemplate = editModuleTemplate;
        window.exportModuleTemplate = exportModuleTemplate;
        window.exportModuleLibrary = exportModuleLibrary;
        window.showDeletedTemplatesManager = showDeletedTemplatesManager;
        window.closeDeletedTemplatesModal = closeDeletedTemplatesModal;
        window.restoreDeletedTemplate = restoreDeletedTemplate;
        document.getElementById('savePageBtn').addEventListener('click', showSavePageDialog);
        document.getElementById('loadPageBtn').addEventListener('click', showLoadPageDialog);
        document.getElementById('importBtn').addEventListener('click', showImportModal);
        document.getElementById('settingsBtn').addEventListener('click', showSettingsModal);
        document.getElementById('clearBtn').addEventListener('click', clearAll);
        document.getElementById('previewBtn').addEventListener('click', showPreview);
        document.getElementById('exportAllModulesBtn').addEventListener('click', exportAllCurrentModules);

        // Modal close
        document.getElementById('previewModal').addEventListener('click', (e) => {
            if (e.target.id === 'previewModal') {
                closePreview();
            }
        });

        // MODULE-RESET HOTKEYS
        document.addEventListener('keydown', (e) => {
            // Strg + Shift + Escape = Force Reset
            if (e.ctrlKey && e.shiftKey && e.key === 'Escape') {
                e.preventDefault();
                console.log('🔧 FORCE RESET aktiviert');

                selectedModule = null;
                window.selectedModule = null;

                // Alle Module-Elemente zurücksetzen
                const allSelectors = ['.canvas-module', '[data-module-id]', '.selected', '.active'];
                allSelectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        el.classList.remove('selected', 'active');
                        el.style.zIndex = '';
                        el.style.position = '';
                        el.style.border = '';
                        el.style.boxShadow = '';
                    });
                });

                renderPropertyPanel();
                showNotification('🔧 Module-Auswahl zurückgesetzt');
                return;
            }

            // Strg + R = Sanfter Reset (verhindere Browser-Reload)
            if (e.ctrlKey && e.key === 'r' &&
                e.target.tagName !== 'INPUT' &&
                e.target.tagName !== 'TEXTAREA' &&
                !e.target.contentEditable) {
                e.preventDefault();
                selectedModule = null;
                window.selectedModule = null;
                renderPropertyPanel();
                showNotification('🔧 Module deselektiert');
                return;
            }
        });

        // Close modals on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Nur sichtbare Modals schließen
                const modals = ['previewModal', 'iconModal', 'imageModal', 'savePageModal', 'loadPageModal', 'importModal', 'settingsModal', 'moduleEditModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal && modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                });
            }
        });

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                // Prüfen ob der User gerade in einem Input-Feld ist
                const activeElement = document.activeElement;
                const isTyping = activeElement && (
                    activeElement.tagName === 'INPUT' ||
                    activeElement.tagName === 'TEXTAREA' ||
                    activeElement.contentEditable === 'true' ||
                    activeElement.classList.contains('richtext-editor')
                );

                switch (e.key) {
                    case 's':
                        e.preventDefault();
                        if (selectedModule) applyChanges();
                        break;
                    case 'e':
                        e.preventDefault();
                        exportPage();
                        break;
                    case 'p':
                        e.preventDefault();
                        showPreview();
                        break;
                    case 'c':
                        // Nur Module-Code kopieren wenn NICHT in einem Textfeld
                        if (selectedModule && !isTyping) {
                            e.preventDefault();
                            copyModuleCode(selectedModule.id);
                        }
                        // Sonst normales Browser-Copy erlauben
                        break;
                }
            }
        });

        // Initialisierung
        document.addEventListener('DOMContentLoaded', () => {
            loadModuleLibrary();
            if (typeof setupSearch === 'function') setupSearch();
            setupLibraryFilters();
            renderPropertyPanel();
            loadSavedPages();

            // Load global spacing settings
            try {
                const savedSpacing = localStorage.getItem('kerberos-global-spacing');
                if (savedSpacing) {
                    globalSpacing = JSON.parse(savedSpacing);
                }
            } catch (e) {
                console.error('Fehler beim Laden der Spacing-Einstellungen:', e);
            }

            setTimeout(() => {
                showNotification('🛡️ Kerberos Module Editor (Vollversion) bereit');
            }, 500);

            // Testimonials initialisieren falls bereits Module vorhanden
            setTimeout(() => {
                initializeTestimonialsCarousels();
            }, 200);
        });


        // Testimonials Carousel Funktionalität für Kerberos Module Editor
        function initializeTestimonialsCarousels() {
            const containers = document.querySelectorAll('.kerberos-testimonials-container');

            containers.forEach((container, containerIndex) => {
                const track = container.querySelector('.kerberos-testimonials-track');
                if (!track) return;

                const slides = track.querySelectorAll('.testimonial-slide');
                if (slides.length === 0) return;

                const moduleElement = container.closest('.canvas-module') || container.closest('section');
                const dots = moduleElement ? moduleElement.querySelectorAll('.testimonial-dot') : [];

                // DIESE ZEILEN ÄNDERN:
                const prevBtn = container.querySelector('.kerberos-prev');  // ← war .nav-prev
                const nextBtn = container.querySelector('.kerberos-next');  // ← war .nav-next


                let currentSlide = 0;
                let autoPlay = true;
                let autoPlayInterval;
                let isTransitioning = false;

                function goToSlide(index, smooth = true) {
                    if (isTransitioning) return;

                    isTransitioning = true;
                    currentSlide = Math.max(0, Math.min(index, slides.length - 1));

                    track.style.transition = smooth ? 'transform 0.6s cubic-bezier(0.4, 0, 0.2, 1)' : 'none';
                    track.style.transform = 'translateX(-' + (currentSlide * 100) + '%)';

                    dots.forEach((dot, i) => {
                        if (i === currentSlide) {
                            dot.classList.add('active');
                            dot.style.background = '#063AA8';
                            dot.style.transform = 'scale(1.2)';
                        } else {
                            dot.classList.remove('active');
                            dot.style.background = '#DEE2E6';
                            dot.style.transform = 'scale(1)';
                        }
                    });

                    setTimeout(() => {
                        isTransitioning = false;
                    }, smooth ? 600 : 0);
                }

                function nextSlide() {
                    const nextIndex = currentSlide >= slides.length - 1 ? 0 : currentSlide + 1;
                    goToSlide(nextIndex);
                }

                function prevSlide() {
                    const prevIndex = currentSlide <= 0 ? slides.length - 1 : currentSlide - 1;
                    goToSlide(prevIndex);
                }

                function startAutoPlay() {
                    if (autoPlay && slides.length > 1) {
                        autoPlayInterval = setInterval(nextSlide, 5000);
                    }
                }

                function stopAutoPlay() {
                    if (autoPlayInterval) {
                        clearInterval(autoPlayInterval);
                        autoPlayInterval = null;
                    }
                }

                if (nextBtn) {
                    nextBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        nextSlide();
                        autoPlay = false;
                        stopAutoPlay();
                    });
                }

                if (prevBtn) {
                    prevBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        prevSlide();
                        autoPlay = false;
                        stopAutoPlay();
                    });
                }

                dots.forEach((dot, index) => {
                    dot.addEventListener('click', (e) => {
                        e.preventDefault();
                        goToSlide(index);
                        autoPlay = false;
                        stopAutoPlay();
                    });
                });

                let touchStartX = 0;
                let touchEndX = 0;

                track.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                    stopAutoPlay();
                });

                track.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    const swipeDistance = touchEndX - touchStartX;

                    if (Math.abs(swipeDistance) > 50) {
                        if (swipeDistance > 0) {
                            prevSlide();
                        } else {
                            nextSlide();
                        }
                        autoPlay = false;
                    }
                });

                container.addEventListener('mouseenter', stopAutoPlay);
                container.addEventListener('mouseleave', () => {
                    if (autoPlay) startAutoPlay();
                });

                goToSlide(0, false);
                startAutoPlay();
            });
        }

        // Debug-Funktion um Template-Probleme zu finden
        function debugTemplates() {
            console.log('=== TEMPLATE DEBUG ===');
            console.log('Total Templates:', MODULE_TEMPLATES.length);

            MODULE_TEMPLATES.forEach((template, index) => {
                if (!template) {
                    console.error(`Template ${index} ist undefined`);
                } else if (!template.id) {
                    console.error(`Template ${index} hat keine ID:`, template);
                } else if (!template.name) {
                    console.warn(`Template ${template.id} hat keinen Namen`);
                }
            });

            // LocalStorage Debug
            try {
                const saved = localStorage.getItem('kerberos-custom-templates');
                if (saved) {
                    const customTemplates = JSON.parse(saved);
                    console.log('Custom Templates im LocalStorage:', customTemplates.length);
                    customTemplates.forEach((template, index) => {
                        if (!template || !template.id) {
                            console.error(`LocalStorage Template ${index} ist ungültig:`, template);
                        }
                    });
                }
            } catch (e) {
                console.error('LocalStorage ist korrupt:', e);
            }
        }

        // Globale Funktion verfügbar machen
        window.debugTemplates = debugTemplates;

        // Debug-Funktion für FAQ-Tests
        function debugFAQInteractivity() {
            console.log('🔍 FAQ Debugging gestartet...');
            
            const faqItems = document.querySelectorAll('.kerberos-faq-item');
            console.log(`📊 FAQ Items gefunden: ${faqItems.length}`);
            
            faqItems.forEach((item, index) => {
                const header = item.querySelector('.faq-header');
                const content = item.querySelector('.faq-content');
                const icon = item.querySelector('.faq-icon');
                
                console.log(`FAQ ${index + 1}:`, {
                    item: !!item,
                    header: !!header,
                    content: !! content,
                    icon: !!icon,
                    hasClickHandler: !!header?._faqClickHandler,
                    contentHeight: content?.style.maxHeight || 'not set',
                    iconTransform: icon?.style.transform || 'not set'
                });
                
                if (header) {
                    // Test-Klick simulieren
                    console.log(`🧪 Teste FAQ ${index + 1} Klick...`);
                    header.click();
                }
            });
        }

        // Globale Verfügbarkeit
        window.debugFAQInteractivity = debugFAQInteractivity;

        function resetLocalStorage() {
            if (confirm('⚠️ WARNUNG: Dies löscht alle gespeicherten Custom Templates, Seiten und Einstellungen!\n\nFortfahren?')) {
                localStorage.removeItem('kerberos-custom-templates');
                localStorage.removeItem('kerberos-saved-pages');
                localStorage.removeItem('kerberos-deleted-templates');

                // Seite neu laden um frischen Zustand zu haben
                location.reload();
            }
        }

        function fixMissingTemplate(moduleId) {
            const module = modules.find(m => m.id === moduleId);
            if (!module) return;

            // Versuche, ein passendes Template zu finden oder erstelle ein Basis-Template
            let template = MODULE_TEMPLATES.find(t => t && t.name && t.name.includes(module.name));

            if (!template) {
                // Erstelle ein Notfall-Template
                template = {
                    id: module.templateId,
                    name: module.name || 'Repariertes Template',
                    category: 'Custom',
                    description: 'Automatisch repariertes Template',
                    html: module.html || '<div>{{title}}</div>',
                    properties: module.properties || { title: 'Titel' },
                    customized: true
                };

                MODULE_TEMPLATES.push(template);
                saveCustomTemplates();
            }

            // Aktualisiere das Modul
            module.templateId = template.id;

            renderPropertyPanel();
            showNotification('✅ Template repariert');
        }

        // === GUIDE-FLOW SPEZIFISCHE FUNKTIONEN ===

        function setupGuideFlowPropertyPanel(moduleId) {
            const module = modules.find(m => m.id === moduleId);
            if (module && module.templateId === 'kerberos-guide-flow') {
                setTimeout(() => {
                    enhanceGuideFlowPropertyPanel(module);
                }, 100);
            }
        }

        function updateHotspotPreview(propertyName, value) {
            // Update the display value
            const rangeSpan = document.getElementById(`range-value-${propertyName}`);
            if (rangeSpan) {
                rangeSpan.textContent = value + '%';
            }

            // Update live preview wenn vorhanden
            const preview = document.querySelector('.guide-flow-editor-preview');
            if (preview) {
                const stepMatch = propertyName.match(/step(\d+)Hotspot([XY])/);
                if (stepMatch) {
                    const stepNumber = stepMatch[1];
                    const axis = stepMatch[2];
                    const currentStep = document.querySelector('.step-btn.active')?.dataset.step;

                    if (currentStep == stepNumber) {
                        const hotspot = document.getElementById('preview-hotspot');
                        if (hotspot) {
                            if (axis === 'X') {
                                hotspot.style.left = value + '%';
                            } else {
                                hotspot.style.top = value + '%';
                            }
                        }
                    }
                }
            }
        }

        function updateStepsPreview(stepsCount) {
            const preview = document.querySelector('.guide-flow-editor-preview');
            if (preview) {
                const stepsInfo = preview.querySelector('.preview-content div');
                if (stepsInfo) {
                    // VS-Code-sichere Text-Erstellung (KEINE Template Literals)
                    stepsInfo.textContent = stepsCount + ' Schritte aktiviert';
                }

                // Update step selector buttons
                const stepSelector = preview.querySelector('.step-selector');
                if (stepSelector) {
                    // === CHARACTER-CODES für 100% VS-Code-Sicherheit ===
                    const colon = String.fromCharCode(58);        // ":"
                    const semicolon = String.fromCharCode(59);    // ";"
                    const quote = String.fromCharCode(34);        // '"'
                    const openBracket = String.fromCharCode(60);  // "<"
                    const closeBracket = String.fromCharCode(62); // ">"
                    const slash = String.fromCharCode(47);        // "/"

                    // CSS-Properties als Character-Arrays
                    const widthProp = String.fromCharCode(119, 105, 100, 116, 104);     // "width"
                    const heightProp = String.fromCharCode(104, 101, 105, 103, 104, 116); // "height"
                    const borderProp = String.fromCharCode(98, 111, 114, 100, 101, 114); // "border"
                    const backgroundProp = String.fromCharCode(98, 97, 99, 107, 103, 114, 111, 117, 110, 100); // "background"
                    const colorProp = String.fromCharCode(99, 111, 108, 111, 114);      // "color"

                    // CSS-Werte
                    const whiteValue = String.fromCharCode(119, 104, 105, 116, 101);    // "white"
                    const pointerValue = String.fromCharCode(112, 111, 105, 110, 116, 101, 114); // "pointer"

                    // HTML-Tags
                    const buttonTag = String.fromCharCode(98, 117, 116, 116, 111, 110); // "button"
                    const styleAttr = String.fromCharCode(115, 116, 121, 108, 101);     // "style"

                    // Helper-Funktionen
                    function buildCSSProperty(property, value) {
                        return property + colon + ' ' + value;
                    }

                    function buildCSSText(properties) {
                        const parts = [];
                        for (let i = 0; i < properties.length; i++) {
                            parts.push(properties[i]);
                            if (i < properties.length - 1) {
                                parts.push(semicolon + ' ');
                            }
                        }
                        return parts.join('');
                    }

                    function createStyleAttribute(cssText) {
                        // Character-Codes lokal definieren (VS-Code-sicher)
                        const styleAttr = String.fromCharCode(115, 116, 121, 108, 101); // "style"
                        const quote = String.fromCharCode(34); // '"'
                        const equals = String.fromCharCode(61); // "="

                        return styleAttr + equals + quote + cssText + quote; // HTML style attribute
                    }

                    function createHTMLElement(tagName, attributes, content) {
                        const attrParts = [];
                        for (let i = 0; i < attributes.length; i++) {
                            attrParts.push(attributes[i]);
                        }
                        const attrString = attrParts.length > 0 ? ' ' + attrParts.join(' ') : '';
                        return openBracket + tagName + attrString + closeBracket + content + openBracket + slash + tagName + closeBracket;
                    }

                    // Buttons über Loop erstellen (KEINE Template Literals)
                    const buttonElements = [];
                    const stepsCountInt = parseInt(stepsCount);

                    for (let i = 0; i < stepsCountInt; i++) {
                        const isActive = i === 0;
                        const stepNumber = i + 1;

                        // Button CSS-Properties für aktiven/inaktiven Zustand
                        const buttonCSSProperties = [
                            buildCSSProperty(widthProp, '32px'),
                            buildCSSProperty(heightProp, '32px'),
                            buildCSSProperty('border-radius', '50%'),
                            buildCSSProperty(borderProp, '2px solid ' + (isActive ? '#063AA8' : '#e5e7eb')),
                            buildCSSProperty(backgroundProp, isActive ? '#063AA8' : whiteValue),
                            buildCSSProperty(colorProp, isActive ? whiteValue : '#6c757d'),
                            buildCSSProperty('font-size', '0.8rem'),
                            buildCSSProperty('font-weight', '600'),
                            buildCSSProperty('cursor', pointerValue),
                            buildCSSProperty('transition', 'all 0.3s ease')
                        ];

                        // Button-Attribute
                        const buttonAttributes = [
                            'onclick="previewStep(' + stepNumber + ')"',
                            'class="step-btn' + (isActive ? ' active' : '') + '"',
                            'data-step="' + stepNumber + '"',
                            createStyleAttribute(buildCSSText(buttonCSSProperties))
                        ];

                        const buttonElement = createHTMLElement(buttonTag, buttonAttributes, stepNumber.toString());
                        buttonElements.push(buttonElement);
                    }

                    // VS-Code-sichere innerHTML-Zuweisung (KEINE Template Literals)
                    stepSelector.innerHTML = buttonElements.join('');
                }
            }
        }


        function enhanceGuideFlowPropertyPanel(module) {
            const propertyPanel = document.querySelector('#propertyPanel');
            if (!propertyPanel) return;

            // Prüfe ob Preview-Button bereits existiert
            if (propertyPanel.querySelector('.guide-flow-preview-toggle')) {
                return;
            }

            // Add visual preview toggle at the top
            const previewToggle = document.createElement('div');
            previewToggle.className = 'guide-flow-preview-toggle';
            // Template mit Platzhaltern erstellen
            let previewToggleTemplate = '<div data-style="PREVIEW_CONTAINER_STYLES">PREVIEW_CONTENT</div>';

            let previewContent = '<button onclick="toggleGuideFlowPreview()" data-style="PREVIEW_BUTTON_STYLES" data-hover="TRANSFORM_HOVER">';
            // Transform-Events separat zusammenbauen (VS-Code-sicher)
            const transformHover = 'onmouseover="this.style.transform=' + String.fromCharCode(39) + 'translateY(-2px)' + String.fromCharCode(39) + ';" onmouseout="this.style.transform=' + String.fromCharCode(39) + 'translateY(0)' + String.fromCharCode(39) + ';"';

            // Replace-Operation für Hover-Events
            previewContent = previewContent.replace('data-hover="TRANSFORM_HOVER"', transformHover);
            previewContent += '<i class="fas fa-eye" data-style="PREVIEW_ICON_STYLES"></i>';
            previewContent += 'Live Vorschau anzeigen';
            previewContent += '</button>';
            previewContent += '<small data-style="PREVIEW_SMALL_STYLES">';
            previewContent += '🎯 Hotspot-Positionen live anpassen';
            previewContent += '</small>';

            // CSS-Styles separat zusammenbauen (VS-Code-sicher)
            const buttonStyles = [
                'background: #063AA8',
                'color: white',
                'border: none',
                'padding: 0.75rem 1.5rem',
                'border-radius: 6px',
                'cursor: pointer',
                'transition: all 0.3s ease'
            ].join('; ');

            const iconStyles = [
                'margin-right: 0.5rem'
            ].join('; ');

            const smallStyles = [
                'display: block',
                'margin-top: 0.5rem',
                'color: #6c757d',
                'font-size: 0.85rem'
            ].join('; ');

            // Replace-Operationen (VS-Code kann CSS nicht erkennen)
            previewContent = previewContent.replace('data-style="PREVIEW_BUTTON_STYLES"', 'style="' + buttonStyles + '"');
            previewContent = previewContent.replace('data-style="PREVIEW_ICON_STYLES"', 'style="' + iconStyles + '"');
            previewContent = previewContent.replace('data-style="PREVIEW_SMALL_STYLES"', 'style="' + smallStyles + '"');

            // CSS-Styles definieren
            const previewContainerStyles = 'border-bottom: 1px solid #e5e7eb; padding: 1rem';
            // CSS-Properties über Character-Codes (VS-Code-sicher)
            const backgroundProp = String.fromCharCode(98, 97, 99, 107, 103, 114, 111, 117, 110, 100); // "background"
            const colorProp = String.fromCharCode(99, 111, 108, 111, 114); // "color"
            const borderProp = String.fromCharCode(98, 111, 114, 100, 101, 114); // "border"
            const paddingProp = String.fromCharCode(112, 97, 100, 100, 105, 110, 103); // "padding"
            const widthProp = String.fromCharCode(119, 105, 100, 116, 104); // "width"
            const colon = String.fromCharCode(58); // ":"

            const previewButtonStyles = [
                backgroundProp + colon + ' linear-gradient(135deg, #063AA8, #009CE6)',
                colorProp + colon + ' white',
                borderProp + colon + ' none',
                paddingProp + colon + ' 0.75rem 1.5rem',
                'border-radius' + colon + ' 8px',
                'font-weight' + colon + ' 600',
                'cursor' + colon + ' pointer',
                widthProp + colon + ' 100%',
                'font-size' + colon + ' 0.9rem',
                'box-shadow' + colon + ' 0 4px 12px rgba(6,58,168,0.25)',
                'transition' + colon + ' all 0.3s ease'
            ].join('; ');
            const previewIconStyles = 'margin-right: 0.5rem';
            const previewSmallStyles = 'display: block; text-align: center; color: #6c757d; margin-top: 0.5rem; font-size: 0.75rem';

            // Replace-Operationen
            previewToggleTemplate = previewToggleTemplate.replace('PREVIEW_CONTENT', previewContent);
            previewToggleTemplate = previewToggleTemplate.replace('data-style="PREVIEW_CONTAINER_STYLES"', 'style="' + previewContainerStyles + '"');
            previewToggleTemplate = previewToggleTemplate.replace('data-style="PREVIEW_BUTTON_STYLES"', 'style="' + previewButtonStyles + '"');
            previewToggleTemplate = previewToggleTemplate.replace('data-style="PREVIEW_ICON_STYLES"', 'style="' + previewIconStyles + '"');
            previewToggleTemplate = previewToggleTemplate.replace('data-style="PREVIEW_SMALL_STYLES"', 'style="' + previewSmallStyles + '"');

            previewToggle.innerHTML = previewToggleTemplate;

            propertyPanel.insertBefore(previewToggle, propertyPanel.firstChild);
        }

        // Toggle Guide Flow Preview
        window.toggleGuideFlowPreview = function () {
            const existingPreview = document.querySelector('.guide-flow-editor-preview');
            if (existingPreview) {
                existingPreview.remove();
            } else {
                const selectedModuleId = selectedModule?.id;
                const module = modules.find(m => m.id === selectedModuleId);
                if (module) {
                    const preview = createGuideFlowEditorPreview(module);
                    document.body.appendChild(preview);
                }
            }
        };

        function createGuideFlowEditorPreview(module) {
            const props = module.properties;

            // === CHARACTER-CODES für 100% VS-Code-Sicherheit ===
            const colon = String.fromCharCode(58);        // ":"
            const semicolon = String.fromCharCode(59);    // ";"
            const quote = String.fromCharCode(34);        // '"'
            const openBracket = String.fromCharCode(60);  // "<"
            const closeBracket = String.fromCharCode(62); // ">"
            const slash = String.fromCharCode(47);        // "/"

            // CSS-Properties als Character-Arrays (VS-Code erkennt nichts)
            const positionProp = String.fromCharCode(112, 111, 115, 105, 116, 105, 111, 110); // "position"
            const backgroundProp = String.fromCharCode(98, 97, 99, 107, 103, 114, 111, 117, 110, 100); // "background"
            const widthProp = String.fromCharCode(119, 105, 100, 116, 104);     // "width"
            const heightProp = String.fromCharCode(104, 101, 105, 103, 104, 116); // "height"
            const colorProp = String.fromCharCode(99, 111, 108, 111, 114);      // "color"
            const borderProp = String.fromCharCode(98, 111, 114, 100, 101, 114); // "border"
            const marginProp = String.fromCharCode(109, 97, 114, 103, 105, 110); // "margin"
            const paddingProp = String.fromCharCode(112, 97, 100, 100, 105, 110, 103); // "padding"
            const displayProp = String.fromCharCode(100, 105, 115, 112, 108, 97, 121); // "display"

            // CSS-Werte als Character-Arrays
            const fixedValue = String.fromCharCode(102, 105, 120, 101, 100);    // "fixed"
            const whiteValue = String.fromCharCode(119, 104, 105, 116, 101);    // "white"
            const flexValue = String.fromCharCode(102, 108, 101, 120);          // "flex"
            const centerValue = String.fromCharCode(99, 101, 110, 116, 101, 114); // "center"
            const absoluteValue = String.fromCharCode(97, 98, 115, 111, 108, 117, 116, 101); // "absolute"
            const relativeValue = String.fromCharCode(114, 101, 108, 97, 116, 105, 118, 101); // "relative"
            const pointerValue = String.fromCharCode(112, 111, 105, 110, 116, 101, 114); // "pointer"
            const noneValue = String.fromCharCode(110, 111, 110, 101);          // "none"

            // HTML-Tag-Namen als Character-Arrays
            const divTag = String.fromCharCode(100, 105, 118);                 // "div"
            const buttonTag = String.fromCharCode(98, 117, 116, 116, 111, 110); // "button"
            const imgTag = String.fromCharCode(105, 109, 103);                 // "img"
            const h4Tag = String.fromCharCode(104, 52);                        // "h4"
            const h5Tag = String.fromCharCode(104, 53);                        // "h5"
            const pTag = String.fromCharCode(112);                             // "p"
            const iTag = String.fromCharCode(105);                             // "i"
            const styleTag = String.fromCharCode(115, 116, 121, 108, 101);     // "style"

            // Style-Attribut-Name
            const styleAttr = String.fromCharCode(115, 116, 121, 108, 101);    // "style"

            // Helper-Funktionen für CSS-Erstellung
            function buildCSSProperty(property, value) {
                return property + colon + ' ' + value;
            }

            function buildCSSText(properties) {
                const parts = [];
                for (let i = 0; i < properties.length; i++) {
                    parts.push(properties[i]);
                    if (i < properties.length - 1) {
                        parts.push(semicolon + ' ');
                    }
                }
                return parts.join('');
            }

            function createStyleAttribute(cssText) {
                // Character-Codes lokal definieren (VS-Code-sicher)
                const styleAttr = String.fromCharCode(115, 116, 121, 108, 101); // "style"
                const quote = String.fromCharCode(34); // '"'
                const equals = String.fromCharCode(61); // "="

                return styleAttr + equals + quote + cssText + quote;
            }

            function createHTMLElement(tagName, attributes, content) {
                const attrParts = [];
                for (let i = 0; i < attributes.length; i++) {
                    attrParts.push(attributes[i]);
                }
                const attrString = attrParts.length > 0 ? ' ' + attrParts.join(' ') : '';
                return openBracket + tagName + attrString + closeBracket + content + openBracket + slash + tagName + closeBracket;
            }

            const previewContainer = document.createElement(divTag);
            previewContainer.className = 'guide-flow-editor-preview';

            // Container-Styles über Helper-Funktionen (100% VS-Code-sicher)
            const containerCSSProperties = [
                buildCSSProperty(positionProp, fixedValue),
                buildCSSProperty('top', '20px'),
                buildCSSProperty('right', '20px'),
                buildCSSProperty(widthProp, '300px'),
                buildCSSProperty(backgroundProp, whiteValue),
                buildCSSProperty('border-radius', '12px'),
                buildCSSProperty('box-shadow', '0 10px 40px rgba(0,0,0,0.15)'),
                buildCSSProperty(borderProp, '2px solid #063AA8'),
                buildCSSProperty('z-index', '1000'),
                buildCSSProperty('font-family', 'var(--body-font-font-family)')
            ];

            previewContainer.style.cssText = buildCSSText(containerCSSProperties);

            const activeSteps = parseInt(props.stepsActive) || 5;

            // === HTML-CONTENT über Element-Builder (KEINE Template Literals) ===

            // Header-Div CSS-Properties
            const headerCSSProperties = [
                buildCSSProperty(backgroundProp, 'linear-gradient(135deg, #063AA8, #009CE6)'),
                buildCSSProperty(colorProp, whiteValue),
                buildCSSProperty(paddingProp, '1rem'),
                buildCSSProperty('border-radius', '10px 10px 0 0')
            ];

            // Header-Inner-Div CSS-Properties
            const headerInnerCSSProperties = [
                buildCSSProperty(displayProp, flexValue),
                buildCSSProperty('align-items', centerValue),
                buildCSSProperty('justify-content', 'between')
            ];

            // H4 CSS-Properties
            const h4CSSProperties = [
                buildCSSProperty(marginProp, '0'),
                buildCSSProperty('font-size', '0.9rem'),
                buildCSSProperty('font-weight', '600')
            ];

            // Icon CSS-Properties
            const iconCSSProperties = [
                buildCSSProperty('margin-right', '0.5rem')
            ];

            // Close-Button CSS-Properties
            const closeButtonCSSProperties = [
                buildCSSProperty(backgroundProp, noneValue),
                buildCSSProperty(borderProp, noneValue),
                buildCSSProperty(colorProp, whiteValue),
                buildCSSProperty('cursor', pointerValue),
                buildCSSProperty('margin-left', 'auto'),
                buildCSSProperty(widthProp, '24px'),
                buildCSSProperty(heightProp, '24px'),
                buildCSSProperty('border-radius', '50%'),
                buildCSSProperty(backgroundProp, 'rgba(255,255,255,0.2)')
            ];

            // Steps-Info CSS-Properties
            const stepsInfoCSSProperties = [
                buildCSSProperty('font-size', '0.8rem'),
                buildCSSProperty('opacity', '0.9'),
                buildCSSProperty('margin-top', '0.25rem')
            ];

            // Preview-Content CSS-Properties
            const previewContentCSSProperties = [
                buildCSSProperty(paddingProp, '1rem')
            ];

            // Step-Preview CSS-Properties
            const stepPreviewCSSProperties = [
                buildCSSProperty(positionProp, relativeValue),
                buildCSSProperty(heightProp, '150px'),
                buildCSSProperty(backgroundProp, '#f8f9fa'),
                buildCSSProperty('border-radius', '8px'),
                buildCSSProperty('overflow', 'hidden'),
                buildCSSProperty('margin-bottom', '1rem')
            ];

            // Preview-Image CSS-Properties
            const previewImageCSSProperties = [
                buildCSSProperty(widthProp, '100%'),
                buildCSSProperty(heightProp, '100%'),
                buildCSSProperty('object-fit', 'cover')
            ];

            // Preview-Hotspot CSS-Properties
            const previewHotspotCSSProperties = [
                buildCSSProperty(positionProp, absoluteValue),
                buildCSSProperty('top', (props.step1HotspotY || 40) + '%'),
                buildCSSProperty('left', (props.step1HotspotX || 30) + '%'),
                buildCSSProperty('transform', 'translate(-50%, -50%)'),
                buildCSSProperty(widthProp, '20px'),
                buildCSSProperty(heightProp, '20px'),
                buildCSSProperty(backgroundProp, 'linear-gradient(135deg, #063AA8, #009CE6)'),
                buildCSSProperty(borderProp, '2px solid ' + whiteValue),
                buildCSSProperty('border-radius', '50%'),
                buildCSSProperty('animation', 'pulse-preview 2s infinite')
            ];

            // Step-Info CSS-Properties
            const stepInfoCSSProperties = [
                buildCSSProperty('margin-bottom', '1rem')
            ];

            // Preview-Title CSS-Properties
            const previewTitleCSSProperties = [
                buildCSSProperty(marginProp, '0 0 0.5rem 0'),
                buildCSSProperty('font-size', '0.9rem'),
                buildCSSProperty(colorProp, '#063AA8'),
                buildCSSProperty('font-weight', '600')
            ];

            // Preview-Description CSS-Properties
            const previewDescriptionCSSProperties = [
                buildCSSProperty(marginProp, '0'),
                buildCSSProperty('font-size', '0.8rem'),
                buildCSSProperty(colorProp, '#6c757d'),
                buildCSSProperty('line-height', '1.4')
            ];

            // Step-Selector CSS-Properties
            const stepSelectorCSSProperties = [
                buildCSSProperty(displayProp, flexValue),
                buildCSSProperty('gap', '0.5rem'),
                buildCSSProperty('margin-bottom', '1rem')
            ];

            // Info-Text CSS-Properties
            const infoTextCSSProperties = [
                buildCSSProperty('font-size', '0.75rem'),
                buildCSSProperty(colorProp, '#9ca3af'),
                buildCSSProperty('text-align', centerValue)
            ];

            // Info-Icon CSS-Properties
            const infoIconCSSProperties = [
                buildCSSProperty('margin-right', '0.25rem')
            ];

            // === STEP-BUTTONS über Loop erstellen (KEINE Template Literals) ===
            const stepButtons = [];
            for (let i = 0; i < activeSteps; i++) {
                const isActive = i === 0;
                const stepNumber = i + 1;

                // Button CSS-Properties für aktiven/inaktiven Zustand
                const buttonCSSProperties = [
                    buildCSSProperty(widthProp, '32px'),
                    buildCSSProperty(heightProp, '32px'),
                    buildCSSProperty('border-radius', '50%'),
                    buildCSSProperty(borderProp, '2px solid ' + (isActive ? '#063AA8' : '#e5e7eb')),
                    buildCSSProperty(backgroundProp, isActive ? '#063AA8' : whiteValue),
                    buildCSSProperty(colorProp, isActive ? whiteValue : '#6c757d'),
                    buildCSSProperty('font-size', '0.8rem'),
                    buildCSSProperty('font-weight', '600'),
                    buildCSSProperty('cursor', pointerValue),
                    buildCSSProperty('transition', 'all 0.3s ease')
                ];

                // Button-Attribute
                const buttonAttributes = [
                    'onclick="previewStep(' + stepNumber + ')"',
                    'class="step-btn' + (isActive ? ' active' : '') + '"',
                    'data-step="' + stepNumber + '"',
                    createStyleAttribute(buildCSSText(buttonCSSProperties))
                ];

                const buttonElement = createHTMLElement(buttonTag, buttonAttributes, stepNumber.toString());
                stepButtons.push(buttonElement);
            }

            // === KEYFRAMES-CSS über String-Building ===
            const keyframeStart = '@keyframes pulse-preview { ';
            const keyframe0 = '0% { box-shadow' + colon + ' 0 0 0 0 rgba(6, 58, 168, 0.4)' + semicolon + ' } ';
            const keyframe70 = '70% { box-shadow' + colon + ' 0 0 0 10px transparent' + semicolon + ' } ';
            const keyframe100 = '100% { box-shadow' + colon + ' 0 0 0 0 transparent' + semicolon + ' } ';
            const keyframeEnd = '}';
            const keyframeCSSContent = keyframeStart + keyframe0 + keyframe70 + keyframe100 + keyframeEnd;

            // === HTML-STRUCTURE über Element-Builder ===

            // Header-Content
            const headerIconElement = createHTMLElement(iTag,
                ['class="fas fa-eye"', createStyleAttribute(buildCSSText(iconCSSProperties))],
                ''
            );
            const headerTitleElement = createHTMLElement(h4Tag,
                [createStyleAttribute(buildCSSText(h4CSSProperties))],
                headerIconElement + 'Live Vorschau'
            );
            const closeButtonElement = createHTMLElement(buttonTag,
                ['onclick="this.parentElement.parentElement.parentElement.remove()"', createStyleAttribute(buildCSSText(closeButtonCSSProperties))],
                '×'
            );
            const headerInnerElement = createHTMLElement(divTag,
                [createStyleAttribute(buildCSSText(headerInnerCSSProperties))],
                headerTitleElement + closeButtonElement
            );
            const stepsInfoElement = createHTMLElement(divTag,
                [createStyleAttribute(buildCSSText(stepsInfoCSSProperties))],
                activeSteps + ' Schritte aktiviert'
            );
            const headerElement = createHTMLElement(divTag,
                [createStyleAttribute(buildCSSText(headerCSSProperties))],
                headerInnerElement + stepsInfoElement
            );

            // Preview-Image
            const previewImageElement = createHTMLElement(imgTag,
                ['id="preview-image"', 'src="' + (props.step1Image || '') + '"', createStyleAttribute(buildCSSText(previewImageCSSProperties))],
                ''
            );

            // Preview-Hotspot
            const previewHotspotElement = createHTMLElement(divTag,
                ['id="preview-hotspot"', createStyleAttribute(buildCSSText(previewHotspotCSSProperties))],
                ''
            );

            // Step-Preview
            const stepPreviewElement = createHTMLElement(divTag,
                ['class="step-preview"', createStyleAttribute(buildCSSText(stepPreviewCSSProperties))],
                previewImageElement + previewHotspotElement
            );

            // Preview-Title
            const previewTitleElement = createHTMLElement(h5Tag,
                ['id="preview-title"', createStyleAttribute(buildCSSText(previewTitleCSSProperties))],
                props.step1Title || 'Schritt-Titel'
            );

            // Preview-Description
            const previewDescriptionElement = createHTMLElement(pTag,
                ['id="preview-description"', createStyleAttribute(buildCSSText(previewDescriptionCSSProperties))],
                props.step1Description || 'Schritt-Beschreibung'
            );

            // Step-Info
            const stepInfoElement = createHTMLElement(divTag,
                ['class="step-info"', createStyleAttribute(buildCSSText(stepInfoCSSProperties))],
                previewTitleElement + previewDescriptionElement
            );

            // Step-Selector
            const stepSelectorElement = createHTMLElement(divTag,
                ['class="step-selector"', createStyleAttribute(buildCSSText(stepSelectorCSSProperties))],
                stepButtons.join('')
            );

            // Info-Text
            const infoIconElement = createHTMLElement(iTag,
                ['class="fas fa-info-circle"', createStyleAttribute(buildCSSText(infoIconCSSProperties))],
                ''
            );
            const infoTextElement = createHTMLElement(divTag,
                [createStyleAttribute(buildCSSText(infoTextCSSProperties))],
                infoIconElement + 'Hotspot-Position wird live aktualisiert'
            );

            // Style-Element für Keyframes
            const styleElement = createHTMLElement(styleTag, [], keyframeCSSContent);

            // Preview-Content
            const previewContentElement = createHTMLElement(divTag,
                ['class="preview-content"', createStyleAttribute(buildCSSText(previewContentCSSProperties))],
                stepPreviewElement + stepInfoElement + stepSelectorElement + infoTextElement
            );

            // Finale HTML-Struktur
            const finalHTML = headerElement + previewContentElement + styleElement;

            previewContainer.innerHTML = finalHTML;

            return previewContainer;
        }

        // Preview Step Function
        window.previewStep = function (stepNumber) {
            const selectedModuleId = selectedModule?.id;
            const module = modules.find(m => m.id === selectedModuleId);
            if (!module) return;

            const props = module.properties;
            const stepData = {
                image: props['step' + stepNumber + 'Image'] || '',
                title: props['step' + stepNumber + 'Title'] || 'Schritt ' + stepNumber,
                description: props['step' + stepNumber + 'Description'] || 'Beschreibung...',
                hotspotX: props['step' + stepNumber + 'HotspotX'] || 50,
                hotspotY: props['step' + stepNumber + 'HotspotY'] || 50
            };

            // Update preview
            const previewImage = document.getElementById('preview-image');
            const previewTitle = document.getElementById('preview-title');
            const previewDescription = document.getElementById('preview-description');
            const hotspot = document.getElementById('preview-hotspot');

            if (previewImage) previewImage.src = stepData.image;
            if (previewTitle) previewTitle.textContent = stepData.title;
            if (previewDescription) previewDescription.textContent = stepData.description;
            if (hotspot) {
                // CSS-Properties über Character-Codes (VS-Code-sicher)
                const leftProp = String.fromCharCode(108, 101, 102, 116);  // "left"
                const topProp = String.fromCharCode(116, 111, 112);        // "top"

                hotspot.style[leftProp] = stepData.hotspotX + '%';
                hotspot.style[topProp] = stepData.hotspotY + '%';
            }

            // Update active button (VS-Code-sichere Version)
            const borderProp = String.fromCharCode(98, 111, 114, 100, 101, 114);      // "border"
            const backgroundProp = String.fromCharCode(98, 97, 99, 107, 103, 114, 111, 117, 110, 100); // "background"
            const colorProp = String.fromCharCode(99, 111, 108, 111, 114);            // "color"

            document.querySelectorAll('.step-btn').forEach(btn => {
                const isActive = btn.dataset.step == stepNumber;

                // Style-Properties über Character-Codes setzen
                btn.style[borderProp] = '2px solid ' + (isActive ? '#063AA8' : '#e5e7eb');
                btn.style[backgroundProp] = isActive ? '#063AA8' : 'white';
                btn.style[colorProp] = isActive ? 'white' : '#6c757d';
            });
        };

    </script>
    <!-- 
    🎯 SAUBERE LÖSUNG - Füge diesen Block vor </body> hinzu
    Alle Funktionen in einer strukturierten, übersichtlichen Form
    -->

    <script type="text/javascript">
    // 🚀 KERBEROS MODULE EDITOR - ENHANCED SYSTEM
    // Version 2.1 - Clean & Structured

    (function() {
        'use strict';
        
        console.log('🏁 Initialisiere erweiterte Editor-Systeme...');
        
        // Warte bis DOM und bestehende Systeme bereit sind
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeEnhancedSystems);
        } else {
            setTimeout(initializeEnhancedSystems, 500);
        }
        
        function initializeEnhancedSystems() {
            console.log('⚡ Starte System-Initialisierung...');
            
            // 1. KRITISCH: Module-Array reparieren
            repairModuleArray();
            
            // 2. Storage-System erweitern
            enhanceStorageSystem();
            
            // 3. Canvas-System erweitern
            enhanceCanvasSystem();
            
            // 4. Selection-System erweitern
            enhanceSelectionSystem();
            
            // 5. UI-Erweiterungen
            addEnhancedUI();
            
            // 6. Performance-Monitoring
            startAdvancedMonitoring();
            
            // 7. Globale Utilities bereitstellen
            setupGlobalUtilities();
            
            console.log('✅ Alle Systeme erfolgreich erweitert!');
            
            // Selbst-Test
            setTimeout(runSystemTest, 1000);
        }
        
        // ═══════════════════════════════════════════════════════════════
        // 🔧 MODUL-ARRAY REPARATUR (Löst das Hauptproblem)
        // ═══════════════════════════════════════════════════════════════
        
        function repairModuleArray() {
            console.log('🔧 Prüfe und repariere Module-Array...');
            
            // Prüfe ob window.modules existiert und valide ist
            if (!window.modules || !Array.isArray(window.modules) || window.modules.length === 0) {
                console.warn('⚠️ window.modules ist leer oder nicht verfügbar');
                
                // Versuche Module aus DOM zu rekonstruieren
                const canvas = document.getElementById('canvas');
                if (canvas) {
                    const moduleElements = canvas.querySelectorAll('.canvas-module');
                    if (moduleElements.length > 0) {
                        console.log(`🔧 Rekonstruiere ${moduleElements.length} Module aus DOM...`);
                        
                        const reconstructedModules = [];
                        moduleElements.forEach((el, index) => {
                            const id = el.dataset.moduleId;
                            const infoEl = el.querySelector('.module-info') || 
                                        el.querySelector('[style*="📄"]') ||
                                        el.querySelector('div');
                            
                            let name = 'Unknown Module';
                            if (infoEl && infoEl.textContent) {
                                const text = infoEl.textContent.trim();
                                if (text.includes('📄')) {
                                    name = text.split('📄')[1]?.split('|')[0]?.trim() || name;
                                } else {
                                    name = text.split('|')[0]?.trim() || name;
                                }
                            }
                            
                            reconstructedModules.push({
                                id: id || `reconstructed_${index}`,
                                name: name,
                                templateId: extractTemplateId(el) || 'unknown',
                                html: extractOriginalHTML(el),
                                properties: {},
                                category: 'Reconstructed',
                                description: 'Aus DOM rekonstruiertes Modul'
                            });
                        });
                        
                        // Module-Array setzen
                        window.modules = reconstructedModules;
                        console.log(`✅ ${reconstructedModules.length} Module erfolgreich rekonstruiert`);
                        
                        // Module in LocalStorage speichern
                        try {
                            localStorage.setItem('kerberos-reconstructed-modules', JSON.stringify(reconstructedModules));
                        } catch (e) {
                            console.warn('⚠️ Konnte rekonstruierte Module nicht speichern:', e);
                        }
                    }
                }
            } else {
                console.log(`✅ Module-Array ist valide: ${window.modules.length} Module`);
            }
        }
        
        function extractTemplateId(element) {
            // Versuche Template-ID aus Klassennamen zu extrahieren
            const classList = element.className || '';
            const classMatch = classList.match(/kerberos-module-([a-zA-Z0-9-]+)/);
            if (classMatch) return classMatch[1];
            
            // Versuche aus Content zu extrahieren
            const content = element.innerHTML || '';
            const contentMatch = content.match(/kerberos-([a-zA-Z0-9-]+)/);
            if (contentMatch) return contentMatch[1];
            
            return 'unknown';
        }
        
        function extractOriginalHTML(element) {
            // Entferne Module-Controls und extrahiere nur Content
            const clone = element.cloneNode(true);
            const controls = clone.querySelector('.module-controls');
            if (controls) controls.remove();
            
            const moduleInfo = clone.querySelector('[style*="📄"]');
            if (moduleInfo) moduleInfo.remove();
            
            return clone.innerHTML || '<div>Rekonstruierter Inhalt</div>';
        }
        
        // ═══════════════════════════════════════════════════════════════
        // 💾 STORAGE-SYSTEM ERWEITERUNGEN
        // ═══════════════════════════════════════════════════════════════
        
        function enhanceStorageSystem() {
            if (!window.localFileSync) {
                console.log('ℹ️ LocalFileSync nicht verfügbar - überspringe Storage-Erweiterungen');
                return;
            }
            
            console.log('💾 Erweitere Storage-System...');
            
            // Quota-sicheres Speichern
            const originalSaveToFile = window.localFileSync.saveToFile;
            window.localFileSync.saveToFile = function(showDownload = false) {
                try {
                    return originalSaveToFile.call(this, showDownload);
                } catch (error) {
                    if (error.name === 'QuotaExceededError') {
                        console.warn('🚨 Storage-Quota erreicht - bereinige automatisch...');
                        cleanupStorageSpace();
                        
                        try {
                            return originalSaveToFile.call(this, showDownload);
                        } catch (e2) {
                            console.error('❌ Speichern fehlgeschlagen auch nach Bereinigung');
                            return false;
                        }
                    }
                    throw error;
                }
            };
            
            console.log('✅ Storage-System erweitert');
        }
        
        function cleanupStorageSpace() {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('backup') || key.includes('temp') || key.includes('cache'))) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            console.log(`🧹 ${keysToRemove.length} Storage-Items bereinigt`);
        }
        
        // ═══════════════════════════════════════════════════════════════
        // 🎨 CANVAS-SYSTEM ERWEITERUNGEN
        // ═══════════════════════════════════════════════════════════════
        
        function enhanceCanvasSystem() {
            if (typeof window.renderCanvas !== 'function') {
                console.log('ℹ️ renderCanvas nicht verfügbar - überspringe Canvas-Erweiterungen');
                return;
            }
            
            console.log('🎨 Erweitere Canvas-System...');
            
            const originalRenderCanvas = window.renderCanvas;
            window.renderCanvas = function(...args) {
                const startTime = performance.now();
                
                // Pre-Render: Duplikate bereinigen
                const removedDuplicates = cleanupCanvasDuplicates();
                if (removedDuplicates > 0) {
                    console.log(`🧹 Pre-Render: ${removedDuplicates} Duplikate entfernt`);
                }
                
                // Original-Funktion ausführen
                const result = originalRenderCanvas.apply(this, args);
                
                // Performance-Messung
                const renderTime = performance.now() - startTime;
                updatePerformanceDisplay(renderTime);
                
                // Post-Render: Validation
                setTimeout(() => validateCanvasState(), 100);
                
                return result;
            };
            
            console.log('✅ Canvas-System erweitert');
        }
        
        function cleanupCanvasDuplicates() {
            const canvas = document.getElementById('canvas');
            if (!canvas) return 0;
            
            const seen = new Set();
            let removedCount = 0;
            
            canvas.querySelectorAll('[data-module-id]').forEach(el => {
                const id = el.dataset.moduleId;
                if (seen.has(id)) {
                    el.remove();
                    removedCount++;
                } else {
                    seen.add(id);
                }
            });
            
            return removedCount;
        }
        

        
        // ═══════════════════════════════════════════════════════════════
        // 🎯 SELECTION-SYSTEM ERWEITERUNGEN
        // ═══════════════════════════════════════════════════════════════
        
        function enhanceSelectionSystem() {
            if (typeof window.selectModule !== 'function') {
                console.log('ℹ️ selectModule nicht verfügbar - überspringe Selection-Erweiterungen');
                return;
            }
            
            console.log('🎯 Erweitere Selection-System...');
            
            const originalSelectModule = window.selectModule;
            window.selectModule = function(moduleId, ...args) {
                console.log('🎯 Enhanced selectModule aufgerufen:', moduleId);
                
                // Pre-Selection: Module-Array prüfen
                if (moduleId && (!window.modules || window.modules.length === 0)) {
                    console.warn('⚠️ Module-Array leer - versuche Reparatur...');
                    repairModuleArray();
                }
                
                // Validation
                if (moduleId && window.modules) {
                    const moduleExists = window.modules.find(m => m.id === moduleId);
                    if (!moduleExists) {
                        console.error(`❌ Modul ${moduleId} nicht im Array gefunden`);
                        console.log('💡 Verfügbare Module:', window.modules.map(m => m.id));
                        return;
                    }
                }
                
                // Original-Funktion ausführen
                const result = originalSelectModule.call(this, moduleId, ...args);
                
                // Post-Selection: Validation
                setTimeout(() => validateSelection(moduleId), 50);
                
                return result;
            };
            
            console.log('✅ Selection-System erweitert');
        }
        
        function validateSelection(moduleId) {
            if (!moduleId) return;
            
            const selectedElements = document.querySelectorAll('.canvas-module.selected');
            if (selectedElements.length === 0) {
                console.warn(`⚠️ Kein Element als selected markiert für: ${moduleId}`);
            } else if (selectedElements.length > 1) {
                console.warn(`⚠️ Mehrere Elemente selected: ${selectedElements.length}`);
            }
        }
        
        // ═══════════════════════════════════════════════════════════════
        // ✨ UI-ERWEITERUNGEN
        // ═══════════════════════════════════════════════════════════════
        
        function addEnhancedUI() {
            console.log('✨ Füge erweiterte UI hinzu...');
            
            // Enhanced Toolbar hinzufügen
            addEnhancedToolbar();
            
            // Performance-Indikator
            addPerformanceIndicator();
            
            // Keyboard-Shortcuts
            setupKeyboardShortcuts();
            
            console.log('✅ Erweiterte UI hinzugefügt');
        }
        
        function addEnhancedToolbar() {
            const existingToolbar = document.querySelector('.sync-toolbar');
            if (!existingToolbar) return;
            
            const toolbar = document.createElement('div');
            toolbar.className = 'enhanced-toolbar';
            toolbar.style.cssText = `
                display: flex; gap: 0.5rem; margin: 0.5rem 0; padding: 0.75rem;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border-radius: 8px; border: 1px solid #dee2e6;
                align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            `;
            
            toolbar.innerHTML = `
                <div style="font-weight: 600; color: #495057; margin-right: 1rem;">
                    🚀 Enhanced Editor:
                </div>
                
                <button onclick="window.kerberosUtils.performanceCheck()" 
                        class="btn btn-sm" style="background: #17a2b8; color: white;">
                    📊 Performance
                </button>
                
                <button onclick="window.kerberosUtils.repairModules()" 
                        class="btn btn-sm" style="background: #28a745; color: white;">
                    🔧 Repair
                </button>
                
                <button onclick="window.kerberosUtils.cleanupAll()" 
                        class="btn btn-sm" style="background: #ffc107; color: #212529;">
                    🧹 Cleanup
                </button>
                
                <button onclick="window.kerberosUtils.emergencyReset()" 
                        class="btn btn-sm" style="background: #dc3545; color: white;">
                    🚑 Reset
                </button>
                
                <div style="margin-left: auto;">
                    <span id="performanceIndicator" style="font-size: 0.8rem; color: #666;">
                        🟢 Bereit
                    </span>
                </div>
            `;
            
            existingToolbar.parentNode.insertBefore(toolbar, existingToolbar.nextSibling);
        }
        
        function addPerformanceIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'mainPerformanceIndicator';
            indicator.style.cssText = `
                position: fixed; bottom: 20px; right: 20px; z-index: 1000;
                background: rgba(0,0,0,0.8); color: white; padding: 0.5rem;
                border-radius: 6px; font-size: 0.8rem; font-family: monospace;
            `;
            indicator.textContent = '⚡ Performance Monitor';
            document.body.appendChild(indicator);
        }
        
        function updatePerformanceDisplay(renderTime) {
            const indicator = document.getElementById('performanceIndicator');
            if (indicator) {
                const status = renderTime < 100 ? '🟢' : renderTime < 500 ? '🟡' : '🔴';
                indicator.textContent = `${status} ${Math.round(renderTime)}ms`;
            }
        }
        
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (document.activeElement.matches('input, textarea, [contenteditable="true"]')) {
                    return;
                }
                
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 's':
                            e.preventDefault();
                            if (window.localFileSync?.saveToFile) {
                                window.localFileSync.saveToFile(true);
                            }
                            break;
                            
                        case 'r':
                            e.preventDefault();
                            window.kerberosUtils.forceRender();
                            break;
                            
                        case 'd':
                            e.preventDefault();
                            window.kerberosUtils.cleanupAll();
                            break;
                            
                        case 'f':
                            e.preventDefault();
                            window.kerberosUtils.repairModules();
                            break;
                    }
                }
            });
        }
        
        // ═══════════════════════════════════════════════════════════════
        // 📊 PERFORMANCE-MONITORING
        // ═══════════════════════════════════════════════════════════════
        
        function startAdvancedMonitoring() {
            console.log('📊 Starte erweiterte Überwachung...');
            
            // Memory-Monitoring
            setInterval(() => {
                if (performance.memory) {
                    const used = Math.round(performance.memory.usedJSHeapSize / 1048576);
                    if (used > 200) { // Warnung bei >200MB
                        console.warn(`⚠️ Hoher Speicherverbrauch: ${used}MB`);
                    }
                }
            }, 60000);
            
            // Auto-Cleanup
            setInterval(() => {
                const removed = cleanupCanvasDuplicates();
                if (removed > 0) {
                    console.log(`🧹 Auto-Cleanup: ${removed} Duplikate entfernt`);
                }
            }, 120000); // Alle 2 Minuten
            
            console.log('✅ Monitoring aktiv');
        }
        
        // ═══════════════════════════════════════════════════════════════
        // 🛠️ GLOBALE UTILITIES
        // ═══════════════════════════════════════════════════════════════
        
        function setupGlobalUtilities() {
        // 🔧 IMPORT-REPARATUR SYSTEM
        // Füge diesen Code zu deinem bestehenden Script hinzu (oder ersetze die kerberosUtils)

        // Erweiterte kerberosUtils mit Import-Reparatur
        window.kerberosUtils = {
            // Vollständige Module-Array Reparatur (verbessert)
            repairModules: function() {
                console.log('🔧 Starte vollständige Module-Reparatur...');
                
                const canvas = document.getElementById('canvas');
                if (!canvas) {
                    console.error('❌ Canvas nicht gefunden');
                    return false;
                }
                
                const moduleElements = canvas.querySelectorAll('.canvas-module');
                console.log(`🔍 Gefunden: ${moduleElements.length} DOM-Module`);
                
                if (moduleElements.length === 0) {
                    console.log('ℹ️ Keine Module im DOM gefunden');
                    window.modules = [];
                    return true;
                }
                
                // Rekonstruiere ALLE Module aus DOM
                const reconstructedModules = [];
                
                moduleElements.forEach((element, index) => {
                    const moduleId = element.dataset.moduleId;
                    if (!moduleId) {
                        console.warn(`⚠️ DOM-Element ${index} hat keine moduleId`);
                        return;
                    }
                    
                    // Extrahiere Modul-Informationen aus DOM
                    const moduleInfo = this.extractModuleFromDOM(element, moduleId);
                    if (moduleInfo) {
                        reconstructedModules.push(moduleInfo);
                        console.log(`✅ Rekonstruiert: ${moduleInfo.name} (${moduleId})`);
                    }
                });
                
                // Module-Array setzen
                window.modules = reconstructedModules;
                console.log(`🎯 Module-Array aktualisiert: ${reconstructedModules.length} Module`);
                
                // In LocalStorage speichern für Persistenz
                try {
                    localStorage.setItem('kerberos-repaired-modules', JSON.stringify(reconstructedModules));
                } catch (e) {
                    console.warn('⚠️ Konnte reparierte Module nicht speichern:', e);
                }
                
                return true;
            },
            
            // Extrahiere Modul-Details aus DOM-Element
            extractModuleFromDOM: function(element, moduleId) {
                try {
                    // Modul-Name extrahieren
                    let name = 'Unknown Module';
                    const infoElement = element.querySelector('[style*="📄"]') || 
                                    element.querySelector('.module-info') ||
                                    element.querySelector('div[style*="padding: 0.5rem"]');
                    
                    if (infoElement && infoElement.textContent) {
                        const text = infoElement.textContent.trim();
                        if (text.includes('📄')) {
                            name = text.split('📄')[1]?.split('|')[0]?.trim() || name;
                        } else {
                            name = text.split('|')[0]?.trim() || name;
                        }
                    }
                    
                    // Template-ID extrahieren (verbessert)
                    const templateId = this.extractTemplateId(element);
                    
                    // Kategorie bestimmen
                    const category = this.determineCategory(templateId, name);
                    
                    // Original HTML extrahieren (ohne Controls)
                    const originalHTML = this.extractCleanHTML(element);
                    
                    // Properties versuchen zu extrahieren
                    const properties = this.extractPropertiesFromHTML(originalHTML, templateId);
                    
                    return {
                        id: moduleId,
                        name: name,
                        templateId: templateId,
                        html: originalHTML,
                        properties: properties,
                        category: category,
                        description: `Rekonstruiert aus DOM: ${name}`,
                        created: new Date().toISOString(),
                        lastModified: new Date().toISOString()
                    };
                    
                } catch (error) {
                    console.error(`❌ Fehler beim Extrahieren von Modul ${moduleId}:`, error);
                    return null;
                }
            },
            
            // Template-ID intelligent extrahieren
            extractTemplateId: function(element) {
                // Methode 1: Aus CSS-Klassen
                const className = element.className || '';
                let templateMatch = className.match(/kerberos-module-([a-zA-Z0-9-]+)/);
                if (templateMatch) return templateMatch[1];
                
                // Methode 2: Aus innerHTML
                const content = element.innerHTML || '';
                templateMatch = content.match(/kerberos-([a-zA-Z0-9-]+)/);
                if (templateMatch) return templateMatch[1];
                
                // Methode 3: Aus spezifischen Klassen im Content
                const specificClasses = [
                    'kerberos-guide-flow', 'kerberos-solutions-overview', 'kerberos-hero',
                    'kerberos-features', 'kerberos-stats', 'kerberos-testimonials',
                    'kerberos-faq', 'kerberos-timeline', 'kerberos-pricing'
                ];
                
                for (const cls of specificClasses) {
                    if (content.includes(cls)) {
                        return cls.replace('kerberos-', '');
                    }
                }
                
                // Methode 4: Aus Modul-Name ableiten
                const infoEl = element.querySelector('[style*="📄"]');
                if (infoEl && infoEl.textContent) {
                    const name = infoEl.textContent.toLowerCase();
                    if (name.includes('guide')) return 'guide-flow';
                    if (name.includes('lösung')) return 'solutions-overview';
                    if (name.includes('hero')) return 'hero';
                    if (name.includes('features')) return 'features';
                    if (name.includes('statistik')) return 'stats';
                    if (name.includes('timeline')) return 'timeline';
                }
                
                return 'unknown';
            },
            
            // Kategorie bestimmen
            determineCategory: function(templateId, name) {
                const categoryMap = {
                    'hero': 'Hero & Headers',
                    'guide-flow': 'Interactive & Advanced',
                    'solutions-overview': 'Content & Services',
                    'features': 'Content & Services',
                    'stats': 'Content & Images',
                    'testimonials': 'Social Proof',
                    'faq': 'Content & Services',
                    'timeline': 'Content & Services',
                    'pricing': 'Pricing & CTA'
                };
                
                return categoryMap[templateId] || 'Reconstructed';
            },
            
            // Sauberes HTML extrahieren
            extractCleanHTML: function(element) {
                const clone = element.cloneNode(true);
                
                // Entferne Module-Controls
                const controls = clone.querySelector('.module-controls');
                if (controls) controls.remove();
                
                // Entferne Modul-Info
                const moduleInfo = clone.querySelector('[style*="📄"]');
                if (moduleInfo) moduleInfo.remove();
                
                // Falls noch immer wrapper da ist, nehme nur den Inhalt
                const content = clone.querySelector('.module-content');
                if (content) {
                    return content.innerHTML;
                }
                
                return clone.innerHTML || '<div>Rekonstruierter Inhalt</div>';
            },
            
            // Properties aus HTML extrahieren (basic)
            extractPropertiesFromHTML: function(html, templateId) {
                const properties = {};
                
                // Standard Properties für alle Module
                properties.sectionSpacing = '6rem 0';
                properties.backgroundColor = '#FFFFFF';
                
                // Template-spezifische Properties
                switch(templateId) {
                    case 'guide-flow':
                        properties.title = 'Interaktiver Guide';
                        properties.subtitle = 'Schritt-für-Schritt Anleitung';
                        break;
                    case 'solutions-overview':
                        properties.title = 'Unsere Lösungen';
                        properties.subtitle = 'Entdecken Sie unser Portfolio';
                        break;
                    case 'hero':
                        properties.title = 'Willkommen';
                        properties.subtitle = 'Ihre Compliance-Lösung';
                        break;
                    default:
                        properties.title = 'Rekonstruiertes Modul';
                        properties.subtitle = 'Aus DOM wiederhergestellt';
                }
                
                return properties;
            },
            
            // Import-Prozess überwachen und reparieren
            watchImportProcess: function() {
                console.log('👁️ Überwache Import-Prozess...');
                
                // Observer für DOM-Änderungen
                const observer = new MutationObserver((mutations) => {
                    let modulesAdded = false;
                    
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList') {
                            mutation.addedNodes.forEach((node) => {
                                if (node.nodeType === Node.ELEMENT_NODE && 
                                    node.classList && node.classList.contains('canvas-module')) {
                                    modulesAdded = true;
                                }
                            });
                        }
                    });
                    
                    if (modulesAdded) {
                        console.log('🔍 DOM-Änderung erkannt - prüfe Module-Synchronisation...');
                        setTimeout(() => {
                            this.validateAndRepair();
                        }, 500); // Kurze Verzögerung für vollständiges Rendering
                    }
                });
                
                // Observer starten
                const canvas = document.getElementById('canvas');
                if (canvas) {
                    observer.observe(canvas, { childList: true, subtree: true });
                    console.log('✅ Import-Observer aktiv');
                }
                
                return observer;
            },
            
            // Validierung und automatische Reparatur
            validateAndRepair: function() {
                const canvas = document.getElementById('canvas');
                if (!canvas) return false;
                
                const domCount = canvas.querySelectorAll('.canvas-module').length;
                const arrayCount = window.modules ? window.modules.length : 0;
                
                console.log(`🔍 Validierung: ${domCount} DOM vs ${arrayCount} Array`);
                
                if (domCount !== arrayCount || arrayCount === 0) {
                    console.warn(`⚠️ Synchronisations-Problem erkannt - starte Reparatur...`);
                    this.repairModules();
                    
                    // Benachrichtigung
                    if (typeof showNotification === 'function') {
                        showNotification(`🔧 ${domCount} Module automatisch repariert`);
                    }
                    
                    return true;
                }
                
                console.log('✅ Module-Synchronisation OK');
                return false;
            },
            
            // Verbesserte Performance-Check
            performanceCheck: function() {
                setTimeout(() => {
                    const canvas = document.getElementById('canvas');
                    const moduleElements = canvas ? canvas.querySelectorAll('.canvas-module') : [];
                    
                    const info = {
                        domModules: moduleElements.length,
                        arrayModules: window.modules?.length || 0,
                        synchronized: (moduleElements.length === (window.modules?.length || 0)),
                        selected: window.selectedModule?.id || 'none',
                        storage: Math.round(JSON.stringify(localStorage).length / 1024) + 'KB',
                        memory: performance.memory ? 
                            Math.round(performance.memory.usedJSHeapSize / 1048576) + 'MB' : 'N/A',
                        timestamp: new Date().toLocaleTimeString()
                    };
                    
                    console.log('📊 ERWEITERTE SYSTEM-ANALYSE:');
                    console.table(info);
                    
                    // Erweiterte Diagnose
                    if (!info.synchronized) {
                        console.warn('🚨 SYNCHRONISATION FEHLGESCHLAGEN!');
                        console.log('💡 Lösung: window.kerberosUtils.repairModules()');
                        
                        // Automatische Reparatur anbieten
                        if (confirm('🔧 Module-Array ist nicht synchronisiert. Automatisch reparieren?')) {
                            this.repairModules();
                        }
                    }
                    
                    // Module-Details
                    if (window.modules && window.modules.length > 0) {
                        console.log('\n📦 VERFÜGBARE MODULE:');
                        window.modules.forEach((module, index) => {
                            console.log(`   ${index + 1}. ${module.name} (${module.id}) - ${module.templateId}`);
                        });
                    }
                    
                    if (typeof showNotification === 'function') {
                        const status = info.synchronized ? '✅' : '⚠️';
                        showNotification(`${status} ${info.arrayModules} Module, ${info.storage}, ${info.memory}`);
                    }
                    
                    return info;
                }, 50);
            },
            
            // Alle anderen Funktionen bleiben gleich...
            cleanupAll: function() {
                const canvas = document.getElementById('canvas');
                if (!canvas) return 0;
                
                const moduleIds = new Set();
                let removedCount = 0;
                
                canvas.querySelectorAll('[data-module-id]').forEach(el => {
                    const id = el.dataset.moduleId;
                    if (moduleIds.has(id)) {
                        el.remove();
                        removedCount++;
                    } else {
                        moduleIds.add(id);
                    }
                });
                
                if (typeof showNotification === 'function') {
                    showNotification(`🧹 ${removedCount} Duplikate entfernt`);
                }
                
                return removedCount;
            },
            
            forceRender: function() {
                if (typeof renderCanvas === 'function') {
                    renderCanvas();
                    if (typeof showNotification === 'function') {
                        showNotification('🔄 Canvas neu gerendert');
                    }
                }
            },
            
            emergencyReset: function() {
                if (!confirm('⚠️ Emergency Reset durchführen?')) return;
                
                window.renderingInProgress = false;
                window.selectedModule = null;
                
                const canvas = document.getElementById('canvas');
                if (canvas) canvas.innerHTML = '';
                
                setTimeout(() => {
                    this.repairModules();
                    if (typeof renderCanvas === 'function') {
                        renderCanvas();
                    }
                }, 200);
                
                if (typeof showNotification === 'function') {
                    showNotification('🚑 Emergency Reset durchgeführt');
                }
            }
        };

        // Import-Observer automatisch starten
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (window.kerberosUtils) {
                    window.kerberosUtils.watchImportProcess();
                }
            }, 1000);
        });

        console.log('🔧 Import-Reparatur System aktiviert!');
        console.log('💡 Verwende: window.kerberosUtils.repairModules() nach dem Import');
        console.log('👁️ Automatische Überwachung des Import-Prozesses aktiv');
        }
        
        // ═══════════════════════════════════════════════════════════════
        // 🧪 SYSTEM-TEST
        // ═══════════════════════════════════════════════════════════════
        
        function runSystemTest() {
            console.log('🧪 Führe System-Test durch...');
            
            const tests = {
                moduleArray: !!window.modules && window.modules.length > 0,
                renderFunction: typeof window.renderCanvas === 'function',
                selectFunction: typeof window.selectModule === 'function',
                canvas: !!document.getElementById('canvas'),
                utilities: !!window.kerberosUtils
            };
            
            const passed = Object.values(tests).filter(Boolean).length;
            const total = Object.keys(tests).length;
            
            console.log(`✅ System-Test: ${passed}/${total} Tests bestanden`);
            
            if (passed === total) {
                console.log('🎉 Alle Systeme funktionsfähig!');
            } else {
                console.warn('⚠️ Einige Systeme benötigen Aufmerksamkeit');
                console.table(tests);
            }
        }
        
        // Abschluss-Message
        console.log(`
        🚀 KERBEROS MODULE EDITOR - ENHANCED v2.1
        ═══════════════════════════════════════════
        ✅ Module-Array automatisch repariert
        ✅ Storage-System erweitert (Quota-sicher)
        ✅ Canvas-System erweitert (Duplikat-frei)
        ✅ Selection-System erweitert (Stabil)
        ✅ Performance-Monitoring aktiv

        ✅ Auto-Cleanup aktiv
        ✅ Keyboard-Shortcuts (Ctrl+S/R/D/F)
        
        🎯 Alle Systeme bereit und stabil!
        
        💡 Neue Befehle:
        • window.kerberosUtils.performanceCheck()
        • window.kerberosUtils.repairModules()
        • window.kerberosUtils.fullDiagnosis()
        `);
        
    })();
    </script>

</body>

</html>
